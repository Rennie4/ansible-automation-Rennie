{% raw %}
# PowerShell Audit Script - No Python Required
$mapPath = "C:\temp\security_options_map.json"
$secFile = "C:\temp\secedit_export.inf"
$reportPath = "C:\temp\security_audit_results.csv"

if (-not (Test-Path $mapPath)) { throw "Mapping file missing." }
$map = Get-Content $mapPath | ConvertFrom-Json
$idList = $map.psobject.Properties.Name

# Export live security policy
secedit /export /areas SECURITYPOLICY /cfg $secFile | Out-Null
$policyStore = @{}

Get-Content $secFile -Encoding Unicode | ForEach-Object {
    $line = $_.Trim()
    if ($line -match '^([^=]+)=(.*)$') {
        $key = $matches[1].Trim()
        $val = $matches[2].Trim().Trim('"')
        if ($val -match '^\d+,(.*)$') { $val = $matches[1].Trim() }
        $policyStore[$key] = $val
    }
}

$results = foreach ($id in $idList) {
    $displayName = $map.$id
    $currentVal = "Not Defined"

    if ($policyStore.ContainsKey($id)) {
        $currentVal = $policyStore[$id]
    } 
    elseif ($id -like "MACHINE\*") {
        $regPath = $id.Replace("MACHINE\", "HKLM:\")
        $parent = Split-Path $regPath
        $leaf = Split-Path $regPath -Leaf
        if (Test-Path $parent) {
            $regVal = (Get-ItemProperty -Path $parent -Name $leaf -ErrorAction SilentlyContinue).$leaf
            if ($null -ne $regVal) { $currentVal = $regVal }
        }
    }

    $status = switch ($currentVal) {
        "0" { "Disabled" }
        "1" { "Enabled" }
        "4" { "Enabled" }
        "536870912" { "Require 128-bit encryption" }
        "Not Defined" { "Not Defined" }
        default { $currentVal }
    }

    [PSCustomObject]@{
        "Security Policy Name" = $displayName
        "Configured Setting"   = $status
    }
}

# Calculate Totals for Header
$totalTargeted = $idList.Count
$successfullyPulled = ($results | Where-Object { $_."Configured Setting" -ne "Not Defined" }).Count

# Build the formatted report as requested
$reportHeader = @"
Windows Server 2025: Security Options Audit
Total Targeted,$totalTargeted
Successfully Pulled,$successfullyPulled
"@

$reportHeader | Out-File -FilePath $reportPath -Encoding utf8
$results | Sort-Object "Security Policy Name" | Export-Csv -Path $reportPath -Append -NoTypeInformation

if (Test-Path $secFile) { Remove-Item $secFile -Force }
{% endraw %}
