{% raw %}
# PowerShell Audit Script - No Python Required
# Targeted at Windows 2025 Security Options

$mapPath = "C:\temp\security_options_map.json"
$secFile = "C:\temp\secedit_export.inf"
$reportPath = "C:\temp\security_audit_results.csv"

if (-not (Test-Path $mapPath)) { throw "Mapping file missing." }
$map = Get-Content $mapPath | ConvertFrom-Json

# Export live security policy to a temporary INF file
secedit /export /areas SECURITYPOLICY /cfg $secFile | Out-Null

$policyStore = @{}

# Parse INF using UTF-16 Encoding (Default for secedit)
Get-Content $secFile -Encoding Unicode | ForEach-Object {
    $line = $_.Trim()
    if ($line -match '^([^=]+)=(.*)$') {
        $key = $matches[1].Trim()
        $val = $matches[2].Trim().Trim('"')
        
        # Clean up registry format (e.g., '4,1' becomes '1')
        if ($val -match '^\d+,(.*)$') { $val = $matches[1].Trim() }
        $policyStore[$key] = $val
    }
}

# Match against the 104 settings from your JSON map
$results = foreach ($id in $map.psobject.Properties.Name) {
    $policyName = $map.$id
    $currentVal = "Not Defined"

    if ($policyStore.ContainsKey($id)) {
        $currentVal = $policyStore[$id]
    } 
    elseif ($id -like "MACHINE\*") {
        $regPath = $id.Replace("MACHINE\", "HKLM:\")
        $parent = Split-Path $regPath
        $leaf = Split-Path $regPath -Leaf
        if (Test-Path $parent) {
            $regVal = (Get-ItemProperty -Path $parent -Name $leaf -ErrorAction SilentlyContinue).$leaf
            if ($null -ne $regVal) { $currentVal = $regVal }
        }
    }

    $status = switch ($currentVal) {
        "0" { "Disabled (0)" }
        "1" { "Enabled (1)" }
        "Not Defined" { "Not Defined" }
        default { $currentVal }
    }

    [PSCustomObject]@{
        "Setting_ID"    = $id
        "Policy_Option" = $policyName
        "Current_State" = $status
    }
}

$results | Sort-Object Policy_Option | Export-Csv -Path $reportPath -NoTypeInformation

if (Test-Path $secFile) { Remove-Item $secFile -Force }
{% endraw %}
