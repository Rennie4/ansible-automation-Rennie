{% raw %}
# PowerShell Audit Script - Generated by Ansible
# Targeted at Windows 2025 Security Options

$mapPath = "C:\temp\security_options_map.json"
$secFile = "C:\temp\secedit_export.inf"
$reportPath = "C:\temp\security_audit_results.csv"

# Load the mapping file
if (-not (Test-Path $mapPath)) { throw "Mapping file missing." }
$map = Get-Content $mapPath | ConvertFrom-Json

# Export live security policy to a temporary INF file
secedit /export /areas SECURITYPOLICY /cfg $secFile | Out-Null

# Flat store for all discovered settings
$policyStore = @{}

# Parse INF (Note: secedit exports in Unicode/UTF-16)
Get-Content $secFile -Encoding Unicode | ForEach-Object {
    $line = $_.Trim()
    if ($line -match '^([^=]+)=(.*)$') {
        $key = $matches[1].Trim()
        $val = $matches[2].Trim().Trim('"')
        
        # Clean up 'Type, Value' registry format (e.g., '4,1' becomes '1')
        if ($val -match '^\d+,(.*)$') { $val = $matches[1].Trim() }
        $policyStore[$key] = $val
    }
}

# Cross-reference the 104 settings from your GUI/Map
$results = foreach ($id in $map.psobject.Properties.Name) {
    $policyName = $map.$id
    $currentVal = "Not Defined"

    if ($policyStore.ContainsKey($id)) {
        $currentVal = $policyStore[$id]
    } 
    elseif ($id -like "MACHINE\*") {
        # Registry fallback for settings not captured in secedit export
        $regPath = $id.Replace("MACHINE\", "HKLM:\")
        $parent = Split-Path $regPath
        $leaf = Split-Path $regPath -Leaf
        if (Test-Path $parent) {
            $regVal = Get-ItemProperty -Path $parent -Name $leaf -ErrorAction SilentlyContinue
            if ($regVal) { $currentVal = $regVal.$leaf }
        }
    }

    # Normalize output for the report
    $status = switch ($currentVal) {
        "0" { "Disabled (0)" }
        "1" { "Enabled (1)" }
        "Not Defined" { "Not Defined" }
        default { $currentVal }
    }

    [PSCustomObject]@{
        "Setting_ID"    = $id
        "Policy_Option" = $policyName
        "Current_State" = $status
    }
}

# Generate the CSV report
$results | Sort-Object Policy_Option | Export-Csv -Path $reportPath -NoTypeInformation

# Cleanup
if (Test-Path $secFile) { Remove-Item $secFile -Force }
{% endraw %}
