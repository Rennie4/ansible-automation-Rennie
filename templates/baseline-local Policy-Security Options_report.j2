{% raw %}
# PowerShell Audit Script - No Python Required
$secFile = "C:\temp\secedit_export.inf"
$reportPath = "C:\temp\security_audit_results.csv"

# Export live security policy
secedit /export /areas SECURITYPOLICY /cfg $secFile | Out-Null
$policyStore = @{}

# Parse secedit export (UTF-16)
Get-Content $secFile -Encoding Unicode | ForEach-Object {
    $line = $_.Trim()
    if ($line -match '^([^=]+)=(.*)$') {
        $key = $matches[1].Trim()
        $val = $matches[2].Trim().Trim('"')
        if ($val -match '^\d+,(.*)$') { $val = $matches[1].Trim() }
        $policyStore[$key] = $val
    }
}

# This captures the 104 potential security options found in image_5afe59.jpg
$allOptions = Get-ItemProperty "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System" | Get-Member -MemberType NoteProperty

$results = foreach ($opt in $policyStore.Keys) {
    $val = $policyStore[$opt]
    
    $status = switch ($val) {
        "0" { "Disabled" }
        "1" { "Enabled" }
        "4" { "Enabled" }
        "536870912" { "Require 128-bit encryption" }
        default { $val }
    }

    [PSCustomObject]@{
        "Security Policy Name" = $opt
        "Configured Setting"   = $status
    }
}

# Report Formatting for S3
$totalTargeted = 82
$successfullyPulled = $results.Count

$reportHeader = @"
Windows Server 2025: Security Options Audit
Total Targeted,$totalTargeted
Successfully Pulled,$successfullyPulled
"@

$reportHeader | Out-File -FilePath $reportPath -Encoding utf8
$results | Sort-Object "Security Policy Name" | Export-Csv -Path $reportPath -Append -NoTypeInformation

if (Test-Path $secFile) { Remove-Item $secFile -Force }
{% endraw %}
