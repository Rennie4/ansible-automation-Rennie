---
- name: Audit Reversible Encryption Setting
  hosts: all
  gather_facts: yes
  vars:
    s3_bucket_name: "oml-s3-automation-sandbox"
    s3_region: "eu-west-1"
    report_filename: "Reversible_Encryption_Report_{{ inventory_hostname }}.html"

  tasks:
    - name: Audit ClearTextPassword (Force Run)
      win_shell: |
        $tempFile = "C:\Windows\Temp\secedit_audit.inf"
        secedit /export /cfg $tempFile /areas SECURITYPOLICY | Out-Null
        $policy = Get-Content $tempFile
        Remove-Item $tempFile
        
        # Capture the raw value (0 or 1)
        $line = $policy | Select-String "^ClearTextPassword\s*="
        $val = if ($line) { $line.ToString().Split('=')[1].Trim() } else { "0" }
        
        # Explicit mapping: If 0, then "Disabled"
        $status = if ($val -eq "0") { "Disabled" } else { "Enabled" }
        
        @{
            ReversibleEncryption = $status
        } | ConvertTo-Json
      register: audit_result
      check_mode: no

    - name: Generate and Upload Report
      delegate_to: localhost
      check_mode: no
      block:
        - name: Render Template
          template:
            src: "{{ playbook_dir }}/../templates/Windows-2025-HardenedAcountPolicies-checkmode.j2"
            dest: "/tmp/{{ report_filename }}"
          vars:
            data: "{{ audit_result.stdout | from_json }}"

        - name: Upload to S3
          amazon.aws.s3_object:
            bucket: "{{ s3_bucket_name }}"
            object: "cis-baseline-files/{{ report_filename }}"
            src: "/tmp/{{ report_filename }}"
            mode: put
            region: "{{ s3_region }}"
