---
- name: Multi-OS EC2 Patching and Reporting
  hosts: all
  gather_facts: yes
  vars:
    # Use a specific path for your AAP report storage
    report_file: "/tmp/ec2_patch_report_{{ lookup('pipe', 'date +%Y%m%d') }}.csv"

  tasks:
    # -------------------------------------------------------------------------
    # 1. INITIALIZE REPORT (Runs once on the AAP controller)
    # -------------------------------------------------------------------------
    - name: Create CSV Report Header
      run_once: true
      delegate_to: localhost
      copy:
        dest: "{{ report_file }}"
        content: "Hostname,Platform,Instance_ID,Status,Updates_Available,Updates_Installed,Reboot_Required\n"

    # -------------------------------------------------------------------------
    # 2. RHEL PATCHING LOGIC
    # -------------------------------------------------------------------------
    - name: RHEL Patching Block
      when: ansible_os_family == "RedHat"
      block:
        - name: RHEL - Check for available updates
          dnf:
            list: updates
          register: rhel_updates

        - name: RHEL - Apply all security patches
          dnf:
            name: "*"
            state: latest
            security: yes
          register: rhel_patch_run

        - name: RHEL - Check if reboot is needed
          command: needs-restarting -r
          register: rhel_reboot_check
          ignore_errors: yes
          changed_when: false

        - name: RHEL - Rebooting instance
          reboot:
            reboot_timeout: 600
          when: rhel_reboot_check.rc != 0

    # -------------------------------------------------------------------------
    # 3. WINDOWS PATCHING LOGIC
    # -------------------------------------------------------------------------
    - name: Windows Patching Block
      when: ansible_os_family == "Windows"
      block:
        - name: Windows - Search and Install Updates
          ansible.windows.win_updates:
            category_names:
              - SecurityUpdates
              - CriticalUpdates
            state: installed
            reboot: yes # Module handles reboots automatically
            reboot_timeout: 600
          register: win_patch_run

    # -------------------------------------------------------------------------
    # 4. DATA CONSOLIDATION & REPORTING
    # -------------------------------------------------------------------------
    - name: Append data to Central CSV Report
      delegate_to: localhost
      lineinfile:
        path: "{{ report_file }}"
        line: >-
          {{ inventory_hostname }},
          {{ ansible_os_family }},
          {{ ansible_ec2_instance_id | default('N/A') }},
          {{ 'Success' if not (rhel_patch_run.failed | default(false) or win_patch_run.failed | default(false)) else 'Failed' }},
          {{ rhel_updates.results | length if rhel_updates.results is defined else (win_patch_run.found_update_count | default(0)) }},
          {{ rhel_patch_run.results | length if rhel_patch_run.results is defined else (win_patch_run.installed_update_count | default(0)) }},
          {{ 'Yes' if ((rhel_reboot_check is defined and rhel_reboot_check.rc != 0) or (win_patch_run is defined and win_patch_run.reboot_required)) else 'No' }}

    - name: Show Report Summary in AAP Console
      run_once: true
      delegate_to: localhost
      debug:
        msg: "Patching report generated at: {{ report_file }}"
