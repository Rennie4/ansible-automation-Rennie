---
- name: Apply CIS Windows Server 2025 Account Policy Hardening (Check Mode Optimized)
  hosts: all
  gather_facts: yes
  vars:
    s3_bucket_name: "oml-s3-automation-sandbox"
    s3_region: "eu-west-1"
    report_filename: "CheckMode_Report_{{ inventory_hostname }}_{{ ansible_date_time.iso8601_basic_short.split('T')[0] }}.html"

  tasks:
    - name: Audit "Before" State
      win_shell: &audit_logic |
        $netAccounts = net accounts
        $threshold = ($netAccounts | Select-String "Lockout threshold").ToString().Split(':')[1].Trim()
        
        $regPath = "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System"
        $valName = "RelaxMinimumPasswordLengthLimits"
        if (Test-Path $regPath) {
            $prop = Get-ItemProperty -Path $regPath -Name $valName -ErrorAction SilentlyContinue
            if ($null -ne $prop -and $prop.PSObject.Properties[$valName]) {
                $relaxStatus = if ($prop.$valName -eq 1) { "Enabled (1)" } else { "Disabled (0)" }
            } else { $relaxStatus = "Not Defined" }
        } else { $relaxStatus = "Not Defined" }

        @{
            RelaxPasswordLength = $relaxStatus
            LockoutThreshold    = $threshold
            OsName              = (Get-ComputerInfo).OsName
        } | ConvertTo-Json
      register: before_audit
      check_mode: no 

    - name: Hardening - Relax Minimum Password Length (Registry)
      win_regedit:
        path: HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System
        name: RelaxMinimumPasswordLengthLimits
        data: 1
        type: dword
        state: present

    - name: Hardening - Account Lockout Threshold
      win_shell: net accounts /lockoutthreshold:5

    - name: Audit "After" State
      win_shell: *audit_logic
      register: after_audit
      check_mode: no 

    - name: Generate and Upload Check Mode Report
      delegate_to: localhost
      check_mode: no
      block:
        - name: Ensure Local Report Directory Exists
          file:
            path: "{{ playbook_dir }}/reports"
            state: directory
        
        - name: Render Template
          template:
            src: "{{ playbook_dir }}/../templates/Windows-2025-HardenedAcountPolicies-checkmode.j2"
            dest: "{{ playbook_dir }}/reports/{{ report_filename }}"
          vars:
            before: "{{ before_audit.stdout | from_json }}"
            after: "{{ after_audit.stdout | from_json }}"

        - name: Upload to S3
          amazon.aws.s3_object:
            bucket: "{{ s3_bucket_name }}"
            object: "cis-baseline-files/{{ report_filename }}"
            src: "{{ playbook_dir }}/reports/{{ report_filename }}"
            mode: put
            region: "{{ s3_region }}"
