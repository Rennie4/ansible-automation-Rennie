
---
- name: Create and attach a new EBS volume to EC2 instance
  hosts: localhost
  connection: local
  gather_facts: false
  collections:
    - amazon.aws

  vars:
    region: eu-west-1
    instance_id: i-043c4a9904b2ed301
    volume_size: 10              # GB
    volume_type: gp3
    encrypted: true              # set to false if you don't want encryption
    attachment_device_name: /dev/sdf   # Legacy API name; OS may show NVMe on Nitro
    volume_tags:
      Name: ansible-ebs-volume
      Purpose: data
      Owner: automation

  tasks:
    - name: Look up instance to get the correct Availability Zone
      amazon.aws.ec2_instance_info:
        region: "{{ region }}"
        instance_ids:
          - "{{ instance_id }}"
      register: ec2_info

    - name: Set availability_zone fact from instance
      ansible.builtin.set_fact:
        availability_zone: "{{ ec2_info.instances[0].placement.availability_zone }}"

    - name: Create a new EBS volume in the instance's AZ
      amazon.aws.ec2_vol:
        region: "{{ region }}"
        zone: "{{ availability_zone }}"
        volume_size: "{{ volume_size }}"
        state: present
        volume_type: "{{ volume_type }}"
        encrypted: "{{ encrypted }}"
        # Optional gp3 tuning (uncomment if needed):
        # throughput: 125
        # iops: 3000
        tags: "{{ volume_tags | combine({'AttachedTo': instance_id}) }}"
      register: ebs_volume

    - name: Attach the EBS volume to the EC2 instance
      amazon.aws.ec2_vol:
        region: "{{ region }}"
        id: "{{ ebs_volume.volume_id }}"
        instance: "{{ instance_id }}"
        device_name: "{{ attachment_device_name }}"
        delete_on_termination: true     # optional but recommended
        state: present                   # use 'present' to attach

    - name: Share the new volume ID with remote host play
      ansible.builtin.set_fact:
        new_ebs_volume_id: "{{ ebs_volume.volume_id }}"

- name: Format and mount the attached volume on Linux
  hosts: ubuntu_server     # or use linux_hosts to target the whole group
  become: true
  gather_facts: true

  vars:
    mount_point: /data
    filesystem_type: ext4
    xen_device_fallback: /dev/xvdf
    # Pull volume id from the localhost play
    ebs_volume_id: "{{ hostvars['localhost']['new_ebs_volume_id'] }}"

  tasks:
    - name: Resolve NVMe device path via EBS volume ID symlink (Nitro instances)
      ansible.builtin.command: >
        /bin/readlink -f /dev/disk/by-id/nvme-Amazon_Elastic_Block_Store_{{ ebs_volume_id }}
      register: nvme_path
      changed_when: false
      failed_when: false

    # --- Fixed: pick device path without Jinja comparisons ---
    - name: Use NVMe path if readlink returned a value
      ansible.builtin.set_fact:
        device_path: "{{ nvme_path.stdout }}"
      when:
        - nvme_path is defined
        - nvme_path.stdout is defined
        - nvme_path.stdout | trim != ''

    - name: Fallback to Xen device name if NVMe path not found
      ansible.builtin.set_fact:
        device_path: "{{ xen_device_fallback }}"
      when:
        - device_path is not defined

    - name: Wait for the device to appear
      ansible.builtin.wait_for:
        path: "{{ device_path }}"
        timeout: 300

    - name: Detect existing filesystem type (avoid reformatting)
      ansible.builtin.command: blkid -o value -s TYPE {{ device_path }}
      register: existing_fs
      changed_when: false
      failed_when: false

    - name: Create filesystem only if none exists
      ansible.builtin.filesystem:
        fstype: "{{ filesystem_type }}"
        dev: "{{ device_path }}"
      when: (existing_fs.stdout | default('') | trim) == ''

    - name: Create mount point directory
      ansible.builtin.file:
        path: "{{ mount_point }}"
        state: directory
        mode: "0755"

    - name: Read filesystem UUID
      ansible.builtin.command: blkid -o value -s UUID {{ device_path }}
      register: fs_uuid
      changed_when: false

    - name: Ensure fstab entry is present (use UUID for robustness)
      ansible.builtin.mount:
        path: "{{ mount_point }}"
        src: "UUID={{ fs_uuid.stdout | trim }}"
        fstype: "{{ filesystem_type }}"
        opts: defaults,nofail
        state: present

    - name: Mount the volume now
      ansible.builtin.mount:
        path: "{{ mount_point }}"
        src: "UUID={{ fs_uuid.stdout | trim }}"
        fstype: "{{ filesystem_type }}"
        state: mounted
