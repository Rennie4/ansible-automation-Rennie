---
- name: Apply CIS Windows Server 2025 Account Policy Hardening
  hosts: all
  gather_facts: yes
  vars:
    s3_bucket_name: "oml-s3-automation-sandbox"
    s3_region: "eu-west-1"
    report_filename: "Hardening_Comparison_{{ inventory_hostname }}_{{ ansible_date_time.iso8601_basic_short }}.html"

  tasks:
    - name: Audit Current State (Before)
      win_shell: &audit_logic |
        $tempFile = "C:\Windows\Temp\secedit_audit.inf"
        secedit /export /cfg $tempFile /areas SECURITYPOLICY | Out-Null
        $policy = Get-Content $tempFile
        Remove-Item $tempFile

        function Get-Val($key) {
            $line = $policy | Select-String "^$key\s*="
            if ($line) { return $line.ToString().Split('=')[1].Trim() }
            return "0"
        }

        $netAccounts = net accounts
        function Get-Net($regex) {
            $line = $netAccounts | Select-String $regex
            if ($line) { return $line.ToString().Split(':')[1].Trim() }
            return "Unknown"
        }

        $regPath = 'HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System'
        $relax = (Get-ItemProperty -Path $regPath -Name "RelaxMinimumPasswordLengthLimits" -ErrorAction SilentlyContinue).RelaxMinimumPasswordLengthLimits
        
        $adminReg = 'HKLM:\SYSTEM\CurrentControlSet\Control\Lsa\MSV1_0'
        $adminLockVal = (Get-ItemProperty -Path $adminReg -Name "AllowAdminLockout" -ErrorAction SilentlyContinue).AllowAdminLockout

        @{
            PasswordHistory      = Get-Val "PasswordHistorySize"
            MaxPasswordAge       = Get-Val "MaximumPasswordAge"
            MinPasswordAge       = Get-Val "MinimumPasswordAge"
            MinPasswordLength    = Get-Val "MinimumPasswordLength"
            PasswordComplexity   = if (Get-Val "PasswordComplexity" -eq "1") { "Enabled" } else { "Disabled" }
            ReversibleEncryption = if (Get-Val "ClearTextPassword" -eq "1") { "Enabled" } else { "Disabled" }
            RelaxLength          = if ($relax -eq 1) { "Enabled (1)" } else { "Not Defined" }
            LockoutThreshold     = Get-Net "Lockout threshold"
            LockoutDuration      = Get-Net "Lockout duration"
            LockoutWindow        = Get-Net "Lockout observation window"
            AllowAdminLockout    = if ($adminLockVal -eq 1) { "Enabled" } else { "Disabled" }
        } | ConvertTo-Json
      register: before_audit

    - name: Apply CIS Hardening Settings
      block:
        - name: Apply Secedit (Password & Lockout)
          win_shell: |
            $cfg = "C:\Windows\Temp\h.inf"
            "[Unicode]`r`nUnicode=yes`r`n[System Access]`r`n" +
            "PasswordHistorySize = 24`r`n" +
            "MaximumPasswordAge = 365`r`n" +
            "MinimumPasswordAge = 1`r`n" +
            "MinimumPasswordLength = 14`r`n" +
            "PasswordComplexity = 1`r`n" +
            "ClearTextPassword = 0`r`n" +
            "LockoutBadCount = 5`r`n" +
            "ResetLockoutCount = 15`r`n" +
            "LockoutDuration = 15" | Out-File $cfg -Encoding Unicode
            secedit /configure /db C:\Windows\security\local.sdb /cfg $cfg /areas SECURITYPOLICY
            Remove-Item $cfg
        
        - name: Apply Registry (Relax Length & Admin Lockout)
          win_regedit:
            path: '{{ item.path }}'
            name: '{{ item.name }}'
            data: 1
            type: dword
          loop:
            - { path: 'HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System', name: 'RelaxMinimumPasswordLengthLimits' }
            - { path: 'HKLM:\SYSTEM\CurrentControlSet\Control\Lsa\MSV1_0', name: 'AllowAdminLockout' }

    - name: Audit New State (After)
      win_shell: *audit_logic
      register: after_audit

    - name: Generate and Upload Comparison Report
      delegate_to: localhost
      block:
        - name: Render Template
          template:
            src: "../templates/Windows-2025-HardenedAcountPolicies-Apply.j2"
            dest: "/tmp/{{ report_filename }}"
          vars:
            before: "{{ before_audit.stdout | from_json }}"
            after: "{{ after_audit.stdout | from_json }}"

        - name: Upload to S3
          amazon.aws.s3_object:
            bucket: "{{ s3_bucket_name }}"
            object: "cis-remediation-reports/{{ report_filename }}"
            src: "/tmp/{{ report_filename }}"
            mode: put
            region: "{{ s3_region }}"
