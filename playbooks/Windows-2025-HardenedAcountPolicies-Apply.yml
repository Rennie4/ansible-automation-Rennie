---
- name: Force Apply CIS Windows Server 2025 Hardening
  hosts: all
  gather_facts: yes
  vars:
    s3_bucket_name: "oml-s3-automation-sandbox"
    s3_region: "eu-west-1"
    report_filename: "Hardening_Final_Success_{{ inventory_hostname }}_{{ ansible_date_time.iso8601_basic_short }}.html"

  tasks:
    - name: Audit Before State
      win_shell: &audit_logic |
        $net = net accounts
        function Get-Net($re) { $l = $net | Select-String $re; if($l){$l.ToString().Split(':')[1].Trim() }else{"0"} }
        
        $adminReg = 'HKLM:\SYSTEM\CurrentControlSet\Control\Lsa\MSV1_0'
        $adminVal = (Get-ItemProperty -Path $adminReg -Name "AllowAdminLockout" -ErrorAction SilentlyContinue).AllowAdminLockout
        
        $seceditTemp = "C:\Windows\Temp\audit.inf"
        secedit /export /cfg $seceditTemp /areas SECURITYPOLICY | Out-Null
        $sec = Get-Content $seceditTemp
        Remove-Item $seceditTemp
        function Get-Sec($k) { $l = $sec | Select-String "^$k\s*="; if($l){$l.ToString().Split('=')[1].Trim()}else{"0"} }

        @{
            MinPasswordLength    = Get-Net "Minimum password length"
            PasswordHistory      = Get-Net "Length of password history"
            LockoutThreshold     = Get-Net "Lockout threshold"
            ReversibleEncryption = if (Get-Sec "ClearTextPassword" -eq "1") { "Enabled" } else { "Disabled" }
            AllowAdminLockout    = if ($adminVal -eq 1) { "Enabled" } else { "Disabled" }
        } | ConvertTo-Json
      register: before_audit

    - name: Force Hardening (Direct SAM & Registry)
      block:
        - name: Apply SAM Policy via Net Accounts
          win_shell: |
            net accounts /minpwlen:14 /maxpwage:365 /minpwage:1 /unique:24
            net accounts /lockoutthreshold:5 /lockoutduration:15 /lockoutwindow:15

        - name: Apply Registry Policy Settings
          win_regedit:
            path: "{{ item.path }}"
            name: "{{ item.name }}"
            data: "{{ item.data }}"
            type: dword
          loop:
            - { path: 'HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System', name: 'RelaxMinimumPasswordLengthLimits', data: 1 }
            - { path: 'HKLM:\SYSTEM\CurrentControlSet\Control\Lsa\MSV1_0', name: 'AllowAdminLockout', data: 1 }

    - name: Reboot to Commit Changes
      win_reboot:
        msg: "Applying CIS Security Hardening. Rebooting now."
        reboot_timeout: 600

    - name: Wait for System Stability
      wait_for_connection:
        delay: 10
        timeout: 300

    - name: Audit After State (Post-Reboot)
      win_shell: *audit_logic
      register: after_audit

    - name: Render and Upload Report
      delegate_to: localhost
      block:
        - name: Render Template
          template:
            src: "../templates/Windows-2025-HardenedAcountPolicies-Apply.j2"
            dest: "/tmp/{{ report_filename }}"
          vars:
            before: "{{ before_audit.stdout | from_json }}"
            after: "{{ after_audit.stdout | from_json }}"

        - name: Upload to S3
          amazon.aws.s3_object:
            bucket: "{{ s3_bucket_name }}"
            object: "cis-remediation-reports/{{ report_filename }}"
            src: "/tmp/{{ report_filename }}"
            mode: put
            region: "{{ s3_region }}"
