---
- name: AWS Infrastructure - Cleanup and Create
  hosts: localhost
  connection: local
  gather_facts: true
  vars:
    aws_region: "eu-west-1"
    aws_instance: "{{ target_instance_id }}"
    aws_size: "{{ target_vol_size | int }}"
    aws_zone: "{{ target_zone }}"

  tasks:
    - name: Pre-Flight - Find any "Stuck" Available volumes
      amazon.aws.ec2_vol_info:
        region: "{{ aws_region }}"
        filters:
          status: "available"
      register: available_vols

    - name: Pre-Flight - Delete leftover volumes
      amazon.aws.ec2_vol:
        region: "{{ aws_region }}"
        id: "{{ item.id }}"
        state: absent
      loop: "{{ available_vols.volumes }}"
      when: available_vols.volumes | length > 0

    - name: Step 1 - Create Fresh Volume
      amazon.aws.ec2_vol:
        region: "{{ aws_region }}"
        zone: "{{ aws_zone }}"
        volume_size: "{{ aws_size }}"
        name: "Survey-Disk-{{ 100 | random }}-{{ ansible_date_time.epoch }}"
        state: present
      register: raw_vol

    - name: Step 2 - Attach to Fresh Slot
      amazon.aws.ec2_vol:
        region: "{{ aws_region }}"
        instance: "{{ aws_instance }}"
        id: "{{ raw_vol.volume_id }}"
        # We pick a random letter between 'h' and 'p' to keep it fresh
        device_name: "/dev/sd{{ ['h','i','j','k','l','m','n','o','p'] | random }}" 
        state: present

    - name: Step 3 - Wait for AWS API
      amazon.aws.ec2_vol_info:
        region: "{{ aws_region }}"
        filters:
          volume-id: "{{ raw_vol.volume_id }}"
      register: vol_status
      until: 
        - vol_status.volumes[0].attachment_set[0].status == 'attached'
      retries: 15
      delay: 5

    - name: Set facts for OS
      set_fact:
        # AWS volume IDs like vol-1234 becomes vol1234 for the OS serial check
        vol_serial: "{{ raw_vol.volume_id | replace('-', '') }}"
        mount_path: "/data_{{ aws_size }}gb_{{ raw_vol.volume_id[-4:] }}"

- name: OS Configuration - High-Speed Discovery
  hosts: linux_hosts
  become: yes
  tasks:
    - name: Identify Device by Serial ID
      shell: 
        cmd: |
          udevadm trigger && udevadm settle --timeout=10
          # Look for the device path using the unique AWS Serial ID
          lsblk -rdpno NAME,SERIAL | grep "{{ hostvars['localhost']['vol_serial'] }}" | awk '{print $1}'
      register: found_device
      until: found_device.stdout != ""
      retries: 10
      delay: 5

    - name: Final Format and Mount
      block:
        - name: Create directory
          file:
            path: "{{ hostvars['localhost']['mount_path'] }}"
            state: directory

        - name: Create filesystem
          filesystem:
            fstype: ext4
            dev: "{{ found_device.stdout }}"

        - name: Mount volume
          mount:
            path: "{{ hostvars['localhost']['mount_path'] }}"
            src: "{{ found_device.stdout }}"
            fstype: ext4
            state: mounted

    - name: Success Summary
      debug:
        msg: "SUCCESS! {{ hostvars['localhost']['aws_size'] }}GB mounted at {{ hostvars['localhost']['mount_path'] }}"
