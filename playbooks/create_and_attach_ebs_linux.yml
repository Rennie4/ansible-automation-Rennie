---
- name: Universal Linux Patching with Infinite Storage Persistence
  hosts: all
  become: yes
  gather_facts: yes

  tasks:
    - name: Step 0.1 - Discover all attached EBS volumes
      find:
        paths: /dev/disk/by-id/
        # Matches any Amazon EBS volume regardless of exact ID
        patterns: "*Amazon_Elastic_Block_Store_vol*"
      register: found_disks
      when: ansible_os_family == "Debian"

    - name: Step 0.2 - Ensure Mount Points and Safe fstab entries
      ansible.posix.mount:
        # Dynamically names folders based on the last 4 chars of the Volume ID
        path: "/mnt/storage_ebs_{{ item.path | last_chars(4) }}"
        src: "{{ item.path }}"
        fstype: ext4
        # 'nofail' prevents the server from hanging if the disk isn't ready at boot
        opts: defaults,nofail
        state: present 
      loop: "{{ found_disks.files | default([]) }}"
      when: ansible_os_family == "Debian" and found_disks.matched > 0

    - name: Step 1 - Debian/Ubuntu - Update Cache and Full Upgrade
      apt:
        update_cache: yes
        upgrade: full
      when: ansible_os_family == "Debian"
      register: apt_result

    - name: Step 4 - Force Reboot for Storage Verification
      reboot:
        msg: "Verifying persistence for all discovered drives."
        reboot_timeout: 300
        # Wait for the system to fully settle before re-connecting
        post_reboot_delay: 30 
      when: ansible_os_family == "Debian" 

    - name: Step 5 - Verify All Mounts are active after Reboot
      command: "mountpoint /mnt/storage_ebs_{{ item.path | last_chars(4) }}"
      loop: "{{ found_disks.files | default([]) }}"
      register: mount_results
      changed_when: false
      failed_when: mount_results.rc != 0
      when: ansible_os_family == "Debian" and found_disks.matched > 0
