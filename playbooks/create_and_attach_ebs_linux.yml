---
- name: AWS Infrastructure - Create and Attach
  hosts: localhost
  connection: local
  gather_facts: true
  vars:
    aws_region: "eu-west-1"
    aws_instance: "{{ target_instance_id }}"
    aws_size: "{{ target_vol_size | int }}"
    aws_zone: "{{ target_zone }}"

  tasks:
    - name: Step 1 - Create Unique Volume
      amazon.aws.ec2_vol:
        region: "{{ aws_region }}"
        zone: "{{ aws_zone }}"
        volume_size: "{{ aws_size }}"
        name: "Disk-{{ 100 | random }}-{{ ansible_date_time.epoch }}"
        state: present
      register: raw_vol

    - name: Step 2 - Attach to Instance
      amazon.aws.ec2_vol:
        region: "{{ aws_region }}"
        instance: "{{ aws_instance }}"
        id: "{{ raw_vol.volume_id }}"
        # Automatically cycles through slots to avoid collisions
        device_name: "/dev/sd{{ ['h','i','j','k','l','m','n','o','p'] | random }}" 
        state: present

    - name: Step 3 - Wait for attachment to stabilize
      amazon.aws.ec2_vol_info:
        region: "{{ aws_region }}"
        filters:
          volume-id: "{{ raw_vol.volume_id }}"
      register: vol_status
      until: vol_status.volumes[0].attachment_set[0].status == 'attached'
      retries: 10
      delay: 5

    - name: Set facts for OS discovery
      set_fact:
        vol_id_short: "{{ raw_vol.volume_id | replace('-', '') }}"
        final_path: "/data_{{ aws_size }}gb_{{ raw_vol.volume_id[-4:] }}"

- name: OS Configuration - Universal Format and Mount
  hosts: linux_hosts
  become: yes
  tasks:
    - name: Universal Device Discovery
      shell: 
        cmd: |
          # Rescan SCSI bus and wait for settle
          for bus in /sys/class/scsi_host/host*/scan; do echo "- - -" > "$bus"; done
          udevadm settle && sleep 10
          
          SERIAL_ID="{{ hostvars['localhost']['vol_id_short'] }}"
          
          # Try finding by serial (Nitro/Standard)
          DEVICE=$(lsblk -rdpno NAME,SERIAL | grep "$SERIAL_ID" | awk '{print $1}' | head -n 1)
          
          # Fallback: Find the newest disk that isn't the root drive
          if [ -z "$DEVICE" ]; then
            DEVICE=$(lsblk -dpno NAME | grep -v "$(lsblk -dpno NAME | head -n 1)" | sort | tail -n 1)
          fi
          
          echo "$DEVICE"
      register: found_device

    - name: Create directory
      file:
        path: "{{ hostvars['localhost']['final_path'] }}"
        state: directory
        mode: '0755'

    - name: Create filesystem
      filesystem:
        fstype: ext4
        dev: "{{ found_device.stdout }}"
        force: no

    - name: Mount volume
      mount:
        path: "{{ hostvars['localhost']['final_path'] }}"
        src: "{{ found_device.stdout }}"
        fstype: ext4
        state: mounted
        opts: defaults

    - name: Final Success Message
      debug:
        msg: 
          - "SUCCESS: Disk Live and Mounted!"
          - "Volume ID: {{ hostvars['localhost']['vol_id_short'] }}"
          - "Mount Point: {{ hostvars['localhost']['final_path'] }}"
