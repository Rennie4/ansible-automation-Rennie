---
- name: AWS Infrastructure - Create and Attach
  hosts: localhost
  connection: local
  gather_facts: true
  vars:
    # --- Survey Variables ---
    aws_instance: "{{ target_instance_id }}"
    aws_size: "{{ target_vol_size | int }}"
    aws_region: "{{ target_region | default('eu-west-1') }}"
    target_az: "{{ target_availability_zone | default('') }}"
    
    # --- Universal Config ---
    volume_type: "gp3"
    encrypted: true
    attach_device_prefix: "/dev/sd"
    candidate_letters: ['f','g','h','i','j','k','l','m','n','o','p','q','r','s','t','u']

  tasks:
    - name: Step 1 - Get instance details
      amazon.aws.ec2_instance_info:
        region: "{{ aws_region }}"
        instance_ids: ["{{ aws_instance }}"]
      register: instance_info

    - name: Step 2 - Set initial facts
      set_fact:
        instance_zone: "{{ instance_info.instances[0].placement.availability_zone }}"
        target_ip: "{{ instance_info.instances[0].public_ip_address if instance_info.instances[0].public_ip_address else instance_info.instances[0].private_ip_address }}"
        existing_device_names: "{{ instance_info.instances[0].block_device_mappings | map(attribute='device_name') | list }}"

    - name: Step 3 - Set effective zone
      set_fact:
        aws_zone: "{{ target_az if target_az|length > 0 else instance_zone }}"

    - name: Step 4a - Identify used device letters
      set_fact:
        used_letters: "{{ existing_device_names | map('regex_replace', '^/dev/sd([a-z]+)[0-9]*$', '\\1') | select('match', '^[a-z]+$') | list }}"

    - name: Step 4b - Compute available letters
      set_fact:
        free_letters: "{{ candidate_letters | difference(used_letters) }}"

    - name: Step 4c - Pick the first available label
      set_fact:
        attach_label: "{{ attach_device_prefix }}{{ free_letters[0] }}"

    - name: Step 5 - Create EBS volume
      amazon.aws.ec2_vol:
        region: "{{ aws_region }}"
        zone: "{{ aws_zone }}"
        volume_size: "{{ aws_size }}"
        volume_type: "{{ volume_type }}"
        encrypted: "{{ encrypted }}"
        tags:
          Name: "Disk-{{ aws_instance }}-{{ aws_size }}GB-{{ ansible_date_time.epoch }}"
        state: present
      register: raw_vol

    - name: Step 6 - Attach to Instance
      amazon.aws.ec2_vol:
        region: "{{ aws_region }}"
        instance: "{{ aws_instance }}"
        volume_id: "{{ raw_vol.volume_id }}"
        device_name: "{{ attach_label }}"
        state: present

    - name: Step 7 - Wait for Attachment Stability
      amazon.aws.ec2_vol_info:
        region: "{{ aws_region }}"
        filters:
          volume-id: "{{ raw_vol.volume_id }}"
      register: vol_info
      until:
        - vol_info.volumes | length > 0
        - vol_info.volumes[0].attachment_set | length > 0
        - vol_info.volumes[0].attachment_set[0].status in ['attaching', 'attached']
      retries: 30
      delay: 5

    - name: Step 8 - Set OS variables
      set_fact:
        # Serial on Nitro removes the 'vol-' prefix and the dash
        vol_serial: "{{ raw_vol.volume_id | replace('vol-', '') | replace('-', '') }}"
        final_path: "/data_{{ aws_size }}gb_{{ raw_vol.volume_id[-4:] }}"

    - name: Step 9 - Update dynamic inventory
      add_host:
        name: "current_target"
        ansible_host: "{{ target_ip }}"
        ansible_user: "ubuntu"
        ansible_ssh_private_key_file: "/runner/artifacts/1447/ssh_key_data"
        groups: active_nodes

- name: OS Configuration - Format and Mount
  hosts: active_nodes
  gather_facts: no
  tasks:
    - name: Step 10 - Wait for SSH Connectivity
      wait_for:
        port: 22
        host: "{{ ansible_host }}"
        search_regex: OpenSSH
        timeout: 300
      delegate_to: localhost

    - name: Step 11 - Universal Device Discovery (SATA & NVMe)
      become: yes
      shell: |
        # This logic works for ALL instances:
        # 1. On Nitro (T3/M5), lsblk shows the Volume ID as the Serial.
        # 2. On Older (T2/M4), the Serial is often the Volume ID but without the 'vol-' prefix.
        # This command finds the path regardless of the name (/dev/xvdf or /dev/nvme1n1)
        lsblk -rdpno NAME,SERIAL | grep -i "{{ hostvars['localhost']['vol_serial'] }}" | awk '{print $1}' | head -n 1
      register: found_device
      until: found_device.stdout != ""
      retries: 20
      delay: 5

    - name: Step 12 - Universal Format and Mount
      become: yes
      block:
        - name: Create mount point
          file:
            path: "{{ hostvars['localhost']['final_path'] }}"
            state: directory
            mode: '0755'

        - name: Create filesystem
          filesystem:
            fstype: ext4
            dev: "{{ found_device.stdout }}"
            # 'force: no' ensures we don't wipe data if you run this twice
            force: no

        - name: Mount volume
          mount:
            path: "{{ hostvars['localhost']['final_path'] }}"
            src: "{{ found_device.stdout }}"
            fstype: ext4
            state: mounted

    - name: Final Success Report
      debug:
        msg: "SUCCESS! {{ hostvars['localhost']['aws_size'] }}GB mounted at {{ hostvars['localhost']['final_path'] }} on device {{ found_device.stdout }}"
