
---
# Play 1: AWS actions on localhost
- name: AWS Infrastructure - Create and Attach Multiple Volumes
  hosts: localhost
  connection: local
  gather_facts: true

  vars:
    # --- Survey variables ---
    aws_instance: "{{ target_instance_id }}"
    aws_region: "{{ target_region | default('eu-west-1') }}"
    target_az: "{{ target_availability_zone | default('') }}"
    volume_count: "{{ target_volume_count | int }}"
    sizes_csv: "{{ target_volume_sizes_csv }}"
    fstype: "{{ target_fstype | default('ext4') }}"
    volume_type: "{{ target_volume_type | default('gp3') }}"
    delete_on_termination: "{{ target_delete_on_termination | default(false) | bool }}"
    encrypted: "{{ target_encrypted | default(true) | bool }}"
    kms_key_id: "{{ target_kms_key_id | default(omit) }}"
    iops: "{{ target_iops | default(omit) }}"
    throughput: "{{ target_throughput | default(omit) }}"

    # Base device names for API attachment labels: /dev/sdf, /dev/sdg, ...
    attach_device_prefix: "/dev/sd"
    attach_device_letters: ['f','g','h','i','j','k','l','m','n','o','p','q']

  tasks:
    # ---------- Prechecks ----------
    - name: Precheck - AWS env vars injected
      assert:
        that:
          - lookup('env', 'AWS_ACCESS_KEY_ID') | length > 0
          - lookup('env', 'AWS_SECRET_ACCESS_KEY') | length > 0
        fail_msg: >-
          AWS credentials not found in environment. Ensure the Job Template has an
          'Amazon Web Services' credential attached and the Execution Environment
          includes boto3/botocore and amazon.aws collection.

    - name: Precheck - Normalize region
      set_fact:
        aws_region: "{{ aws_region if aws_region|length>0 else (lookup('env', 'AWS_DEFAULT_REGION') | default('eu-west-1')) }}"

    - name: Precheck - Caller identity (sts:GetCallerIdentity)
      amazon.aws.aws_caller_info:
        region: "{{ aws_region }}"
      register: whoami

    - name: Debug - Caller info
      debug:
        msg:
          - "AWS Account: {{ whoami.account }}"
          - "ARN: {{ whoami.arn }}"
          - "Region: {{ aws_region }}"

    - name: Validate survey inputs (instance, count)
      assert:
        that:
          - aws_instance is match('^i-[0-9a-f]+$')
          - volume_count | int > 0
        fail_msg: "Survey validation failed: instance_id (i-xxxx) and volume_count (>0) required."

    - name: Parse sizes from CSV and validate length
      set_fact:
        sizes_list: "{{ sizes_csv | trim | split(',') | map('trim') | list }}"
    - name: Coerce sizes to int and validate all > 0
      set_fact:
        sizes_int_list: "{{ sizes_list | map('int') | list }}"
    - name: Validate sizes list length equals count
      assert:
        that:
          - sizes_int_list | length == volume_count | int
          - (sizes_int_list | min) > 0
        fail_msg: >-
          Sizes CSV must contain exactly {{ volume_count }} positive integers (GiB). Received: {{ sizes_list }}

    # ---------- Instance discovery ----------
    - name: Get instance details
      amazon.aws.ec2_instance_info:
        region: "{{ aws_region }}"
        instance_ids: ["{{ aws_instance }}"]
      register: instance_info

    - name: Fail if instance not found
      assert:
        that:
          - instance_info.instances | length == 1
        fail_msg: "Instance {{ aws_instance }} not found in region {{ aws_region }}."

    - name: Set instance facts
      set_fact:
        instance_zone: "{{ instance_info.instances[0].placement.availability_zone }}"
        aws_zone: >-
          {{ (target_az | length > 0)
             | ternary(target_az, instance_info.instances[0].placement.availability_zone) }}
        target_ip: >-
          {{ instance_info.instances[0].public_ip_address
             if instance_info.instances[0].public_ip_address
             else instance_info.instances[0].private_ip_address }}

    - name: Assert aws_zone matches instance AZ
      assert:
        that:
          - aws_zone == instance_zone
        fail_msg: >-
          AZ mismatch: selected AZ ({{ aws_zone }}) != instance AZ ({{ instance_zone }}).
          EBS must be created in the SAME AZ as the instance.

    - name: Debug - Inputs
      debug:
        msg:
          - "Instance: {{ aws_instance }}"
          - "Region: {{ aws_region }}"
          - "AZ (effective): {{ aws_zone }}"
          - "Volumes to create: {{ volume_count }}"
          - "Sizes (GiB): {{ sizes_int_list }}"
          - "Attach device letters: {{ attach_device_letters[:volume_count] }}"

    # ---------- Create + attach loop ----------
    - name: Initialize list to collect created volumes
      set_fact:
        created_volumes: []

    - name: Loop - Create and attach volumes
      vars:
        idx: "{{ item.0 }}"
        size_gb: "{{ item.1 }}"
        device_label: "{{ attach_device_prefix }}{{ attach_device_letters[idx] }}"
        vol_name: "Reusable-Disk-{{ aws_instance }}-{{ size_gb }}GiB-{{ ansible_date_time.epoch }}-{{ idx }}"
        vol_tags:
          Name: "{{ vol_name }}"
          Owner: "{{ lookup('env', 'USER') | default('awx') }}"
          ManagedBy: "Ansible"
          InstanceId: "{{ aws_instance }}"
          Region: "{{ aws_region }}"
          Index: "{{ idx }}"
          SizeGB: "{{ size_gb }}"
      loop: "{{ query('zip', range(0, volume_count | int), sizes_int_list) }}"
      block:
        - name: Create EBS volume ({{ size_gb }} GiB, index {{ idx }})
          amazon.aws.ec2_vol:
            region: "{{ aws_region }}"
            zone: "{{ aws_zone }}"
            volume_size: "{{ size_gb }}"
            volume_type: "{{ volume_type }}"
            iops: "{{ iops }}"
            throughput: "{{ throughput }}"
            encrypted: "{{ encrypted }}"
            kms_key_id: "{{ kms_key_id }}"
            tags: "{{ vol_tags }}"
            state: present
          register: raw_vol

        - name: Assert volume created (index {{ idx }})
          assert:
            that:
              - raw_vol.volume_id is defined
            fail_msg: "EBS volume (index {{ idx }}) failedâ€”no volume_id returned."

        - name: Attach EBS volume to instance ({{ device_label }}, index {{ idx }})
          amazon.aws.ec2_vol:
            region: "{{ aws_region }}"
            instance: "{{ aws_instance }}"
            volume_id: "{{ raw_vol.volume_id }}"
            device_name: "{{ device_label }}"
            delete_on_termination: "{{ delete_on_termination }}"
            state: present
          register: attach_result

        - name: Wait until attached (index {{ idx }})
          amazon.aws.ec2_vol_info:
            region: "{{ aws_region }}"
            filters:
              volume-id: "{{ raw_vol.volume_id }}"
          register: vol_status
          until:
            - vol_status.volumes | length > 0
            - vol_status.volumes[0].attachment_set | length > 0
            - vol_status.volumes[0].attachment_set[0].instance_id == aws_instance
            - vol_status.volumes[0].attachment_set[0].status in ['attaching', 'attached']
          retries: 30
          delay: 5

        - name: Append created volume info (index {{ idx }})
          set_fact:
            created_volumes: "{{ created_volumes + [ { 'index': idx, 'size_gb': size_gb, 'volume_id': raw_vol.volume_id, 'device_label': device_label } ] }}"

    # ---------- Dynamic inventory for OS config ----------
    - name: Add target to dynamic inventory
      add_host:
        name: "current_target"
        ansible_host: "{{ target_ip }}"
        ansible_user: "ubuntu"
        ansible_ssh_private_key_file: "{{ lookup('env', 'ANSIBLE_PRIVATE_KEY_FILE') | default('/runner/artifacts/{{ ansible_job_id }}/ssh_key_data') }}"
        groups: active_nodes
      vars:
        created_volumes: "{{ created_volumes }}"
        fstype: "{{ fstype }}"

# Play 2: OS actions on the instance
- name: OS Configuration - Format and Mount Multiple Volumes
