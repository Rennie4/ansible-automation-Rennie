---
- name: AWS Infrastructure - Create and Attach
  hosts: localhost
  connection: local
  gather_facts: true
  vars:
    aws_region: "eu-west-1"
    aws_instance: "{{ target_instance_id }}"
    aws_size: "{{ target_vol_size | int }}"
    aws_zone: "{{ target_zone }}"

  tasks:
    - name: Force Create Unique EBS Volume
      amazon.aws.ec2_vol:
        instance: "{{ aws_instance }}"
        region: "{{ aws_region }}"
        zone: "{{ aws_zone }}"
        volume_size: "{{ aws_size }}"
        # This token forces AWS to ignore existing disks and make a NEW one
        idempotency_token: "run-{{ ansible_date_time.epoch }}"
        tags:
          Name: "Disk-{{ aws_size }}gb-{{ ansible_date_time.epoch }}"
        state: present
      register: ec2_vol_result

    - name: Set facts for OS discovery
      set_fact:
        vol_id_short: "{{ ec2_vol_result.volume_id | replace('-', '') }}"
        survey_size: "{{ aws_size }}"

- name: OS Configuration - Universal Format and Mount
  hosts: linux_hosts
  become: yes
  tasks:
    - name: Universal Device Discovery
      shell: 
        cmd: |
          # Rescan the bus to find the new hardware
          for bus in /sys/class/scsi_host/host*/scan; do echo "- - -" > "$bus"; done
          udevadm settle && sleep 5
          
          # We search for the NEW Volume ID provided by the AWS task
          NEW_ID="{{ hostvars['localhost']['vol_id_short'] }}"
          DEVICE=$(lsblk -rdpno NAME,SERIAL | grep "$NEW_ID" | awk '{print $1}' | head -n 1)
          
          # Fallback: If AWS hides the serial, pick the highest alphabetical device that isn't root
          if [ -z "$DEVICE" ]; then
             DEVICE=$(lsblk -dpno NAME | grep -v "$(lsblk -dpno NAME | head -n 1)" | sort | tail -n 1)
          fi
          echo "$DEVICE"
      register: found_device

    - name: Format and Mount
      vars:
        # Use the NEW Volume ID to make the folder name unique
        short_id: "{{ hostvars['localhost']['vol_id_short'][-4:] }}"
        target_path: "/data_{{ hostvars['localhost']['survey_size'] }}gb_{{ short_id }}"
      block:
        - name: Create directory
          file:
            path: "{{ target_path }}"
            state: directory
            mode: '0755'

        - name: Create filesystem
          filesystem:
            fstype: ext4
            dev: "{{ found_device.stdout }}"
            force: no

        - name: Mount volume
          mount:
            path: "{{ target_path }}"
            src: "{{ found_device.stdout }}"
            fstype: ext4
            state: mounted
            opts: defaults

    - name: Success Message
      debug:
        msg: "Success! New disk {{ hostvars['localhost']['vol_id_short'] }} mounted at {{ target_path }}"
