---
- name: AWS Infrastructure - Create and Attach
  hosts: localhost
  connection: local
  gather_facts: true
  vars:
    # --- THESE PULL FROM YOUR SURVEY/TEMPLATE ---
    aws_region: "eu-west-1"
    aws_instance: "{{ target_instance_id }}"
    aws_size: "{{ target_vol_size | int }}"
    aws_zone: "{{ target_zone }}"

  tasks:
    - name: Step 1 - Create Unique Volume
      amazon.aws.ec2_vol:
        region: "{{ aws_region }}"
        zone: "{{ aws_zone }}"
        volume_size: "{{ aws_size }}"
        name: "Survey-Disk-{{ aws_size }}GB-{{ ansible_date_time.epoch }}"
        state: present
      register: raw_vol

    - name: Step 2 - Attach to Instance
      amazon.aws.ec2_vol:
        region: "{{ aws_region }}"
        instance: "{{ aws_instance }}"
        id: "{{ raw_vol.volume_id }}"
        device_name: "/dev/sd{{ ['f','g','h','i','j','k','l','m','n','o','p'] | random }}" 
        state: present

    - name: Step 3 - Dynamic Discovery of Connection IP
      amazon.aws.ec2_instance_info:
        region: "{{ aws_region }}"
        instance_ids: ["{{ aws_instance }}"]
      register: instance_info

    - name: Set facts for OS discovery
      set_fact:
        # Use public_ip_address for sandbox, private_ip_address for production
        target_ip: "{{ instance_info.instances[0].public_ip_address if instance_info.instances[0].public_ip_address else instance_info.instances[0].private_ip_address }}"
        vol_serial: "{{ raw_vol.volume_id | replace('-', '') }}"
        final_path: "/data_{{ aws_size }}gb_{{ raw_vol.volume_id[-5:] }}"

    - name: Step 4 - Override Git Inventory
      add_host:
        name: "current_target"
        ansible_host: "{{ target_ip }}"
        ansible_user: "ubuntu"
        ansible_ssh_private_key_file: "{{ ssh_key_path | default('/runner/artifacts/1246/ssh_key_data') }}"
        groups: active_nodes

- name: OS Configuration - Format and Mount
  hosts: active_nodes
  become: yes
  gather_facts: no
  tasks:
    - name: Step 5 - Wait for SSH Connectivity
      wait_for_connection:
        timeout: 300

    - name: Step 6 - Hardware Discovery (NVMe Compatible)
      shell: 
        cmd: |
          # Works for both t2 (SATA) and t3 (NVMe) device names
          lsblk -rdpno NAME,SERIAL | grep "{{ hostvars['localhost']['vol_serial'] }}" | awk '{print $1}' | head -n 1
      register: found_device
      until: found_device.stdout != ""
      retries: 15
      delay: 5

    - name: Step 7 - Universal Mount
      block:
        - name: Create mount point
          file:
            path: "{{ hostvars['localhost']['final_path'] }}"
            state: directory
            mode: '0755'

        - name: Create filesystem
          filesystem:
            fstype: ext4
            dev: "{{ found_device.stdout }}"
            force: no

        - name: Mount
          mount:
            path: "{{ hostvars['localhost']['final_path'] }}"
            src: "{{ found_device.stdout }}"
            fstype: ext4
            state: mounted

    - name: Success Summary
      debug:
        msg: "SUCCESS: {{ hostvars['localhost']['aws_size'] }}GB mounted on {{ ansible_host }} at {{ hostvars['localhost']['final_path'] }}"
