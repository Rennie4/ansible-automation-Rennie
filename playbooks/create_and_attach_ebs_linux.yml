
---
- name: AWS Infrastructure - Create and Attach Volume
  hosts: localhost
  connection: local
  gather_facts: true

  vars:
    # --- Survey-driven variables ---
    aws_instance: "{{ target_instance_id }}"
    aws_size: "{{ target_vol_size | int }}"
    aws_region: "{{ target_region | default('eu-west-1') }}"
    target_az: "{{ target_availability_zone | default('') }}"
    attach_device_name: "/dev/sdf"
    delete_on_termination: "{{ target_delete_on_termination | default(false) | bool }}"
    encrypted: "{{ target_encrypted | default(true) | bool }}"
    kms_key_id: "{{ target_kms_key_id | default(omit) }}"
    volume_type: "{{ target_volume_type | default('gp3') }}"
    iops: "{{ target_iops | default(omit) }}"
    throughput: "{{ target_throughput | default(omit) }}"
    common_tags:
      Name: "Reusable-Disk-{{ ansible_date_time.epoch }}"
      Owner: "{{ lookup('env', 'USER') | default('awx') }}"
      ManagedBy: "Ansible"
      InstanceId: "{{ aws_instance }}"
      Region: "{{ aws_region }}"

  tasks:
    # --- Credential precheck: ensure AWX injected env vars ---
    - name: Precheck - AWS environment variables injected
      assert:
        that:
          - lookup('env', 'AWS_ACCESS_KEY_ID') | length > 0
          - lookup('env', 'AWS_SECRET_ACCESS_KEY') | length > 0
        fail_msg: >-
          AWS credentials not found in environment. Ensure the Job Template has an
          'Amazon Web Services' credential attached and the Execution Environment
          supports amazon.aws. (Missing AWS_ACCESS_KEY_ID/AWS_SECRET_ACCESS_KEY)

    - name: Precheck - Set region from env if not provided
      set_fact:
        aws_region: "{{ aws_region if aws_region|length>0 else (lookup('env', 'AWS_DEFAULT_REGION') | default('eu-west-1')) }}"

    - name: Precheck - Validate caller identity (sts:GetCallerIdentity)
      amazon.aws.aws_caller_info:
        region: "{{ aws_region }}"
      register: whoami

    - name: Debug - Caller info
      debug:
        msg:
          - "AWS Account: {{ whoami.account }}"
          - "ARN: {{ whoami.arn }}"
          - "Region: {{ aws_region }}"

    - name: Validate input variables
      assert:
        that:
          - aws_instance is match('^i-[0-9a-f]+$')
          - aws_size | int > 0
