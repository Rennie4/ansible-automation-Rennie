
---
- name: Set Linux hostname and reboot if changed
  hosts: linux_hosts
  gather_facts: true
  become: true

  vars:
    # Provide via Survey / extra vars in AAP: new_hostname: my-linux-host
    new_hostname: "linux-01"
    # Optional: set domain for FQDN, or leave blank to use short name only
    new_domain: ""

  pre_tasks:
    - name: Compute desired FQDN (if domain provided)
      set_fact:
        desired_hostname: >-
          {{ (new_domain | length > 0)
              | ternary( new_hostname ~ '.' ~ new_domain, new_hostname) }}

    - name: Show current versus desired hostname
      debug:
        msg:
          - "Current: {{ ansible_hostname }} | FQDN: {{ ansible_fqdn }}"
          - "Desired: {{ desired_hostname }}"

  tasks:
    - name: Set hostname (idempotent)
      ansible.builtin.hostname:
        name: "{{ desired_hostname }}"
      register: hostname_change

    - name: Update /etc/hosts loopback entries to match hostname
      ansible.builtin.lineinfile:
        path: /etc/hosts
        regexp: '^(127\.0\.1\.1|127\.0\.0\.1)\s+'
        line: >-
          {{ (ansible_distribution | lower) in ['ubuntu','debian']
              | ternary('127.0.1.1', '127.0.0.1') }}
          {{ desired_hostname }} {{ desired_hostname.split('.')[0] }}
        create: yes
        backup: yes
      when: hostname_change is changed
      notify: Restart hostnamed if available

    - name: Display what changed
      debug:
        var: hostname_change
      when: hostname_change is changed

    - name: Reboot Linux if hostname changed
      ansible.builtin.reboot:
        reboot_timeout: 600
        test_command: whoami
      when: hostname_change is changed

  handlers:
    - name: Restart hostnamed if available
      become: true
      ansible.builtin.service:
        name: systemd-hostnamed
        state: restarted
      when:
        - "'systemd' in ansible_service_mgr"
       
