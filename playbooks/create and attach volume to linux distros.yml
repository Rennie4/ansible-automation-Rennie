---
# PLAY 1: AWS Side - Create and Attach
- name: Create and Attach EBS Volume via Survey
  hosts: localhost
  connection: local
  gather_facts: no
  tasks:
    - name: Create and Attach Volume
      amazon.aws.ec2_vol:
        instance: "{{ target_instance_id }}" 
        volume_size: "{{ target_vol_size }}" # Uses your survey value
        zone: "{{ target_zone }}" # Uses your survey value
        region: "eu-west-1"
        device_name: "/dev/sdg" # Changed to avoid conflict with existing /dev/sdf
        state: present
      register: ec2_vol_result

# PLAY 2: Linux Side - Universal Mounting
- name: Universal Linux Storage Extension
  hosts: all
  become: yes

  tasks:
    - name: Step 0.1 - Force OS Hardware Scan
      shell: |
        for dev in /sys/class/scsi_host/host*/scan; do echo "- - -" > $dev; done
        udevadm settle
      ignore_errors: yes
      changed_when: false

    - name: Step 0.2 - Refresh Hardware Facts
      setup:
        filter: ansible_devices

    - name: Step 0.3 - Process All Unmounted EBS Volumes
      # This block will now loop through ALL disks that aren't the OS drive
      include_tasks:
        file: inner_mount_logic.yml
      loop: "{{ ansible_facts.devices | dict2items }}"
      when: 
        - item.key not in ['sda', 'vda', 'xvda', 'nvme0n1']
        - "'loop' not in item.key"
        - item.value.partitions | length == 0 # Only targets raw, unpartitioned disks
