---
# PLAY 1: AWS Side - Create and Attach
- name: Create and Attach EBS Volume via Survey
  hosts: localhost
  connection: local
  gather_facts: no
  tasks:
    - name: Create and Attach Volume
      amazon.aws.ec2_vol:
        instance: "{{ target_instance_id }}" 
        volume_size: "{{ target_vol_size }}" 
        zone: "{{ target_zone }}" 
        region: "eu-west-1"
        device_name: "/dev/sdg" 
        state: present
      register: ec2_vol_result

# PLAY 2: Linux Side - Universal Mounting & Extension
- name: Universal Linux Storage Extension
  hosts: all
  become: yes
  vars:
    base_mount_path: "/data"

  tasks:
    # ... (Mounting and Discovery Tasks) ...

    - name: Step 1 - Universal Patching
      package:
        name: "*"
        state: latest

    - name: Step 4 - Force Reboot for Verification
      # This confirms your 'Infinite Persistence' goal works
      reboot:
        reboot_timeout: 300

    - name: Step 5 - Final Verification
      shell: "df -h | grep {{ base_mount_path }}"
      register: final_check
      changed_when: false
