---
# PLAY 1: AWS Side
- name: Create and Attach EBS Volume via Survey
  hosts: localhost
  connection: local
  gather_facts: no
  tasks:
    - name: Create and Attach Volume
      amazon.aws.ec2_vol:
        instance: "{{ target_instance_id }}" 
        volume_size: "{{ target_vol_size }}" 
        zone: "{{ target_zone }}" 
        region: "eu-west-1"
        device_name: "/dev/sdg" 
        state: present
      register: ec2_vol_result

# PLAY 2: Linux Side
- name: Universal Linux Storage Extension
  hosts: all
  become: yes
  vars:
    base_mount_path: "/data"

  tasks:
    - name: Step 0.1 - Hardware Scan
      shell: "for dev in /sys/class/scsi_host/host*/scan; do echo '- - -' > $dev; done; udevadm settle"
      ignore_errors: yes
      changed_when: false

    - name: Step 0.2 - Identify New Disks
      setup:
        filter: ansible_devices

    - name: Step 0.3 - Create List of New Disks
      set_fact:
        new_disks: "{{ ansible_facts.devices | dict2items | 
                       rejectattr('key', 'match', '^(loop|sda|vda|xvda|nvme0n1)') | 
                       selectattr('value.partitions', 'equalto', {}) | 
                       map(attribute='key') | list }}"

    - name: Step 0.4 - Provision Disks
      block:
        - name: Mount and Format Loop
          include_tasks:
            content: |
              - name: Create Dir
                file: path="{{ base_mount_path }}/{{ item }}" state=directory
              - name: FS
                filesystem: fstype=xfs dev="/dev/{{ item }}"
              - name: Get UUID
                command: "blkid -s UUID -o value /dev/{{ item }}"
                register: d_uuid
              - name: Persist
                mount:
                  path: "{{ base_mount_path }}/{{ item }}"
                  src: "UUID={{ d_uuid.stdout }}"
                  fstype: xfs
                  opts: defaults,nofail
                  state: mounted
          loop: "{{ new_disks }}"
      when: new_disks | length > 0

    - name: Step 1 - Patching
      package: name="*" state=latest

    - name: Step 4 - Reboot Verification
      reboot: reboot_timeout=300
