---
- name: Universal Windows Pre-Patch Discovery
  hosts: all  # Using 'all' for maximum flexibility across 200 servers [cite: 2025-12-24]
  gather_facts: yes

  tasks:
    - name: Search for ALL Missing Updates
      ansible.windows.win_updates:
        state: searched
        # Removing category_names makes it search for everything available
      register: win_update_results

    - name: Check for Pending Reboot (Universal Registry Check)
      ansible.windows.win_shell: |
        $regPath = "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Component Based Servicing\RebootPending"
        if (Test-Path $regPath) { return "True" } else { return "False" }
      register: win_reboot_check

    - name: Final Discovery Report
      debug:
        msg:
          - "------------------------------------------------"
          - "SERVER: {{ inventory_hostname }}"
          - "OS: {{ ansible_distribution }} {{ ansible_distribution_version }}"
          - "PATCHES AVAILABLE: {{ 'YES' if win_update_results.found_update_count > 0 else 'NO' }}"
          - "TOTAL COUNT: {{ win_update_results.found_update_count }}"
          - "REBOOT PENDING: {{ 'YES' if win_reboot_check.stdout == 'True' else 'NO' }}"
          - "------------------------------------------------"
          - "LIST OF PENDING UPDATES:"
          - "{{ win_update_results.updates | dict2items | map(attribute='value.title') | list if win_update_results.found_update_count > 0 else 'No Updates Pending' }}"
          - "------------------------------------------------"
