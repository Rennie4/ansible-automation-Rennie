---
- name: AWS Infrastructure - Create and Attach Volume
  hosts: localhost
  connection: local
  gather_facts: false
  vars:
    # These variables are populated by your AAP Survey
    instance_id: "{{ target_instance_id }}"
    region: "eu-west-1"
    az: "{{ target_az }}"
    volume_size: "{{ target_volume_size }}"
    device_name: "/dev/xvdf"

  tasks:
    - name: Create EBS Volume
      amazon.aws.ec2_vol:
        region: "{{ region }}"
        zone: "{{ az }}"
        volume_size: "{{ volume_size }}"
        volume_type: gp3
      register: new_vol_info

    - name: Attach Volume to Windows Instance
      amazon.aws.ec2_vol:
        region: "{{ region }}"
        instance: "{{ instance_id }}"
        id: "{{ new_vol_info.volume_id }}"
        device_name: "{{ device_name }}"

- name: Windows Configuration - Dynamic Disk Setup
  hosts: windows_hosts
  gather_facts: false
  tasks:
    - name: Force Windows to rescan for new hardware
      win_shell: |
        "rescan" | diskpart
        Update-HostStorageCache
      register: rescan_out

    - name: Find next available drive letter and format disk
      win_shell: |
        # 1. Find the first available letter starting from E (ASCII 69)
        $NextLetter = 69..90 | ForEach-Object { [char]$_ } | Where-Object { 
            (Get-PSDrive -Name $_ -ErrorAction SilentlyContinue) -eq $null 
        } | Select-Object -First 1
        
        # 2. Find the new disk (the one that is currently Offline/Uninitialized)
        $disk = Get-Disk | Where-Object { $_.OperationalStatus -eq 'Offline' -or $_.PartitionStyle -eq 'Raw' } | Select-Object -First 1
        
        if ($disk) {
            $disk | Initialize-Disk -PartitionStyle GPT -PassThru | 
            New-Partition -UseMaximumSize -DriveLetter $NextLetter | 
            Format-Volume -FileSystem NTFS -NewFileSystemLabel "DataVolume" -Confirm:$false
            echo "Successfully assigned $NextLetter"
        } else {
            Write-Error "No uninitialized disk found. It might already be online."
        }
      register: disk_out

    - name: Final Disk Summary
      debug:
        msg: 
          - "Rescan Status: Completed"
          - "Result: {{ disk_out.stdout | default('Disk already initialized or not found') }}"
