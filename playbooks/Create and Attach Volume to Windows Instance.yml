---
- name: AWS Infrastructure - Create and Attach Volume
  hosts: localhost
  connection: local
  gather_facts: false
  vars:
    instance_id: "{{ target_instance_id }}"
    region: "eu-west-1"
    az: "{{ target_az }}"
    volume_size: "{{ target_volume_size }}"
    device_name: "/dev/xvdf"

  tasks:
    - name: Create EBS Volume
      amazon.aws.ec2_vol:
        region: "{{ region }}"
        zone: "{{ az }}"
        volume_size: "{{ volume_size }}"
        volume_type: gp3
      register: new_vol_info

    - name: Attach Volume to Windows Instance
      amazon.aws.ec2_vol:
        region: "{{ region }}"
        instance: "{{ instance_id }}"
        id: "{{ new_vol_info.volume_id }}"
        device_name: "{{ device_name }}"

- name: Windows Configuration - Dynamic Disk Setup
  hosts: windows_hosts
  gather_facts: false
  tasks:
    - name: Force Windows to detect and format new hardware
      win_shell: |
        # 1. Force a deeper storage refresh for NVMe
        Update-HostStorageCache
        Get-StorageSubSystem | Reset-StorageSubSystem
        
        # 2. Find the first available letter starting from E
        $NextLetter = 69..90 | ForEach-Object { [char]$_ } | Where-Object { 
            (Get-PSDrive -Name $_ -ErrorAction SilentlyContinue) -eq $null 
        } | Select-Object -First 1
        
        # 3. Target any disk that is NOT Disk 0 and is currently Offline or Raw
        $disk = Get-Disk | Where-Object { $_.Number -ne 0 -and ($_.NumberOfPartitions -eq 0 -or $_.OperationalStatus -eq 'Offline') } | Select-Object -First 1
        
        if ($disk) {
            # Clear read-only attributes and bring online
            $disk | Set-Disk -IsOffline $false -IsReadOnly $false
            $disk | Initialize-Disk -PartitionStyle GPT -PassThru | 
            New-Partition -UseMaximumSize -DriveLetter $NextLetter | 
            Format-Volume -FileSystem NTFS -NewFileSystemLabel "DataVolume" -Confirm:$false
            Write-Host "Successfully assigned $NextLetter"
        } else {
            Write-Error "Windows still does not see the new hardware."
        }
      register: disk_out

    - name: Confirm Assignment
      debug:
        msg: "{{ disk_out.stdout }}"
