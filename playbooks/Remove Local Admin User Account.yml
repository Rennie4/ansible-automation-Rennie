---
- name: Complete Purge of User and Profile (No Collection Needed)
  hosts: "{{ target_hosts | default('all') }}"
  gather_facts: no
  vars:
    # List any accounts here that you want to completely vanish
    accounts_to_remove:
      - "test"
      - "admin-test"

  tasks:
    - name: Delete the local user account from SAM database
      ansible.windows.win_user:
        name: "{{ item }}"
        state: absent
      loop: "{{ accounts_to_remove }}"
      register: user_removal

    - name: Forcefully remove the C:\Users folder for these accounts
      ansible.windows.win_shell: |
        $UserPath = "C:\Users\{{ item }}"
        if (Test-Path $UserPath) {
            # Take ownership and remove recursively
            Remove-Item -Path $UserPath -Recurse -Force
            Write-Output "Deleted profile folder for {{ item }}"
        } else {
            Write-Output "No profile folder found for {{ item }}"
        }
      loop: "{{ accounts_to_remove }}"
      # We only try to delete the folder if the user was successfully removed or didn't exist
      ignore_errors: yes

    - name: Summary of Cleanup Results
      ansible.builtin.debug:
        msg: "Cleaned up: {{ item.item }}"
      loop: "{{ user_removal.results }}"
      when: item.changed or item.state == 'absent'
