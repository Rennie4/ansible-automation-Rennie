---
- name: Complete Purge of User and Profile (No Collection Needed)
  hosts: windows_server
  gather_facts: no
  vars:
    # Add or remove users from this list as needed
    users_to_purge:
      - test
      - admin-test

  tasks:
    - name: Delete the local user account from SAM database
      ansible.windows.win_user:
        name: "{{ item }}"
        state: absent
      loop: "{{ users_to_purge }}"

    - name: Remove User Profile Registry Keys (Prevents Temp Profile Errors)
      ansible.windows.win_shell: |
        $UserList = @("{{ users_to_purge | join('","') }}")
        $ProfileList = "HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\ProfileList"
        
        Get-ChildItem -Path $ProfileList | ForEach-Object {
            $Path = Get-ItemProperty -Path $_.PSPath
            foreach ($User in $UserList) {
                if ($Path.ProfileImagePath -like "*\$User") {
                    Remove-Item -Path $_.PSPath -Recurse -Force
                    Write-Output "Deleted Registry Profile for $User"
                }
            }
        }
      register: reg_cleanup
      changed_when: "'Deleted Registry Profile' in reg_cleanup.stdout"

    - name: Forcefully remove the C:\Users folder
      ansible.windows.win_file:
        path: "C:\\Users\\{{ item }}"
        state: absent
      loop: "{{ users_to_purge }}"

    - name: Summary of Cleanup Results
      ansible.builtin.debug:
        msg: "Cleaned up: {{ item }}"
      loop: "{{ users_to_purge }}"
