---
- name: Complete Purge of User and Profile (No Collection Needed)
  hosts: windows_server
  gather_facts: no
  vars:
    # List the users you want to purge here
    users_to_purge:
      - test
      - admin-test

  tasks:
    - name: Delete the local user account from SAM database
      ansible.windows.win_user:
        name: "{{ item }}"
        state: absent
      loop: "{{ users_to_purge }}"

    - name: Remove User Profile Registry Keys (Prevents Temp Profile Errors)
      ansible.windows.win_shell: |
        $users = @("{{ users_to_purge | join('","') }}")
        foreach ($user in $users) {
            $objUser = New-Object System.Security.Principal.NTAccount($user)
            try {
                $sid = $objUser.Translate([System.Security.Principal.SecurityIdentifier]).Value
                $registryPath = "HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\ProfileList\$sid"
                if (Test-Path $registryPath) {
                    Remove-Item -Path $registryPath -Recurse -Force
                }
            } catch {
                # User SID not found, likely already deleted
                Write-Output "SID for $user not found, skipping registry cleanup."
            }
        }
      register: reg_cleanup

    - name: Forcefully remove the C:\Users folder
      ansible.windows.win_file:
        path: "C:\\Users\\{{ item }}"
        state: absent
      loop: "{{ users_to_purge }}"

    - name: Summary of Cleanup Results
      ansible.builtin.debug:
        msg: "Cleaned up: {{ item }}"
      loop: "{{ users_to_purge }}"
