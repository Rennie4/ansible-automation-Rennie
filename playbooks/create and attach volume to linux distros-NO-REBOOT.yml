---
# PLAY 1: AWS Side - Create/Attach and Identify Target
- name: Create and Attach EBS Volume via Survey
  hosts: localhost
  connection: local
  gather_facts: no
  vars:
    # Supports up to 21 additional drives (f through z)
    possible_devices: [
      "/dev/sdf", "/dev/sdg", "/dev/sdh", "/dev/sdi", "/dev/sdj",
      "/dev/sdk", "/dev/sdl", "/dev/sdm", "/dev/sdn", "/dev/sdo",
      "/dev/sdp", "/dev/sdq", "/dev/sdr", "/dev/sds", "/dev/sdt",
      "/dev/sdu", "/dev/sdv", "/dev/sdw", "/dev/sdx", "/dev/sdy", "/dev/sdz"
    ]

  tasks:
    - name: Get Current Instance Info
      amazon.aws.ec2_instance_info:
        instance_ids: ["{{ target_instance_id }}"]
        region: "eu-west-1"
      register: instance_details

    - name: Smart IP Selection
      set_fact:
        # Uses Public IP if it exists; otherwise falls back to Private IP
        target_ip: "{{ instance_details.instances[0].public_ip_address | default(instance_details.instances[0].private_ip_address) }}"

    - name: PRE-FLIGHT CHECK | Verify SSH Reachability
      wait_for:
        host: "{{ target_ip }}"
        port: 22
        timeout: 10
        msg: "ERROR: Cannot reach {{ target_ip }} on port 22. Check Security Groups/VPN!"

    - name: Find Next Open AWS Slot
      set_fact:
        next_device: "{{ (possible_devices | difference(instance_details.instances[0].block_device_mappings | map(attribute='device_name') | list)) | first | default('NONE') }}"

    - name: Create and Attach Volume
      amazon.aws.ec2_vol:
        instance: "{{ target_instance_id }}" 
        volume_size: "{{ target_vol_size }}" 
        zone: "{{ target_zone }}" 
        region: "eu-west-1"
        device_name: "{{ next_device }}"
        state: present
      register: ec2_vol_result
      when: next_device != 'NONE'

    - name: Add Target to Temporary Group
      add_host:
        name: "{{ target_ip }}"
        groups: targeted_server
        ansible_user: "ubuntu"  # Adjust if using ec2-user or root

# PLAY 2: Linux Side - Targeted Provisioning (No Reboot / No Patching)
- name: Universal Linux Storage Extension
  hosts: targeted_server
  become: yes
  gather_facts: yes

  tasks:
    - name: Linux | Hardware Scan
      shell: "for dev in /sys/class/scsi_host/host*/scan; do echo '- - -' > $dev; done; udevadm settle"
      ignore_errors: yes
      changed_when: false

    - name: Linux | Identify New Unformatted Disks
      set_fact:
        # Excludes OS drive variants [cite: 2025-12-24]
        new_disks: "{{ ansible_facts.devices | dict2items | 
                       rejectattr('key', 'match', '^(loop|sda|vda|xvda|nvme0n1)') | 
                       selectattr('value.partitions', 'equalto', {}) | 
                       map(attribute='key') | list }}"

    - name: Linux | Provision Disks
      block:
        - name: Linux | Create Mount Folders
          file:
            path: "/data/{{ item }}"
            state: directory
            mode: '0755'
          loop: "{{ new_disks }}"

        - name: Linux | Create XFS Filesystem
          filesystem:
            fstype: xfs
            dev: "/dev/{{ item }}"
          loop: "{{ new_disks }}"

        - name: Linux | Get UUIDs
          command: "blkid -s UUID -o value /dev/{{ item }}"
          register: disk_uuids
          loop: "{{ new_disks }}"
          changed_when: false

        - name: Linux | Persist and Mount
          mount:
            path: "/data/{{ item.item }}"
            src: "UUID={{ item.stdout }}"
            fstype: xfs
            opts: defaults,nofail
            state: mounted
          loop: "{{ disk_uuids.results }}"
      when: new_disks | length > 0

    - name: Final Output | Get Report
      shell: "lsblk -o NAME,SIZE,MOUNTPOINT | grep -v loop"
      register: storage_report
      changed_when: false

    - name: Final Output | Report Summary
      debug:
        msg: 
          - "REPORT FOR: {{ inventory_hostname }}"
          - "TARGETED IP TYPE: {{ 'Public' if (inventory_hostname == hostvars['localhost']['instance_details']['instances'][0]['public_ip_address'] | default('')) else 'Private' }}"
          - "STORAGE DETAILS:"
          - "{{ storage_report.stdout_lines }}"
