---
# ONE PLAY: Targeted directly at the server from your survey
- name: Universal Storage Provisioning
  hosts: "{{ target_instance_ip }}"  # Enter the IP in your survey or pass it via extra_vars
  become: yes
  gather_facts: yes

  tasks:
    # --- AWS SECTION (Delegated to localhost) ---
    - name: AWS | Get Current Instance Info
      amazon.aws.ec2_instance_info:
        instance_ids: ["{{ target_instance_id }}"]
        region: "eu-west-1"
      register: instance_details
      delegate_to: localhost
      run_once: true

    - name: AWS | Find Next Open Slot
      set_fact:
        possible_devices: [
          "/dev/sdf", "/dev/sdg", "/dev/sdh", "/dev/sdi", "/dev/sdj",
          "/dev/sdk", "/dev/sdl", "/dev/sdm", "/dev/sdn", "/dev/sdo",
          "/dev/sdp", "/dev/sdq", "/dev/sdr", "/dev/sds", "/dev/sdt",
          "/dev/sdu", "/dev/sdv", "/dev/sdw", "/dev/sdx", "/dev/sdy", "/dev/sdz"
        ]
      delegate_to: localhost

    - name: AWS | Calculate Device Name
      set_fact:
        next_device: "{{ (possible_devices | difference(instance_details.instances[0].block_device_mappings | map(attribute='device_name') | list)) | first | default('NONE') }}"
      delegate_to: localhost

    - name: AWS | Create and Attach Volume
      amazon.aws.ec2_vol:
        instance: "{{ target_instance_id }}"
        volume_size: "{{ target_vol_size }}"
        zone: "{{ target_zone }}"
        region: "eu-west-1"
        device_name: "{{ next_device }}"
        state: present
      register: ec2_vol_result
      delegate_to: localhost
      when: next_device != 'NONE'

    # --- LINUX SECTION (Runs on the target server) ---
    - name: Linux | Hardware Scan
      shell: "for dev in /sys/class/scsi_host/host*/scan; do echo '- - -' > $dev; done; udevadm settle"
      ignore_errors: yes
      changed_when: false

    - name: Linux | Identify New Unformatted Disks
      set_fact:
        new_disks: "{{ ansible_facts.devices | dict2items | 
                       rejectattr('key', 'match', '^(loop|sda|vda|xvda|nvme0n1)') | 
                       selectattr('value.partitions', 'equalto', {}) | 
                       map(attribute='key') | list }}"

    - name: Linux | Provision Disks
      block:
        - name: Linux | Create Mount Folders
          file:
            path: "/data/{{ item }}"
            state: directory
            mode: '0755'
          loop: "{{ new_disks }}"

        - name: Linux | Create XFS Filesystem
          filesystem:
            fstype: xfs
            dev: "/dev/{{ item }}"
          loop: "{{ new_disks }}"

        - name: Linux | Get UUIDs
          command: "blkid -s UUID -o value /dev/{{ item }}"
          register: disk_uuids
          loop: "{{ new_disks }}"
          changed_when: false

        - name: Linux | Persist and Mount
          mount:
            path: "/data/{{ item.item }}"
            src: "UUID={{ item.stdout }}"
            fstype: xfs
            opts: defaults,nofail
            state: mounted
          loop: "{{ disk_uuids.results }}"
      when: new_disks | length > 0

    - name: Final Output | Get Report
      shell: "lsblk -o NAME,SIZE,MOUNTPOINT | grep -v loop"
      register: storage_report
      changed_when: false

    - name: Final Output | Report Summary
      debug:
        msg: 
          - "REPORT FOR: {{ inventory_hostname }}"
          - "STORAGE DETAILS:"
          - "{{ storage_report.stdout_lines }}"
