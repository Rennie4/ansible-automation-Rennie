---
- name: Pre-Patch Discovery Report
  hosts: linux_hosts
  become: yes
  gather_facts: yes

  tasks:
    # --- Ubuntu/Debian Update Check ---
    - name: Ubuntu/Debian - Count Upgradable Packages
      shell: "apt list --upgradable 2>/dev/null | grep -v 'Listing...' | wc -l"
      register: ubuntu_count
      changed_when: false
      when: ansible_os_family == "Debian"

    # --- RedHat/Amazon Linux Update Check ---
    - name: RedHat/Amazon Linux - Count Updates
      shell: "dnf check-update --quiet | grep -v '^$' | wc -l"
      register: redhat_count
      failed_when: false
      changed_when: false
      when: ansible_os_family == "RedHat"

    # --- Universal Reboot Checks ---
    - name: Check Reboot Required (Ubuntu/Debian)
      stat:
        path: /var/run/reboot-required
      register: ubuntu_reboot
      when: ansible_os_family == "Debian"

    - name: Check Reboot Required (RedHat/Amazon Linux)
      command: needs-restarting -r
      register: redhat_reboot
      failed_when: false
      changed_when: false
      when: ansible_os_family == "RedHat"

    # --- The Final Truth Report ---
    - name: Final Discovery Report
      debug:
        msg:
          - "------------------------------------------------"
          - "SERVER: {{ inventory_hostname }}"
          - "OS: {{ ansible_distribution }} {{ ansible_distribution_version }}"
          - "PATCHES AVAILABLE: {{ 'YES' if ((ubuntu_count.stdout | default('0') | int > 0) or (redhat_count.stdout | default('0') | int > 0)) else 'NO' }}"
          - "REBOOT PENDING: {{ 'YES' if ((ubuntu_reboot.stat is defined and ubuntu_reboot.stat.exists) or (redhat_reboot.rc is defined and redhat_reboot.rc != 0)) else 'NO' }}"
          - "------------------------------------------------"
