---
- name: Windows Server 2025 Account Policy Baseline
  hosts: windows_server_2025
  gather_facts: yes
  vars:
    s3_bucket_name: "oml-s3-automation-sandbox"
    s3_region: "eu-west-1"
    # Dynamic filename prevents hard-coded values and conflicts
    report_filename: "Account_Policy_Comparison_{{ ansible_date_time.iso8601_basic_short }}.html"

  tasks:
    - name: Audit "Before" State
      win_shell: &audit_logic |
        $netAccounts = net accounts
        $threshold = ($netAccounts | Select-String "Lockout threshold").ToString().Split(':')[1].Trim()
        $duration = ($netAccounts | Select-String "Lockout duration").ToString().Split(':')[1].Trim()
        $window = ($netAccounts | Select-String "Lockout observation window").ToString().Split(':')[1].Trim()

        $tempFile = "C:\Windows\Temp\secedit_audit.inf"
        secedit /export /cfg $tempFile /areas SECURITYPOLICY | Out-Null
        $policy = Get-Content $tempFile
        Remove-Item $tempFile

        function Get-Val($key) {
            $line = $policy | Select-String "^$key\s*="
            if ($line) { return $line.ToString().Split('=')[1].Trim() }
            return "0"
        }

        $regPath = "HKLM:\SYSTEM\CurrentControlSet\Control\Lsa\MSV1_0"
        $regValue = (Get-ItemProperty -Path $regPath -Name "AllowAdminLockout" -ErrorAction SilentlyContinue).AllowAdminLockout
        $adminStatus = if ($regValue -eq 1 -or ($threshold -ne "0" -and $threshold -ne "Never")) { "Enabled (1)" } else { "Disabled (0)" }

        @{
            PasswordHistoryCount     = Get-Val "PasswordHistorySize"
            MaximumPasswordAge       = Get-Val "MaximumPasswordAge"
            MinimumPasswordAge       = Get-Val "MinimumPasswordAge"
            MinimumPasswordLength    = Get-Val "MinimumPasswordLength"
            PasswordComplexity       = Get-Val "PasswordComplexity"
            ReversibleEncryption     = Get-Val "ClearTextPassword"
            LockoutDuration          = $duration
            LockoutThreshold         = $threshold
            ResetLockoutCounter      = $window
            AllowAdminLockout        = $adminStatus
            OsName                   = (Get-ComputerInfo).OsName
        } | ConvertTo-Json
      register: before_audit

    # --- PLACE HARDENING TASKS HERE ---
    # This ensures the "After" audit reflects your actual changes.

    - name: Audit "After" State
      win_shell: *audit_logic
      register: after_audit

    - name: Ensure Local Report Directory Exists
      delegate_to: localhost
      file:
        path: "{{ playbook_dir }}/reports"
        state: directory

    - name: Generate the Comparison Report
      delegate_to: localhost
      template:
        src: "{{ playbook_dir }}/../templates/Scan and Report Windows 2025-Account Policy Baseline.j2"
        dest: "{{ playbook_dir }}/reports/{{ report_filename }}"
      vars:
        before: "{{ before_audit.stdout | from_json }}"
        after: "{{ after_audit.stdout | from_json }}"

    - name: Upload Report to S3
      delegate_to: localhost
      amazon.aws.s3_object:
        bucket: "{{ s3_bucket_name }}"
        object: "cis-baseline-files/{{ report_filename }}"
        src: "{{ playbook_dir }}/reports/{{ report_filename }}"
        mode: put
        region: "{{ s3_region }}"
      register: s3_upload
