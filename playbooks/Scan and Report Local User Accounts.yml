---
- name: Scan and Report Local User Accounts
  hosts: windows_server
  gather_facts: no
  vars:
    # List of built-in accounts to ignore in the report
    system_accounts:
      - "Administrator"
      - "Guest"
      - "DefaultAccount"
      - "WDAGUtilityAccount"
    report_path: "C:\\AuditReports"

  tasks:
    - name: Get list of all local users
      ansible.windows.win_shell: |
        Get-LocalUser | Select-Object -ExpandProperty Name
      register: local_users_raw

    - name: Filter and format user list
      ansible.builtin.set_fact:
        detected_users: "{{ local_users_raw.stdout_lines | difference(system_accounts) }}"

    - name: Ensure report directory exists
      ansible.windows.win_file:
        path: "{{ report_path }}"
        state: directory

    - name: Summary of Detected Local Accounts
      ansible.builtin.debug:
        msg: |
          SCAN COMPLETE
          ----------------------------------------
          Total Custom Users Found: {{ detected_users | length }}
          User List: {{ detected_users if detected_users | length > 0 else 'None' }}
          ----------------------------------------

    - name: Save report to local file
      ansible.windows.win_copy:
        content: |
          Inventory Report for {{ inventory_hostname }}
          Total Custom Users: {{ detected_users | length }}
          Detected Users: {{ detected_users | join(', ') if detected_users | length > 0 else 'None' }}
        dest: "{{ report_path }}\\user_audit.txt"
