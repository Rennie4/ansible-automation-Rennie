---
- name: Universal Linux Patching with Dynamic Storage Verification
  hosts: all
  become: yes
  gather_facts: yes

  vars:
    monitored_volumes:
      - { size: '10', id: 'cfec' }

  tasks:
    - name: Step 1 - Debian/Ubuntu - Update Cache and Full Upgrade
      apt:
        update_cache: yes
        upgrade: full  # 'full' is more aggressive than 'dist' for Ubuntu 24.04
        cache_valid_time: 3600
      when: ansible_os_family == "Debian"
      register: apt_result

    - name: Step 2 - RedHat/Amazon Linux - Update All
      dnf:
        name: "*"
        state: latest
      when: ansible_os_family == "RedHat"
      register: dnf_result

    - name: Step 3 - Check if Reboot is Required (Ubuntu)
      stat:
        path: /var/run/reboot-required
      register: ubuntu_reboot_flag
      when: ansible_os_family == "Debian"

    - name: Step 4 - Force Reboot for Storage Verification
      reboot:
        msg: "Forcing reboot to verify 10GB volume persistence and apply all updates"
        reboot_timeout: 300
      # This will now reboot if patches were found OR if we just want to test the mount
      when: >
        (ubuntu_reboot_flag.stat is defined and ubuntu_reboot_flag.stat.exists) or
        (apt_result.changed | default(false)) or
        (ansible_os_family == "Debian") 

    - name: Step 5 - Verify Storage Mounts are Active
      command: "mountpoint /mnt/storage_{{ item.size }}gb_{{ item.id }}"
      loop: "{{ monitored_volumes }}"
      register: mount_results
      changed_when: false
      failed_when: mount_results.rc != 0

    - name: Final Health Report
      debug:
        msg: 
          - "------------------------------------------------"
          - "SERVER: {{ inventory_hostname }}"
          - "PATCHING STATUS: Complete"
          - "STORAGE STATUS: Verified and Mounted"
          - "VOLUME CHECKED: /mnt/storage_{{ item.item.size }}gb_{{ item.item.id }}"
          - "------------------------------------------------"
      loop: "{{ mount_results.results }}"
      loop_control:
        label: "{{ item.item.id }}"
