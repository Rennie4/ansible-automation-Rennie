---
- name: Universal Linux Patching with Infinite Storage Persistence
  hosts: all
  become: yes
  gather_facts: yes

  tasks:
    - name: Step 0.1 - Discover all attached EBS volumes
      find:
        paths: /dev/disk/by-id/
        patterns: "nvme-Amazon_Elastic_Block_Store_vol*"
      register: found_disks
      when: ansible_os_family == "Debian"

    - name: Step 0.2 - Ensure Mount Points and fstab entries exist
      ansible.posix.mount:
        # This extracts the last 4 characters of the ID for the folder name
        path: "/mnt/storage_ebs_{{ item.path | last_chars(4) }}"
        src: "{{ item.path }}"
        fstype: ext4
        state: mounted  # This 'mounts' now AND adds to 'fstab' for reboots
      loop: "{{ found_disks.files }}"
      when: ansible_os_family == "Debian"

    - name: Step 1 - Debian/Ubuntu - Update Cache and Full Upgrade
      apt:
        update_cache: yes
        upgrade: full
      when: ansible_os_family == "Debian"
      register: apt_result

    - name: Step 4 - Force Reboot for Storage Verification
      reboot:
        msg: "Verifying persistence for all discovered drives."
        reboot_timeout: 300
      when: ansible_os_family == "Debian" 

    - name: Step 5 - Verify All Mounts are active after Reboot
      command: "mountpoint /mnt/storage_ebs_{{ item.path | last_chars(4) }}"
      loop: "{{ found_disks.files }}"
      register: mount_results
      changed_when: false
      failed_when: mount_results.rc != 0
