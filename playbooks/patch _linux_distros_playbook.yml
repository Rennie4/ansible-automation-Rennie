---
- name: Universal Linux Patching with Storage Persistence
  hosts: linux_hosts
  become: yes
  gather_facts: yes

  tasks:
    # --- STEP 1: PRE-PATCH STORAGE PERSISTENCE ---
    - name: Discover all attached EBS volumes
      find:
        paths: /dev/disk/by-id/
        patterns: "nvme-Amazon_Elastic_Block_Store_vol*"
      register: found_disks

    - name: Ensure Mount Points and fstab entries exist (Safe Mode)
      ansible.posix.mount:
        # Uses Python slicing [-4:] to get the last 4 characters of the disk ID
        path: "/mnt/storage_ebs_{{ item.path[-4:] }}"
        src: "{{ item.path }}"
        fstype: ext4
        opts: defaults,nofail  # CRITICAL: prevents maintenance mode on boot failure
        state: mounted
      loop: "{{ found_disks.files | default([]) }}"

    # --- STEP 2: PATCHING ---
    - name: Patch Debian/Ubuntu Distros
      apt:
        update_cache: yes
        upgrade: dist
        autoremove: yes
      when: ansible_os_family == "Debian"
      register: apt_res

    - name: Patch RedHat/Amazon Linux Distros
      dnf:
        name: "*"
        state: latest
        update_cache: yes
      when: ansible_os_family == "RedHat"
      register: dnf_res

    # --- STEP 3: REBOOT & VERIFY ---
    - name: Reboot if updates were applied
      reboot:
        msg: "Rebooting after patching to verify storage persistence."
        reboot_timeout: 300
      when: (apt_res is changed) or (dnf_res is changed)

    - name: Verify All Mounts are active after Reboot
      command: "mountpoint /mnt/storage_ebs_{{ item.path[-4:] }}"
      loop: "{{ found_disks.files | default([]) }}"
      register: mount_results
      changed_when: false
      failed_when: mount_results.rc != 0
