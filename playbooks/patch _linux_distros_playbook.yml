---
- name: Universal Linux Patching with Storage Persistence
  hosts: linux_hosts
  become: yes
  gather_facts: yes

  tasks:
    # --- PHASE 1: DYNAMIC STORAGE DISCOVERY & PERSISTENCE ---
    # This step finds volumes automatically without hardcoded values.
    - name: Discover all attached EBS volumes
      find:
        paths: /dev/disk/by-id/
        patterns: "nvme-Amazon_Elastic_Block_Store_vol*"
      register: found_disks

    - name: Ensure Mount Points and fstab entries exist (Safe Mode)
      ansible.posix.mount:
        # Dynamically names the mount point using the last 4 chars of the ID
        path: "/mnt/storage_ebs_{{ item.path[-4:] }}"
        src: "{{ item.path }}"
        fstype: ext4
        # 'nofail' ensures the server boots even if a volume is missing/changed
        opts: defaults,nofail  
        state: mounted
      loop: "{{ found_disks.files | default([]) }}"

    # --- PHASE 2: DISTRIBUTION-AWARE PATCHING ---
    - name: Patch Debian/Ubuntu Distros
      apt:
        update_cache: yes
        upgrade: dist
        autoremove: yes
      when: ansible_os_family == "Debian"
      register: apt_res

    - name: Patch RedHat/Amazon Linux Distros
      dnf:
        name: "*"
        state: latest
        update_cache: yes
      when: ansible_os_family == "RedHat"
      register: dnf_res

    # --- PHASE 3: REBOOT & VERIFICATION ---
    - name: Reboot if updates were applied
      reboot:
        msg: "Rebooting after patching to verify storage persistence."
        reboot_timeout: 300
      # Uses 'default(false)' to prevent errors when variables are missing
      when: >
        (apt_res is changed | default(false)) or 
        (dnf_res is changed | default(false))

    - name: Post-Reboot Verification of Storage
      command: "mountpoint /mnt/storage_ebs_{{ item.path[-4:] }}"
      loop: "{{ found_disks.files | default([]) }}"
      register: mount_results
      changed_when: false
      failed_when: mount_results.rc != 0
