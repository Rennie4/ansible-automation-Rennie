---
- name: Pre-Hardening Audit - Account and Password Policies
  hosts: all
  gather_facts: yes
  vars:
    # Target values from your CIS PDF
    cis_targets:
      PasswordHistorySize: "24"
      MaximumPasswordAge: "365"
      MinimumPasswordAge: "1"
      MinimumPasswordLength: "14"
      PasswordComplexity: "1"
      ClearTextPassword: "0"
      LockoutDuration: "15"
      LockoutBadCount: "10"
      ResetLockoutCount: "15"

  tasks:
    - name: Export Current Security Policy via Secedit
      ansible.windows.win_shell: |
        $tempFile = "C:\Windows\Temp\secexport.inf"
        secedit /export /cfg $tempFile /areas SECURITYPOLICY
        $content = Get-Content $tempFile
        $policy = @{}
        foreach ($line in $content) {
            if ($line -match "=") {
                $kv = $line -split "="
                $policy[$kv[0].Trim()] = $kv[1].Trim()
            }
        }
        $policy | ConvertTo-Json
      register: secedit_raw

    - name: Audit Security Registry Keys (Admin Lockout & Length)
      ansible.windows.win_reg_stat:
        path: "{{ item.path }}"
        name: "{{ item.name }}"
      loop:
        - { id: "1.6", name: "RelaxMinimumPasswordLengthLimits", path: "HKLM:\System\CurrentControlSet\Control\SAM", target: "1" }
        - { id: "1.10", name: "AllowAdministratorLockout", path: "HKLM:\SYSTEM\CurrentControlSet\Control\Lsa", target: "1" }
      register: reg_audit

    - name: Consolidate Audit Findings
      set_fact:
        current_policy: "{{ secedit_raw.stdout | from_json }}"
        audit_results: []

    - name: Build Comparison List
      set_fact:
        audit_results: >-
          {% set results = [] %}
          {% set p = current_policy %}
          {% do results.append({'id': '1.1', 'name': 'Password History', 'current': p.PasswordHistorySize | default('0'), 'target': cis_targets.PasswordHistorySize}) %}
          {% do results.append({'id': '1.2', 'name': 'Max Password Age', 'current': p.MaximumPasswordAge | default('0'), 'target': cis_targets.MaximumPasswordAge}) %}
          {% do results.append({'id': '1.4', 'name': 'Min Password Length', 'current': p.MinimumPasswordLength | default('0'), 'target': cis_targets.MinimumPasswordLength}) %}
          {% do results.append({'id': '1.9', 'name': 'Lockout Threshold', 'current': p.LockoutBadCount | default('0'), 'target': cis_targets.LockoutBadCount}) %}
          {% for r in reg_audit.results %}
            {% do results.append({'id': r.item.id, 'name': r.item.name, 'current': (r.value | string if r.exists else '0'), 'target': r.item.target}) %}
          {% endfor %}
          {{ results }}

    - name: Generate Comparison Report
      delegate_to: localhost
      become: false
      ansible.builtin.template:
        src: "../templates/pre_hardening_comparison.j2"
        dest: "/tmp/reports/Pre_Hardening_{{ inventory_hostname }}.html"

    - name: Upload to S3
      delegate_to: localhost
      become: false
      amazon.aws.s3_object:
        bucket: "oml-s3-automation-sandbox"
        object: "cis-baseline-files/Pre_Hardening_{{ inventory_hostname }}.html"
        src: "/tmp/reports/Pre_Hardening_{{ inventory_hostname }}.html"
        mode: put
        region: "eu-west-1"
