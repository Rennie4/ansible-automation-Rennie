---
- name: Scan Windows 2025 Advanced Audit Policy Configuration Baseline
  hosts: all
  gather_facts: yes
  vars:
    s3_bucket: "oml-s3-automation-sandbox"
    s3_path: "cis-baseline-files"
    aws_region: "eu-west-1"
    report_dir: "/tmp/reports"
    # Points to the correct template folder in your project
    template_src: "{{ playbook_dir }}/../templates/baseline-Advanced Audit Policy Configuration_report.j2"

  tasks:
    - name: Export Full Advanced Audit Policy Categories
      ansible.windows.win_shell: |
        try {
            $raw = auditpol /get /category:* /r
            if ($null -eq $raw -or $raw.Count -lt 2) { return "[]" }

            $results = $raw | ConvertFrom-Csv | Where-Object { $_.Category -and $_.Subcategory } | ForEach-Object {
                [PSCustomObject]@{
                    Category    = $_.Category.Trim()
                    Subcategory = $_.Subcategory.Trim()
                    Setting     = if ($_.Setting -eq "No Auditing") { "Not Configured" } else { $_.Setting.Trim() }
                }
            }
            if ($results) { 
                $results | ConvertTo-Json -Compress 
            } else { 
                "[]" 
            }
        } catch { 
            "[]" 
        }
      register: full_audit_raw

    - name: Parse JSON into scan_results
      set_fact:
        # Explicitly casting the string to a list to prevent "No Data" errors
        scan_results: "{{ full_audit_raw.stdout | from_json }}"

    - name: Ensure Local Report Directory Exists
      delegate_to: localhost
      become: false
      ansible.builtin.file:
        path: "{{ report_dir }}"
        state: directory

    - name: Generate Grouped Advanced Audit Report
      delegate_to: localhost
      become: false
      ansible.builtin.template:
        src: "{{ template_src }}"
        dest: "{{ report_dir }}/Advanced_Audit_{{ inventory_hostname }}.html"

    - name: Upload Advanced Audit Report to S3
      delegate_to: localhost
      become: false
      amazon.aws.s3_object:
        bucket: "{{ s3_bucket }}"
        object: "{{ s3_path }}/Advanced_Audit_{{ inventory_hostname }}.html"
        src: "{{ report_dir }}/Advanced_Audit_{{ inventory_hostname }}.html"
        mode: put
        region: "{{ aws_region }}"
      register: s3_upload
