---
- name: Scan Windows 2025 Advanced Audit Policy Configuration Baseline
  hosts: all
  gather_facts: yes
  vars:
    s3_bucket: "oml-s3-automation-sandbox"
    s3_path: "cis-baseline-files"
    aws_region: "eu-west-1"

  tasks:
    - name: Ensure Remote UAC allows elevation (Workgroup Fix)
      become: yes
      become_method: runas
      become_user: Administrator
      ansible.windows.win_regedit:
        path: HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System
        name: LocalAccountTokenFilterPolicy
        data: 1
        type: dword
        state: present

    - name: Export Full Advanced Audit Policy Categories
      become: yes
      become_method: runas
      become_user: Administrator
      ansible.windows.win_shell: |
        # Use /r to get CSV format for easier parsing
        $raw = auditpol /get /category:* /r
        if ($raw -match "Category,Subcategory") {
            $raw
        } else {
            Write-Error "No data returned or Access Denied"
        }
      register: full_audit_raw

    - name: Ensure Local Report Directory Exists
      delegate_to: localhost
      become: no
      ansible.builtin.file:
        path: "{{ playbook_dir }}/reports"
        state: directory
        mode: '0755'

    - name: Generate Grouped Advanced Audit Report
      delegate_to: localhost
      become: no
      ansible.builtin.template:
        src: "{{ playbook_dir }}/../templates/baseline-Advanced Audit Policy Configuration_report.j2"
        dest: "{{ playbook_dir }}/reports/Advanced_Audit_{{ inventory_hostname }}.html"
      vars:
        # Parsing the CSV output into a list for the template
        scan_results: >-
          {% set results = [] %}
          {% if full_audit_raw.stdout_lines is defined %}
            {% for line in full_audit_raw.stdout_lines %}
              {% if ',' in line and 'Category' not in line %}
                {% set parts = line.split(',') %}
                {% set _ = results.append({
                  'Category': parts[0].strip(),
                  'Subcategory': parts[1].strip(),
                  'Setting': 'Not Configured' if 'No Auditing' in parts[2] else parts[2].strip()
                }) %}
              {% endif %}
            {% endfor %}
          {% endif %}
          {{ results }}

    - name: Upload Advanced Audit Report to S3
      delegate_to: localhost
      become: no
      amazon.aws.s3_object:
        bucket: "{{ s3_bucket }}"
        object: "{{ s3_path }}/Advanced_Audit_{{ ansible_date_time.iso8601_basic_short }}.html"
        src: "{{ playbook_dir }}/reports/Advanced_Audit_{{ inventory_hostname }}.html"
        mode: put
        region: "{{ aws_region }}"
