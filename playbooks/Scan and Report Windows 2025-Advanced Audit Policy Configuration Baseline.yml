---
- name: Scan Windows 2025 Advanced Audit Policy Configuration Baseline
  hosts: all
  gather_facts: yes
  vars:
    s3_bucket: "oml-s3-automation-sandbox"
    s3_path: "cis-baseline-files"
    aws_region: "eu-west-1"
    report_dir: "/tmp/reports"
    # Reusable relative path for the template [cite: 2025-12-22]
    template_src: "{{ playbook_dir }}/../templates/baseline-Advanced Audit Policy Configuration_report.j2"

  tasks:
    - name: Export Full Advanced Audit Policy Categories
      ansible.windows.win_shell: |
        # Explicitly pull all subcategories
        $raw = auditpol /get /subcategory:*
        $results = @()
        $currentCategory = "Advanced Audit"

        $raw -split "`r`n" | ForEach-Object {
            $line = $_.Trim()
            if ($line -and $line -notmatch "---" -and $line -notmatch "Subcategory") {
                # Identify subcategories by leading whitespace in raw output
                if ($_ -match "^\s{2,}") {
                    $parts = $line -split "\s{2,}"
                    if ($parts.Count -ge 2) {
                        $results += [PSCustomObject]@{
                            Category    = $currentCategory
                            Subcategory = $parts[0].Trim()
                            # Maps results to 'Not Configured' to match MMC UI
                            Setting     = if ($parts[1] -match "No Auditing") { "Not Configured" } else { $parts[1].Trim() }
                        }
                    }
                } else {
                    # This line is a Category Header (e.g., Account Logon)
                    $currentCategory = $line
                }
            }
        }
        $results | ConvertTo-Json -Compress
      register: full_audit_raw

    - name: Set Audit Results Fact
      set_fact:
        scan_results: "{{ full_audit_raw.stdout | from_json }}"

    - name: Ensure Local Report Directory
      delegate_to: localhost
      become: false
      ansible.builtin.file:
        path: "{{ report_dir }}"
        state: directory

    - name: Generate Grouped Report
      delegate_to: localhost
      become: false
      ansible.builtin.template:
        src: "{{ template_src }}"
        dest: "{{ report_dir }}/Advanced_Audit_{{ inventory_hostname }}.html"

    - name: Upload to S3 with Unique Name
      delegate_to: localhost
      become: false
      amazon.aws.s3_object:
        bucket: "{{ s3_bucket }}"
        # Unique timestamp ensures no data overwrites [cite: 2025-12-22, 2025-12-24]
        object: "{{ s3_path }}/Advanced_Audit_{{ inventory_hostname }}_{{ ansible_date_time.iso8601_basic_short }}.html"
        src: "{{ report_dir }}/Advanced_Audit_{{ inventory_hostname }}.html"
        mode: put
        region: "{{ aws_region }}"
