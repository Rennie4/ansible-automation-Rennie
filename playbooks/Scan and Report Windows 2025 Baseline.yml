---
- name: Windows Server 2025 Baseline Scan
  hosts: windows_server_2025
  gather_facts: yes
  vars:
    s3_bucket_name: "CISbasline-Files"
    s3_region: "eu-west-1"

  tasks:
    - name: Run Windows Server 2025 Security Baseline Audit
      win_shell: |
        Get-ComputerInfo | Select-Object CsName, OsName, OsVersion | ConvertTo-Json
      register: audit_results

    - name: Ensure S3 Bucket Exists
      delegate_to: localhost
      amazon.aws.s3_bucket:
        name: "{{ s3_bucket_name }}"
        region: "{{ s3_region }}"
        state: present
      ignore_errors: yes

    - name: Ensure Report Directory Exists on Control Node
      delegate_to: localhost
      file:
        path: "{{ playbook_dir }}/reports"
        state: directory

    - name: Generate the HTML Report
      delegate_to: localhost
      template:
        src: "{{ playbook_dir }}/../templates/baseline_report.j2"
        dest: "{{ playbook_dir }}/reports/baseline_report.html"
      vars:
        # Define the object the template expects
        report_data: "{{ audit_results.stdout | from_json }}"

    - name: Upload Report to S3 with Timestamp
      delegate_to: localhost
      amazon.aws.s3_object:
        bucket: "{{ s3_bucket_name }}"
        # Unique filename ensures the 'Last Modified' time updates in S3
        object: "reports/{{ inventory_hostname }}_{{ ansible_date_time.iso8601_basic_short }}.html"
        src: "{{ playbook_dir }}/reports/baseline_report.html"
        mode: put
        region: "{{ s3_region }}"

    - name: Generate Temporary Viewing Link
      delegate_to: localhost
      amazon.aws.s3_object:
        bucket: "{{ s3_bucket_name }}"
        object: "reports/{{ inventory_hostname }}_{{ ansible_date_time.iso8601_basic_short }}.html"
        mode: geturl
        expiration: 3600
        region: "{{ s3_region }}"
      register: s3_link

    - name: Display Report Link
      debug:
        msg: "The temporary report link is: {{ s3_link.url }}"
