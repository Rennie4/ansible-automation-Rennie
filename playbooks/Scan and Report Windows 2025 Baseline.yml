---
- name: Windows Server 2025 Baseline Scan
  hosts: windows_server_2025
  gather_facts: yes

  tasks:
    - name: Run Windows Server 2025 Security Baseline Audit
      win_shell: |
        # We ensure the output is JSON so Ansible can parse it into an object
        Get-ComputerInfo | Select-Object CsName, OsName, OsVersion | ConvertTo-Json
      register: audit_results

    - name: Ensure Report Directory Exists on Control Node
      delegate_to: localhost
      file:
        path: "{{ playbook_dir }}/reports"
        state: directory

    - name: Generate the HTML Report
      delegate_to: localhost
      template:
        # Matches your Git structure: root/templates/baseline_report.j2
        src: "{{ playbook_dir }}/../templates/baseline_report.j2"
        dest: "{{ playbook_dir }}/reports/baseline_report.html"
      vars:
        # This converts the raw text into an object with attributes like .OsName
        report_data: "{{ audit_results.stdout | from_json }}"

    - name: Upload Report to S3
      delegate_to: localhost
      amazon.aws.s3_object:
        bucket: "{{ s3_bucket_name }}"
        object: "reports/{{ inventory_hostname }}_baseline.html"
        src: "{{ playbook_dir }}/reports/baseline_report.html"
        mode: put

    - name: Generate Temporary Viewing Link
      delegate_to: localhost
      amazon.aws.s3_object:
        bucket: "{{ s3_bucket_name }}"
        object: "reports/{{ inventory_hostname }}_baseline.html"
        mode: geturl
        expiration: 3600
      register: s3_link

    - name: Display Report Link
      debug:
        msg: "The temporary report link is: {{ s3_link.url }}"
