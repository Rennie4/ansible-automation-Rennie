---
- name: Windows Server 2025 Baseline Scan
  hosts: windows_server_2025
  gather_facts: yes

  tasks:
    - name: Run Windows Server 2025 Security Baseline Audit
      win_shell: |
        # Placeholder for your specific baseline audit logic
        # Example: Get-ComputerInfo or specialized security scripts
      register: audit_results

    - name: Ensure Report Directory Exists on Control Node
      delegate_to: localhost
      file:
        path: "{{ playbook_dir }}/reports"
        state: directory

    - name: Generate the HTML Report
      delegate_to: localhost
      template:
        # Navigates up from 'playbooks/' to find 'templates/baseline_report.j2' at the root
        src: "{{ playbook_dir }}/../templates/baseline_report.j2"
        dest: "{{ playbook_dir }}/reports/baseline_report.html"

    - name: Upload Report to S3
      delegate_to: localhost
      amazon.aws.s3_object:
        bucket: "{{ s3_bucket_name }}"
        object: "reports/{{ inventory_hostname }}_baseline.html"
        src: "{{ playbook_dir }}/reports/baseline_report.html"
        mode: put

    - name: Generate Temporary Viewing Link
      delegate_to: localhost
      amazon.aws.s3_object:
        bucket: "{{ s3_bucket_name }}"
        object: "reports/{{ inventory_hostname }}_baseline.html"
        # Corrected mode for generating pre-signed URLs
        mode: geturl
        expiration: 3600
      register: s3_link

    - name: Display Report Link
      debug:
        msg: "The temporary report link is: {{ s3_link.url }}"
