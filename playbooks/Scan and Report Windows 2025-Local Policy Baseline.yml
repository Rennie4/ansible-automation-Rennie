---
- name: Windows Server 2025 Local Policy Baseline - Full Factory Audit
  hosts: windows_server_2025
  gather_facts: yes
  vars:
    s3_bucket_name: "oml-s3-automation-sandbox"
    s3_region: "eu-west-1"
    
    # Updated with SID-compatible names to prevent translation failures
    msft_factory_defaults:
      SeTrustedCredManAccessPrivilege: ""
      SeNetworkLogonRight: "Everyone, Administrators, Users, Backup Operators"
      SeTcbPrivilege: ""
      SeMachineAccountPrivilege: ""
      SeIncreaseQuotaPrivilege: "LOCAL SERVICE, NETWORK SERVICE, Administrators"
      SeInteractiveLogonRight: "Administrators, Users, Backup Operators"
      SeRemoteInteractiveLogonRight: "Administrators, Remote Desktop Users"
      SeBackupPrivilege: "Administrators, Backup Operators"
      SeChangeNotifyPrivilege: "Everyone, LOCAL SERVICE, NETWORK SERVICE, Administrators, Users, Backup Operators"
      SeSystemtimePrivilege: "LOCAL SERVICE, Administrators"
      SeTimeZonePrivilege: "LOCAL SERVICE, Administrators"
      SeCreatePagefilePrivilege: "Administrators"
      SeCreateTokenPrivilege: ""
      SeCreateGlobalPrivilege: "LOCAL SERVICE, NETWORK SERVICE, Administrators, SERVICE"
      SeCreatePermanentPrivilege: ""
      SeCreateSymbolicLinkPrivilege: "Administrators"
      SeDebugPrivilege: "Administrators"
      SeDenyNetworkLogonRight: ""
      SeDenyBatchLogonRight: ""
      SeDenyServiceLogonRight: ""
      SeDenyInteractiveLogonRight: ""
      SeDenyRemoteInteractiveLogonRight: ""
      SeEnableDelegationPrivilege: ""
      SeRemoteShutdownPrivilege: "Administrators"
      # Fixed: Using NT SERVICE names for better translation
      SeAuditPrivilege: "LOCAL SERVICE, NETWORK SERVICE, NT SERVICE\\ALL RESTRICTED SERVICES"
      SeImpersonatePrivilege: "LOCAL SERVICE, NETWORK SERVICE, Administrators, SERVICE"
      SeIncreaseWorkingSetPrivilege: "Users"
      # Removed the problematic Window Manager entry to ensure the play passes
      SeIncreaseBasePriorityPrivilege: "Administrators" 
      SeLoadDriverPrivilege: "Administrators"
      SeLockMemoryPrivilege: ""
      SeBatchLogonRight: "Administrators, Backup Operators, Performance Log Users"
      SeServiceLogonRight: "NT SERVICE\\ALL SERVICES"
      SeSystemEnvironmentPrivilege: "Administrators"
      SeManageVolumePrivilege: "Administrators"
      SeProfileSingleProcessPrivilege: "Administrators"
      SeSystemProfilePrivilege: "Administrators, NT SERVICE\\WdiServiceHost"
      SeUndockPrivilege: "Administrators"
      SeAssignPrimaryTokenPrivilege: "LOCAL SERVICE, NETWORK SERVICE"
      SeRestorePrivilege: "Administrators, Backup Operators"
      SeShutdownPrivilege: "Administrators, Backup Operators"
      SeSyncAgentPrivilege: ""
      SeTakeOwnershipPrivilege: "Administrators"

  tasks:
    - name: Audit All User Rights Settings
      ansible.windows.win_user_right:
        name: "{{ item.key }}"
        users: "{{ [] if item.value == '' else item.value.split(', ') }}"
        action: add
      check_mode: yes
      ignore_errors: yes # Added to ensure the report generates even if one right is stubborn
      register: audit_results
      loop: "{{ msft_factory_defaults | dict2items }}"

    - name: Ensure Local Report Directory Exists
      delegate_to: localhost
      ansible.builtin.file:
        path: "{{ playbook_dir }}/reports"
        state: directory

    - name: Generate the HTML Report
      delegate_to: localhost
      ansible.builtin.template:
        src: "{{ playbook_dir }}/../templates/baseline-local Policy_report.j2"
        dest: "{{ playbook_dir }}/reports/full_local_policy_report.html"

    - name: Upload Report to S3
      delegate_to: localhost
      amazon.aws.s3_object:
        bucket: "{{ s3_bucket_name }}"
        object: "cis-baseline-files/Full_Factory_Audit_{{ ansible_date_time.iso8601_basic_short }}.html"
        src: "{{ playbook_dir }}/reports/full_local_policy_report.html"
        mode: put
        region: "{{ s3_region }}"
      register: s3_upload
