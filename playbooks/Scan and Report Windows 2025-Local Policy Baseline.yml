---
- name: Windows Server 2025 Local Policy Baseline - User Rights
  hosts: windows_hosts
  gather_facts: yes
  vars:
    s3_bucket_name: "oml-s3-automation-sandbox"
    s3_region: "eu-west-1"

  tasks:
    - name: Audit All CIS Section 2.2 User Rights
      win_shell: !unsafe |
        $tempFile = "C:\Windows\Temp\secedit_local_policy.inf"
        secedit /export /cfg $tempFile /areas USER_RIGHTS | Out-Null
        $policy = Get-Content $tempFile
        Remove-Item $tempFile

        function Convert-Sids($sidString) {
            if (!$sidString) { return "No one / Right Not Assigned" }
            $sids = $sidString.Split(',')
            $translated = foreach ($sid in $sids) {
                $cleanSid = $sid.Trim().Replace("*", "")
                try {
                    $objSid = New-Object System.Security.Principal.SecurityIdentifier($cleanSid)
                    $objSid.Translate([System.Security.Principal.NTAccount]).Value
                } catch { $cleanSid }
            }
            return $translated -join ", "
        }

        function Get-UserRight($key) {
            $line = $policy | Select-String "^$key\s*="
            if ($line) { 
                $rawVal = $line.ToString().Split('=')[1].Trim()
                return Convert-Sids($rawVal)
            }
            return "Not Defined (Default)"
        }

        $results = @{
            AccessNetwork           = Get-UserRight "SeNetworkLogonRight"
            AdjustMemoryQuotas      = Get-UserRight "SeIncreaseQuotaPrivilege"
            AllowLocalLogon         = Get-UserRight "SeInteractiveLogonRight"
            AllowRemoteLogon        = Get-UserRight "SeRemoteInteractiveLogonRight"
            BackupFiles             = Get-UserRight "SeBackupPrivilege"
            DebugPrograms           = Get-UserRight "SeDebugPrivilege"
            RestoreFiles            = Get-UserRight "SeRestorePrivilege"
            TakeOwnership           = Get-UserRight "SeTake
