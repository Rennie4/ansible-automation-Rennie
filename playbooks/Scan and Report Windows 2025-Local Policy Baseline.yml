---
- name: Scan Windows 2025 and Upload Report to S3
  hosts: all
  gather_facts: yes
  vars:
    s3_bucket: "oml-s3-automation-sandbox"
    s3_path: "cis-baseline-files"
    aws_region: "eu-west-1"
    
    # Pathing as per your last working version
    template_path: "{{ playbook_dir }}/../templates/baseline-local Policy_report.j2"

    # Full map of 37 User Rights Assignment (CIS 2.2.1 - 2.2.37)
    sid_map:
      "SeNetworkLogonRight": "Access this computer from the network"
      "SeBackupPrivilege": "Back up files and directories"
      "SeChangeNotifyPrivilege": "Bypass traverse checking"
      "SeSystemtimePrivilege": "Change the system time"
      "SeCreatePagefilePrivilege": "Create a pagefile"
      "SeDebugPrivilege": "Debug programs"
      "SeRemoteShutdownPrivilege": "Force shutdown from a remote system"
      "SeAuditPrivilege": "Generate security audits"
      "SeIncreaseQuotaPrivilege": "Adjust memory quotas for a process"
      "SeIncreaseBasePriorityPrivilege": "Increase scheduling priority"
      "SeLoadDriverPrivilege": "Load and unload device drivers"
      "SeBatchLogonRight": "Log on as a batch job"
      "SeServiceLogonRight": "Log on as a service"
      "SeInteractiveLogonRight": "Allow log on locally"
      "SeSecurityPrivilege": "Manage auditing and security log"
      "SeSystemEnvironmentPrivilege": "Modify firmware environment values"
      "SeProfileSingleProcessPrivilege": "Profile single process"
      "SeSystemProfilePrivilege": "Profile system performance"
      "SeAssignPrimaryTokenPrivilege": "Replace a process level token"
      "SeRestorePrivilege": "Restore files and directories"
      "SeShutdownPrivilege": "Shut down the system"
      "SeTakeOwnershipPrivilege": "Take ownership of files or other objects"
      "SeUndockPrivilege": "Remove computer from docking station"
      "SeManageVolumePrivilege": "Perform volume maintenance tasks"
      "SeRemoteInteractiveLogonRight": "Allow log on through Remote Desktop Services"
      "SeImpersonatePrivilege": "Impersonate a client after authentication"
      "SeCreateGlobalPrivilege": "Create global objects"
      "SeIncreaseWorkingSetPrivilege": "Increase a process working set"
      "SeTimeZonePrivilege": "Change the time zone"
      "SeCreateSymbolicLinkPrivilege": "Create symbolic links"
      "SeDelegateSessionUserImpersonatePrivilege": "Obtain an impersonation token for another user"
      "SeTrustedCredManAccessPrivilege": "Access Credential Manager as a trusted caller"
      "SeTcbPrivilege": "Act as part of the operating system"
      "SeCreateTokenPrivilege": "Create a token object"
      "SeLockMemoryPrivilege": "Lock pages in memory"
      "SeRelabelPrivilege": "Modify an object label"
      "SeSyncAgentPrivilege": "Synchronize directory service data"

  tasks:
    - name: Export and Dynamically Translate All SIDs
      ansible.windows.win_shell: |
        $configFile = "C:\temp\audit_scan.inf"
        if (!(Test-Path "C:\temp")) { New-Item -Path "C:\" -Name "temp" -ItemType "Directory" | Out-Null }
        secedit /export /areas USER_RIGHTS /cfg $configFile | Out-Null
        
        $results = @()
        if (Test-Path $configFile) {
            $raw = Get-Content $configFile | Where-Object { $_ -match '=' }
            foreach ($line in $raw) {
                $parts = $line.Split('=')
                $key = $parts[0].Trim()
                $rawVals = $parts[1].Trim() -split ','
                
                $translated = foreach ($val in $rawVals) {
                    $cleanVal = $val.Trim().Trim('*')
                    if ($cleanVal -match '^S-1-5-') {
                        try {
                            $sid = New-Object System.Security.Principal.SecurityIdentifier($cleanVal)
                            $sid.Translate([System.Security.Principal.NTAccount]).Value
                        } catch { $cleanVal }
                    } else { $cleanVal }
                }
                $results += @{ id = $key; value = ($translated -join ", ") }
            }
            Remove-Item $configFile
        }
        $results | ConvertTo-Json -Compress
      register: policy_scan_translated

    - name: Ensure Local Report Directory Exists
      delegate_to: localhost
      ansible.builtin.file:
        path: "{{ playbook_dir }}/reports"
        state: directory

    - name: Generate HTML Report from Template
      delegate_to: localhost
      ansible.builtin.template:
        src: "{{ template_path }}"
        dest: "{{ playbook_dir }}/reports/Server_Audit_{{ inventory_hostname }}.html"

    - name: Upload Audit Report to S3 Bucket
      delegate_to: localhost
      amazon.aws.s3_object:
        bucket: "{{ s3_bucket }}"
        object: "{{ s3_path }}/Server_Audit_{{ inventory_hostname }}_{{ ansible_date_time.iso8601_basic_short }}.html"
        src: "{{ playbook_dir }}/reports/Server_Audit_{{ inventory_hostname }}.html"
        mode: put
        region: "{{ aws_region }}"
      register: s3_upload

    - name: Display Report Link
      debug:
        msg: "The report is available at: {{ s3_upload.url }}"
