---
- name: Windows Server 2025 Local Policy Baseline - User Rights
  hosts: windows_server_2025
  gather_facts: yes
  vars:
    # Avoiding hard-coded EBS paths to ensure stability after reboots
    report_output_dir: "./audit_reports/{{ inventory_hostname }}"
    report_date: "{{ ansible_date_time.date }}"

  tasks:
    - name: Audit All CIS Section 2.2 User Rights
      ansible.windows.win_user_right:
        name: "{{ item }}"
        users: []
        action: add
      check_mode: yes
      register: audit_results
      loop:
        - SeNetworkLogonRight
        - SeBackupPrivilege
        - SeCreatePagefilePrivilege
        - SeDebugPrivilege
        - SeRemoteShutdownPrivilege
        - SeServiceLogonRight

    - name: Ensure Local Report Directory Exists
      delegate_to: localhost
      ansible.builtin.file:
        path: "{{ report_output_dir }}"
        state: directory
        mode: '0755'

    - name: Generate the HTML Report
      delegate_to: localhost
      ansible.builtin.template:
        # Exact match for your J2 filename
        src: "baseline-local Policy_report.j2"
        dest: "{{ report_output_dir }}/Audit_Report_{{ report_date }}.html"

    - name: Report Completion
      debug:
        msg: "Audit complete. Report saved to {{ report_output_dir }}"
