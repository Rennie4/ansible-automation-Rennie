---
- name: Windows Server 2025 Local Policy Baseline - Full Factory Audit
  hosts: windows_server_2025
  gather_facts: yes
  vars:
    s3_bucket_name: "oml-s3-automation-sandbox"
    s3_region: "eu-west-1"
    
    # Exact 44 items in alphabetical order
    msft_factory_defaults:
      - { name: 'SeTrustedCredManAccessPrivilege', display: 'Access Credential Manager as a trusted caller', value: '' }
      - { name: 'SeNetworkLogonRight', display: 'Access this computer from the network', value: 'Everyone, Administrators, Users, Backup Operators' }
      - { name: 'SeTcbPrivilege', display: 'Act as part of the operating system', value: '' }
      - { name: 'SeMachineAccountPrivilege', display: 'Add workstations to domain', value: '' }
      - { name: 'SeIncreaseQuotaPrivilege', display: 'Adjust memory quotas for a process', value: 'LOCAL SERVICE, NETWORK SERVICE, Administrators' }
      - { name: 'SeInteractiveLogonRight', display: 'Allow log on locally', value: 'Administrators, Users, Backup Operators' }
      - { name: 'SeRemoteInteractiveLogonRight', display: 'Allow log on through Remote Desktop Services', value: 'Administrators, Remote Desktop Users' }
      - { name: 'SeBackupPrivilege', display: 'Back up files and directories', value: 'Administrators, Backup Operators' }
      - { name: 'SeChangeNotifyPrivilege', display: 'Bypass traverse checking', value: 'Everyone, LOCAL SERVICE, NETWORK SERVICE, Administrators, Users, Backup Operators' }
      - { name: 'SeSystemtimePrivilege', display: 'Change the system time', value: 'LOCAL SERVICE, Administrators' }
      - { name: 'SeTimeZonePrivilege', display: 'Change the time zone', value: 'LOCAL SERVICE, Administrators' }
      - { name: 'SeCreatePagefilePrivilege', display: 'Create a pagefile', value: 'Administrators' }
      - { name: 'SeCreateTokenPrivilege', display: 'Create a token object', value: '' }
      - { name: 'SeCreateGlobalPrivilege', display: 'Create global objects', value: 'LOCAL SERVICE, NETWORK SERVICE, Administrators, SERVICE' }
      - { name: 'SeCreatePermanentPrivilege', display: 'Create permanent shared objects', value: '' }
      - { name: 'SeCreateSymbolicLinkPrivilege', display: 'Create symbolic links', value: 'Administrators' }
      - { name: 'SeDebugPrivilege', display: 'Debug programs', value: 'Administrators' }
      - { name: 'SeDenyNetworkLogonRight', display: 'Deny access to this computer from the network', value: '' }
      - { name: 'SeDenyBatchLogonRight', display: 'Deny log on as a batch job', value: '' }
      - { name: 'SeDenyServiceLogonRight', display: 'Deny log on as a service', value: '' }
      - { name: 'SeDenyInteractiveLogonRight', display: 'Deny log on locally', value: '' }
      - { name: 'SeDenyRemoteInteractiveLogonRight', display: 'Deny log on through Remote Desktop Services', value: '' }
      - { name: 'SeEnableDelegationPrivilege', display: 'Enable computer and user accounts to be trusted for delegation', value: '' }
      - { name: 'SeRemoteShutdownPrivilege', display: 'Force shutdown from a remote system', value: 'Administrators' }
      - { name: 'SeAuditPrivilege', display: 'Generate security audits', value: 'LOCAL SERVICE, NETWORK SERVICE, NT SERVICE\ALL RESTRICTED SERVICES, NT SERVICE\PrintSpoolerService' }
      - { name: 'SeImpersonatePrivilege', display: 'Impersonate a client after authentication', value: 'LOCAL SERVICE, NETWORK SERVICE, Administrators, SERVICE, NT SERVICE\ALL RESTRICTED SERVICES' }
      - { name: 'SeIncreaseWorkingSetPrivilege', display: 'Increase a process working set', value: 'Users' }
      - { name: 'SeIncreaseBasePriorityPrivilege', display: 'Increase scheduling priority', value: 'Administrators, Window Manager\Window Manager Group' }
      - { name: 'SeLoadDriverPrivilege', display: 'Load and unload device drivers', value: 'Administrators' }
      - { name: 'SeLockMemoryPrivilege', display: 'Lock pages in memory', value: '' }
      - { name: 'SeBatchLogonRight', display: 'Log on as a batch job', value: 'Administrators, Backup Operators, Performance Log Users' }
      - { name: 'SeServiceLogonRight', display: 'Log on as a service', value: 'NT SERVICE\ALL SERVICES, NT SERVICE\ALL RESTRICTED SERVICES' }
      - { name: 'SeSecurityPrivilege', display: 'Manage auditing and security log', value: 'Administrators' }
      - { name: 'SeRelabelPrivilege', display: 'Modify an object label', value: '' }
      - { name: 'SeSystemEnvironmentPrivilege', display: 'Modify firmware environment values', value: 'Administrators' }
      - { name: 'SeDelegateSessionUserImpersonatePrivilege', display: 'Obtain an impersonation token for another user in the same session', value: 'Administrators' }
      - { name: 'SeManageVolumePrivilege', display: 'Perform volume maintenance tasks', value: 'Administrators' }
      - { name: 'SeProfileSingleProcessPrivilege', display: 'Profile single process', value: 'Administrators' }
      - { name: 'SeSystemProfilePrivilege', display: 'Profile system performance', value: 'Administrators, NT SERVICE\WdiServiceHost' }
      - { name: 'SeUndockPrivilege', display: 'Remove computer from docking station', value: 'Administrators' }
      - { name: 'SeAssignPrimaryTokenPrivilege', display: 'Replace a process level token', value: 'LOCAL SERVICE, NETWORK SERVICE' }
      - { name: 'SeRestorePrivilege', display: 'Restore files and directories', value: 'Administrators, Backup Operators' }
      - { name: 'SeShutdownPrivilege', display: 'Shut down the system', value: 'Administrators, Backup Operators' }
      - { name: 'SeSyncAgentPrivilege', display: 'Synchronize directory service data', value: '' }
      - { name: 'SeTakeOwnershipPrivilege', display: 'Take ownership of files or other objects', value: 'Administrators' }

  tasks:
    - name: Audit User Rights in Server Order
      community.windows.win_user_right:
        name: "{{ item.name }}"
        users: "{{ [] if item.value == '' else item.value.split(', ') }}"
        action: add
      check_mode: yes
      ignore_errors: yes
      register: audit_results
      loop: "{{ msft_factory_defaults }}"

    - name: Ensure Local Report Directory Exists
      delegate_to: localhost
      ansible.builtin.file:
        path: "{{ playbook_dir }}/reports"
        state: directory

    - name: Generate the HTML Report
      delegate_to: localhost
      ansible.builtin.template:
        src: "{{ playbook_dir }}/baseline-local Policy_report.j2"
        dest: "{{ playbook_dir }}/reports/full_local_policy_report.html"

    - name: Upload Report to S3
      delegate_to: localhost
      amazon.aws.s3_object:
        bucket: "{{ s3_bucket_name }}"
        object: "cis-baseline-files/Local_Policy_Audit_{{ ansible_date_time.iso8601_basic_short }}.html"
        src: "{{ playbook_dir }}/reports/full_local_policy_report.html"
        mode: put
        region: "{{ s3_region }}"
      register: s3_upload

    - name: Display Report Link
      debug:
        msg: "Local Policy Audit Report: {{ s3_upload.url }}"
