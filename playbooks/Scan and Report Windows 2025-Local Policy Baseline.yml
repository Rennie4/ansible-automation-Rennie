- name: Windows Server 2025 Local Policy Baseline - Full Factory Audit
  hosts: windows_server_2025
  gather_facts: yes

  vars:
    s3_bucket_name: "oml-s3-automation-sandbox"
    s3_region: "eu-west-1"
    secedit_export_path: "C:\\Temp\\secpol_export.inf"

  tasks:
    - name: Export Local Security Policy (User Rights)
      ansible.windows.win_command: >
        secedit /export /cfg {{ secedit_export_path }} /areas USER_RIGHTS
      register: secedit_export
      changed_when: false

    - name: Read Exported Policy File
      ansible.windows.win_slurp:
        src: "{{ secedit_export_path }}"
      register: raw_policy

    - name: Decode Policy Content
      ansible.builtin.set_fact:
        policy_text: "{{ raw_policy.content | b64decode }}"

    - name: Build Audit Results (Factory Comparison)
      ansible.builtin.set_fact:
        audit_results: >-
          {{
            audit_results | default({'results': []}) |
            combine({
              'results': audit_results.results + [{
                'item': item,
                'evaluated': (policy_text | regex_search('^' ~ item.name ~ '\\s*=\\s*(.*)$', multiline=True)),
                'changed': (policy_text | regex_search('^' ~ item.name ~ '\\s*=\\s*(.*)$', multiline=True) | default('') != item.value),
                'failed': false
              }]
            })
          }}
      loop:
        - { name: 'SeNetworkLogonRight', display: 'Access this computer from the network', value: 'Everyone, Administrators, Users, Backup Operators' }
        - { name: 'SeRemoteInteractiveLogonRight', display: 'Allow log on through Remote Desktop Services', value: 'Administrators, Remote Desktop Users' }
        - { name: 'SeShutdownPrivilege', display: 'Shut down the system', value: 'Administrators, Backup Operators' }

    - name: Ensure Local Report Directory
      delegate_to: localhost
      ansible.builtin.file:
        path: "{{ playbook_dir }}/reports"
        state: directory

    - name: Generate HTML Report
      delegate_to: localhost
      ansible.builtin.template:
        src: "{{ playbook_dir }}/baseline-local Policy_report.j2"
        dest: "{{ playbook_dir }}/reports/full_local_policy_report.html"

    - name: Upload Report to S3
      delegate_to: localhost
      amazon.aws.s3_object:
        bucket: "{{ s3_bucket_name }}"
        object: "cis-baseline-files/Local_Audit_{{ ansible_date_time.iso8601_basic_short }}.html"
        src: "{{ playbook_dir }}/reports/full_local_policy_report.html"
        mode: put
        region: "{{ s3_region }}"
      register: s3_upload

    - name: Final S3 Link
      debug:
        msg: "Report is here: {{ s3_upload.url }}"
