---
- name: Windows EBS and Disk Space Report
  hosts: windows_hosts
  gather_facts: no
  tasks:
    - name: Fetch EBS and Disk Data
      ansible.windows.win_powershell:
        script: |
          $Results = Get-CimInstance Win32_LogicalDisk | ForEach-Object {
              $LogicalDisk = $_
              $Partition = Get-CimAssociatedInstance -InputObject $LogicalDisk -ResultClassName Win32_DiskPartition
              $DiskDrive = Get-CimAssociatedInstance -InputObject $Partition -ResultClassName Win32_DiskDrive
              
              [PSCustomObject]@{
                  DriveLetter = $LogicalDisk.DeviceID
                  VolumeName  = $LogicalDisk.VolumeName
                  TotalGB     = [math]::Round($LogicalDisk.Size / 1GB, 2)
                  FreeGB      = [math]::Round($LogicalDisk.FreeSpace / 1GB, 2)
                  PercentFree = [math]::Round(($LogicalDisk.FreeSpace / $LogicalDisk.Size) * 100, 2)
                  EBS_ID      = $DiskDrive.SerialNumber -replace '.*(vol-[a-zA-Z0-9]+).*','$1'
              }
          }
          return $Results
      register: disk_info

    - name: Final User-Friendly Report
      debug:
        msg: >-
          {{
            [
              "------------------------------------------------",
              "SERVER: " ~ inventory_hostname,
              "STORAGE HEALTH CHECK",
              "------------------------------------------------"
            ] +
            (disk_info.output | map('json_query', 
              'join(`\n`, [
                "DRIVE: " + DriveLetter + " [" + VolumeName + "]",
                "EBS VOLUME: " + EBS_ID,
                "CAPACITY: " + to_string(FreeGB) + "GB Free / " + to_string(TotalGB) + "GB total",
                "HEALTH: " + to_string(PercentFree) + "% Available",
                "------------------------------------------------"
              ])'
            ) | list)
          }}
