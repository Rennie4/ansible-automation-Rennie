---
- name: Windows Server 2025 â€“ Security Options Audit (HTML Only)
  hosts: all
  gather_facts: yes

  vars:
    s3_bucket: "oml-s3-automation-sandbox"
    s3_path: "cis-baseline-files"
    aws_region: "eu-west-1"
    report_file: "{{ playbook_dir }}/Security_Options_Report_{{ inventory_hostname }}.html"
    remote_map_file: "C:\\temp\\security_options_map.json"

    # -----------------------------------------------
    # YOUR 104-ITEM MAP (WORKING COPY)
    # -----------------------------------------------
    # (Use your latest working mapping block from your last playbook)
    security_options_map:
      "EnableAdminAccount": "Accounts: Administrator account status"
      "BlockConsumerMicrosoftAccounts": "Accounts: Block Microsoft accounts"
      "EnableGuestAccount": "Accounts: Guest account status"
      "LimitBlankPasswordUse": "Accounts: Limit local account use of blank passwords"
      "NewAdminName": "Accounts: Rename administrator account"
      "NewGuestName": "Accounts: Rename guest account"
      "MACHINE\\System\\CurrentControlSet\\Control\\Lsa\\AuditBaseObjects": "Audit: Audit the access of global system objects"
      "MACHINE\\System\\CurrentControlSet\\Control\\Lsa\\FullPrivilegeAuditing": "Audit: Audit the use of Backup and Restore privilege"
      "ForceAuditPolicySubcategorySettingsToOverrideAuditPolicyCategorySettings": "Audit: Force audit policy subcategory settings"
      "MACHINE\\System\\CurrentControlSet\\Control\\Lsa\\CrashOnAuditFail": "Audit: Shut down system immediately if unable to log audits"
      "MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\UndockWithoutLogon": "Devices: Allow undock without having to log on"
      "AllowedToFormatAndEjectRemovableMedia": "Devices: Allowed to format and eject removable media"
      "MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\AddPrinterDrivers": "Devices: Prevent users from installing printer drivers"
      "MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\RestrictCDROM": "Devices: Restrict CD-ROM access"
      "MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\RestrictFloppy": "Devices: Restrict floppy access"
      "MACHINE\\System\\CurrentControlSet\\Services\\Netlogon\\Parameters\\RequireSignOrSeal": "Domain member: Digitally encrypt or sign (always)"
      "MACHINE\\System\\CurrentControlSet\\Services\\Netlogon\\Parameters\\SealSecureChannel": "Domain member: Digitally encrypt (when possible)"
      "MACHINE\\System\\CurrentControlSet\\Services\\Netlogon\\Parameters\\SignSecureChannel": "Domain member: Digitally sign (when possible)"
      "MACHINE\\System\\CurrentControlSet\\Services\\Netlogon\\Parameters\\DisablePasswordChange": "Domain member: Disable machine account password changes"
      "MACHINE\\System\\CurrentControlSet\\Services\\Netlogon\\Parameters\\MaximumPasswordAge": "Domain member: Maximum machine account password age"
      "MACHINE\\System\\CurrentControlSet\\Services\\Netlogon\\Parameters\\RequireStrongKey": "Domain member: Require strong session key"
      "MACHINE\\System\\CurrentControlSet\\Services\\Netlogon\\Parameters\\RefusePasswordChange": "Domain member: Refuse machine account password changes"
      "MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\DontDisplayLastUserName": "Interactive logon: Don't display last signed-in"
      "MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\DisableCAD": "Interactive logon: Do not require CTRL+ALT+DEL"
      "MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\InactivityTimeoutSecs": "Interactive logon: Machine inactivity limit"
      "MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\MaxDevicePasswordFailedAttempts": "Interactive logon: Machine account lockout threshold"
      "MACHINE\\Software\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon\\CachedLogonsCount": "Interactive logon: Number of previous logons to cache"
      "MACHINE\\Software\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon\\PasswordExpiryWarning": "Interactive logon: Prompt user to change password"
      "MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\ShutdownWithoutLogon": "Interactive logon: Allow system shutdown without logon"
      "MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\ScForceOption": "Interactive logon: Require smart card"
      "MACHINE\\Software\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon\\ScRemoveOption": "Interactive logon: Smart card removal behavior"
      "MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\DisplayLogonInfo": "Interactive logon: Display user information when locked"
      "MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\DontDisplayUsername": "Interactive logon: Don't display username at sign-in"
      "MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\LegalNoticeCaption": "Interactive logon: Message title for users logging on"
      "MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\LegalNoticeText": "Interactive logon: Message text for users logging on"
      "MACHINE\\System\\CurrentControlSet\\Control\\Lsa\\NoLMHash": "Network security: Do not store LAN Manager hash"
      "MACHINE\\System\\CurrentControlSet\\Control\\Lsa\\LmCompatibilityLevel": "Network security: LAN Manager authentication level"
      "MACHINE\\System\\CurrentControlSet\\Control\\Lsa\\UseMachineId": "Network security: Allow Local System to use computer identity"
      "MACHINE\\System\\CurrentControlSet\\Services\\LDAP\\LDAPClientIntegrity": "Network security: LDAP client signing requirements"
      "LDAPServerIntegrity": "Network security: LDAP server signing requirements"
      "MACHINE\\System\\CurrentControlSet\\Control\\Lsa\\MSV1_0\\NTLMMinClientSec": "Network security: Min session security for NTLM clients"
      "MACHINE\\System\\CurrentControlSet\\Control\\Lsa\\MSV1_0\\NTLMMinServerSec": "Network security: Min session security for NTLM servers"
      "MACHINE\\System\\CurrentControlSet\\Control\\Lsa\\EveryoneIncludesAnonymous": "Network security: Let Everyone apply to anonymous"
      "MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\ConsentPromptBehaviorAdmin": "UAC: Elevation prompt for admins"
      "MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\ConsentPromptBehaviorUser": "UAC: Elevation prompt for users"
      "MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\EnableLUA": "UAC: Run admins in Admin Approval Mode"
      "MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\PromptOnSecureDesktop": "UAC: Switch to secure desktop for elevation"
      "MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\EnableInstallerDetection": "UAC: Detect application installs"
      "MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\FilterAdministratorToken": "UAC: Admin Approval Mode for Built-in Admin"
      "MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\EnableUIADesktopToggle": "UAC: Allow UIAccess apps to prompt"
      "MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\EnableSecureUIAPaths": "UAC: Only elevate secure UIAccess apps"
      "MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\EnableVirtualization": "UAC: Virtualize file/registry write failures"

  tasks:

    - name: Ensure temp folder exists
      ansible.windows.win_file:
        path: C:\temp
        state: directory

    - name: Upload 104 policy map to server
      ansible.windows.win_copy:
        content: "{{ security_options_map | to_nice_json }}"
        dest: "{{ remote_map_file }}"

    - name: Run Security Options Audit
      ansible.windows.win_powershell:
        script: |
          # Load 104 map
          $map = Get-Content "C:\temp\security_options_map.json" -Raw | ConvertFrom-Json

          # Build main list
          $mapList = @()
          foreach ($p in $map.PSObject.Properties) {
            $mapList += [PSCustomObject]@{ Id = $p.Name; Name = $p.Value }
          }

          # Add 3 UAC items
          $extra = @(
            [PSCustomObject]@{ Id='UAC_INSTALL_DETECTION'; Name='UAC: Detect application installations and prompt for elevation' },
            [PSCustomObject]@{ Id='UAC_STD_PROMPT_BEHAVIOR'; Name='UAC: Behavior of the elevation prompt for standard users' },
            [PSCustomObject]@{ Id='UAC_ADMIN_PROMPT_BEHAVIOR'; Name='UAC: Behavior of the elevation prompt for administrators in Admin Approval Mode' }
          )

          foreach ($e in $extra) {
            if (-not ($mapList | Where-Object { $_.Id -eq $e.Id })) {
              $mapList += $e
            }
          }

          # Export security policy (fallback)
          $secFile = "C:\temp\secedit_audit.inf"
          secedit /export /areas SECURITYPOLICY /cfg $secFile | Out-Null

          $secHash = @{}
          if (Test-Path $secFile) {
            Get-Content $secFile -Encoding Unicode |
              Where-Object { $_ -match '=' } |
              ForEach-Object {
                $parts = $_.Split('=',2)
                $k = $parts[0].Trim()
                $v = $parts[1].Trim().Trim('"')
                if ($v -match ',') { $v = $v.Split(',')[0] }
                if ($v -eq "7," -or $v -eq "7") { $v="Enabled" }
                $secHash[$k] = $v
              }
            Remove-Item $secFile -Force -ErrorAction SilentlyContinue
          }

          # Built-in Administrator rename logic
          $adminSID = "S-1-5-21-*-500"
          $ad = Get-CimInstance Win32_UserAccount | Where-Object { $_.SID -like $adminSID -and $_.LocalAccount }
          $AdminRenameStatus = if ($ad -and $ad.Name -ne "Administrator") { "Renamed$" } else { "Default (Administrator)" }

          # UAC lookups
          $pol = "HKLM:\Software\Microsoft\Windows\CurrentVersion\Policies\System"

          $EnableInstallerDetection = (Get-ItemProperty -Path $pol -Name "EnableInstallerDetection" -ErrorAction SilentlyContinue)."EnableInstallerDetection"
          $UACInstall =
            if ($EnableInstallerDetection -eq 1) { "Enabled" }
            elseif ($EnableInstallerDetection -eq 0) { "Disabled" }
            else { "Not Defined" }

          $uStd = (Get-ItemProperty -Path $pol -Name "ConsentPromptBehaviorUser" -ErrorAction SilentlyContinue)."ConsentPromptBehaviorUser"
          switch ($uStd) {
            0 { $UACStdOut = "Automatically deny elevation requests (0)" }
            1 { $UACStdOut = "Prompt for credentials on secure desktop (1)" }
            3 { $UACStdOut = "Prompt for credentials (3)" }
            default { $UACStdOut = "Not Defined" }
          }

          $uAdm = (Get-ItemProperty -Path $pol -Name "ConsentPromptBehaviorAdmin" -ErrorAction SilentlyContinue)."ConsentPromptBehaviorAdmin"

          switch ($uAdm) {
            2 { $UACAdmOut = "Prompt for consent on the secure desktop (2)" }
            0 { $UACAdmOut = "Elevate without prompting (0)" }
            1 { $UACAdmOut = "Prompt for credentials on secure desktop (1)" }
            3 { $UACAdmOut = "Prompt for credentials (3)" }
            4 { $UACAdmOut = "Prompt for consent (4)" }
            5 { $UACAdmOut = "Prompt for consent for non-Windows binaries (5)" }
            default { $UACAdmOut = "Not Defined" }
          }

          $UACStatus = if ($uAdm -eq 2) { "PASS" } else { "FAIL" }

          # Build output
          $results = foreach ($entry in $mapList) {

            $id = $entry.Id
            $name = $entry.Name
            $val = "Not Defined"

            if ($name -eq "Accounts: Rename administrator account") {
              "$name|$AdminRenameStatus"
              continue
            }

            if ($id -eq "UAC_INSTALL_DETECTION") {
              "$name|$UACInstall"
              continue
            }

            if ($id -eq "UAC_STD_PROMPT_BEHAVIOR") {
              "$name|$UACStdOut"
              continue
            }

            if ($id -eq "UAC_ADMIN_PROMPT_BEHAVIOR") {
              "$name|$UACAdmOut|$UACStatus"
              continue
            }

            # Registry lookup
            if ($id -like "MACHINE\*") {
              $reg = $id.Replace("MACHINE\", "HKLM:\")
              $key = Split-Path $reg
              $leaf = Split-Path $reg -Leaf

              if (Test-Path $key) {
                $rv = Get-ItemProperty -Path $key -Name $leaf -ErrorAction SilentlyContinue
                if ($rv -and $rv.$leaf -ne $null) {
                  $val = $rv.$leaf.ToString()
                }
              }
            }

            # Secedit fallback
            if ($val -eq "Not Defined") {
              $lookup = Split-Path $id -Leaf
              if ($secHash.ContainsKey($lookup)) {
                $val = $secHash[$lookup]
              }
            }

            # Normalization
            if ($val -eq "0" -or $val -eq "3") { $val = "Disabled" }
            elseif ($val -eq "1" -or $val -eq "4") { $val = "Enabled" }
            elseif ($val -eq "536870912") { $val = "Require 128-bit encryption" }

            "$name|$val"
          }

          $results | Sort-Object { ($_ -split '\|')[0] }

      register: scan_output

    - name: Normalize scan_lines
      ansible.builtin.set_fact:
        scan_lines: "{{ scan_output.output | default(scan_output.stdout_lines | default([])) }}"

    - name: Generate HTML report
      delegate_to: localhost
      ansible.builtin.template:
        src: "../templates/baseline-local Policy-Security Options_report.j2"
        dest: "{{ report_file }}"
      vars:
        scan_lines: "{{ scan_lines }}"

    - name: Upload HTML to S3
      delegate_to: localhost
      amazon.aws.s3_object:
        bucket: "{{ s3_bucket }}"
        object: "{{ s3_path }}/Security_Options_{{ inventory_hostname }}.html"
        src: "{{ report_file }}"
        mode: put
        region: "{{ aws_region }}"
