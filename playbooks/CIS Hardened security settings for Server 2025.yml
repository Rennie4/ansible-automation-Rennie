---
- name: CIS Hardened security settings for Server 2025
  hosts: windows
  vars:
    s3_bucket: "oml-s3-automation-sandbox"
    s3_path: "cis-baseline-files/"
    aws_region: "eu-west-1"

  tasks:
    # 2.3.2.1: Devices: Prevent users from installing printer drivers
    - name: "2.3.2.1: Audit Printer Driver Installation"
      ansible.windows.win_regedit:
        path: HKLM:\SYSTEM\CurrentControlSet\Control\Print\Providers\LanMan Print Provider
        name: AddPrinterDrivers
        data: 1
        type: dword
      register: check_printer

    # 2.3.4.1: Domain member: Digitally encrypt or sign secure channel data (always)
    - name: "2.3.4.1: Audit Secure Channel Signing"
      ansible.windows.win_regedit:
        path: HKLM:\System\CurrentControlSet\Services\Netlogon\Parameters
        name: RequireSignOrSeal
        data: 1
        type: dword
      register: check_domain_sign

    # 2.3.9.1: Microsoft network server: Digitally sign communications (always)
    - name: "2.3.9.1: Audit SMB Signing (Always)"
      ansible.windows.win_regedit:
        path: HKLM:\System\CurrentControlSet\Services\LanmanServer\Parameters
        name: requiresecurenegotiate
        data: 1
        type: dword
      register: check_smb_server

    # 2.3.17.x: User Account Control: Switch to the secure desktop
    - name: "2.3.17.x: Audit UAC Secure Desktop"
      ansible.windows.win_regedit:
        path: HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System
        name: PromptOnSecureDesktop
        data: 1
        type: dword
      register: check_uac

    - name: Consolidate Audit Facts
      set_fact:
        audit_results:
          - { id: "2.3.2.1", category: "Devices", name: "Prevent printer driver install", changed: "{{ check_printer.changed }}" }
          - { id: "2.3.4.1", category: "Domain Member", name: "Secure Channel Signing", changed: "{{ check_domain_sign.changed }}" }
          - { id: "2.3.9.1", category: "MS Network Server", name: "SMB Signing (Always)", changed: "{{ check_smb_server.changed }}" }
          - { id: "2.3.17.x", category: "UAC", name: "Secure Desktop Prompts", changed: "{{ check_uac.changed }}" }

    - name: Generate Audit Report
      ansible.builtin.template:
        src: "CIS Hardened security settings for Server 2025.j2"
        dest: "C:\\temp\\Audit_{{ ansible_hostname }}.html"
      check_mode: false

    - name: Upload Report to S3
      amazon.aws.s3_object:
        bucket: "{{ s3_bucket }}"
        object: "{{ s3_path }}Audit_{{ ansible_hostname }}.html"
        src: "C:\\temp\\Audit_{{ ansible_hostname }}.html"
        region: "{{ aws_region }}"
        mode: put
      check_mode: false
