---
- name: CIS Hardened security settings for Server 2025
  hosts: all
  gather_facts: yes
  vars:
    s3_bucket: "oml-s3-automation-sandbox"
    s3_path: "cis-baseline-files/"
    aws_region: "eu-west-1"

  tasks:
    - name: "2.3.2.1: Audit Printer Driver Installation"
      ansible.windows.win_regedit:
        path: HKLM:\SYSTEM\CurrentControlSet\Control\Print\Providers\LanMan Print Provider
        name: AddPrinterDrivers
        data: 1
        type: dword
      register: check_printer

    - name: "2.3.4.1: Audit Secure Channel Signing"
      ansible.windows.win_regedit:
        path: HKLM:\System\CurrentControlSet\Services\Netlogon\Parameters
        name: RequireSignOrSeal
        data: 1
        type: dword
      register: check_domain_sign

    - name: "2.3.9.1: Audit SMB Signing (Always)"
      ansible.windows.win_regedit:
        path: HKLM:\System\CurrentControlSet\Services\LanmanServer\Parameters
        name: requiresecurenegotiate
        data: 1
        type: dword
      register: check_smb_server

    - name: "2.3.17.x: Audit UAC Secure Desktop"
      ansible.windows.win_regedit:
        path: HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System
        name: PromptOnSecureDesktop
        data: 1
        type: dword
      register: check_uac

    - name: Consolidate Audit Facts
      set_fact:
        audit_results:
          - { id: "2.3.2.1", category: "Devices", name: "Prevent printer driver install", changed: "{{ check_printer.changed }}" }
          - { id: "2.3.4.1", category: "Domain Member", name: "Secure Channel Signing", changed: "{{ check_domain_sign.changed }}" }
          - { id: "2.3.9.1", category: "MS Network Server", name: "SMB Signing (Always)", changed: "{{ check_smb_server.changed }}" }
          - { id: "2.3.17.x", category: "UAC", name: "Secure Desktop Prompts", changed: "{{ check_uac.changed }}" }

    - name: Generate Audit Report
      ansible.builtin.template:
        src: "../templates/server_2025_securitysettings.j2"
        dest: "C:\\temp\\Audit_{{ ansible_hostname }}.html"
      check_mode: false

    - name: Upload Report to S3 via PowerShell
      ansible.windows.win_shell: |
        Write-S3Object -BucketName "{{ s3_bucket }}" `
                       -Key "{{ s3_path }}Audit_{{ ansible_hostname {}}} .html" `
                       -File "C:\temp\Audit_{{ ansible_hostname }}.html" `
                       -Region "{{ aws_region }}" `
                       -AccessKey "{{ lookup('env', 'AWS_ACCESS_KEY_ID') }}" `
                       -SecretKey "{{ lookup('env', 'AWS_SECRET_ACCESS_KEY') }}"
      check_mode: false
