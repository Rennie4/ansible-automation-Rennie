---
- name: CIS Hardened settings for Server 2025
  hosts: windows
  vars:
    s3_bucket: "oml-s3-automation-sandbox"
    s3_path: "cis-baseline-files/"
    aws_region: "eu-west-1"

  tasks:
    # CIS 2.3.2.1: Devices - Prevent users from installing printer drivers
    # [cite_start]Path verified from CIS Benchmark v1.0.0 [cite: 2]
    - name: "2.3.2.1: Audit Printer Driver Installation"
      ansible.windows.win_regedit:
        path: HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Printers
        name: RegisterSpoolerRemoteRpcEndPoint
        data: 1
        type: dword
      register: check_printer

    # CIS 2.3.4.1: Domain Member - Secure channel signing
    - name: "2.3.4.1: Audit Secure Channel Signing"
      ansible.windows.win_regedit:
        path: HKLM:\System\CurrentControlSet\Services\Netlogon\Parameters
        name: RequireSignOrSeal
        data: 1
        type: dword
      register: check_domain_sign

    # CIS 2.3.17.x: UAC - Secure Desktop
    # [cite_start]Verified: Path and value from CIS Benchmark [cite: 4]
    - name: "2.3.17.x: Audit UAC Secure Desktop"
      ansible.windows.win_regedit:
        path: HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System
        name: PromptOnSecureDesktop
        data: 1
        type: dword
      register: check_uac

    - name: Consolidate Audit Results
      set_fact:
        audit_results:
          - { id: "2.3.2.1", category: "Devices", name: "Prevent printer driver install", changed: "{{ check_printer.changed }}" }
          - { id: "2.3.4.1", category: "Domain Member", name: "Secure Channel Signing", changed: "{{ check_domain_sign.changed }}" }
          - { id: "2.3.17.x", category: "UAC", name: "Secure Desktop Prompts", changed: "{{ check_uac.changed }}" }

    - name: Generate Audit Report
      ansible.builtin.template:
        src: "CIS Hardened settings for Server 2025.j2"
        dest: "C:\\temp\\Audit_{{ ansible_hostname }}.html"
      [cite_start]check_mode: false # Ensure report is created during 'check' run [cite: 6]

    - name: Upload Report to S3
      amazon.aws.s3_object:
        bucket: "{{ s3_bucket }}"
        object: "{{ s3_path }}Audit_{{ ansible_hostname }}.html"
        src: "C:\\temp\\Audit_{{ ansible_hostname }}.html"
        region: "{{ aws_region }}"
        mode: put
      check_mode: false # Ensure upload occurs during 'check' run
