---
- name: AWS Infrastructure - Resize EBS Volume
  hosts: localhost
  connection: local
  gather_facts: false
  tasks:
    - name: Get current volume info
      amazon.aws.ec2_vol_info:
        region: "eu-west-1"
        filters:
          volume-id: "{{ target_volume_id }}"
      register: vol_info

    - name: "Modify EBS volume {{ target_volume_id }} to {{ target_new_size }} GB"
      amazon.aws.ec2_vol:
        id: "{{ target_volume_id }}"
        volume_size: "{{ target_new_size }}"
        volume_type: gp3
        region: "eu-west-1"
        zone: "{{ vol_info.volumes[0].zone }}"
        modify_volume: true
      register: modification_result

    - name: Wait for AWS to register volume modification
      ansible.builtin.pause:
        seconds: 15
      when: modification_result.changed

    - name: Add target IP to temporary inventory
      ansible.builtin.add_host:
        name: "{{ target_ip }}"
        groups: dynamic_windows_hosts
        ansible_connection: winrm
        ansible_winrm_server_cert_validation: ignore

- name: Windows Configuration - Automatic Partition Extension
  hosts: dynamic_windows_hosts
  gather_facts: false
  tasks:
    - name: Find disk and Extend
      ansible.windows.win_shell: |
        $targetVolId = "{{ target_volume_id }}".Replace("-", "")
        Update-HostStorageCache
        
        # Identify disk by AWS Volume ID Serial
        $disk = Get-Disk | Where-Object { $_.SerialNumber -like "*$targetVolId*" }
        
        # Fallback for older instances or non-nitro
        if (-not $disk) {
            $disk = Get-Disk | Where-Object { $_.Number -ne 0 -and $_.AllocatableSize -gt 0 } | Select-Object -First 1
        }

        if ($disk) {
            $partition = $disk | Get-Partition | Where-Object { $_.DriveLetter }
            if ($partition) {
                $maxSize = (Get-PartitionSupportedSize -DiskNumber $disk.Number -PartitionNumber $partition.PartitionNumber).SizeMax
                Resize-Partition -DiskNumber $disk.Number -PartitionNumber $partition.PartitionNumber -Size $maxSize
                return "Successfully extended Drive $($partition.DriveLetter) on Disk $($disk.Number)"
            } else {
                throw "Partition with letter not found on Disk $($disk.Number)."
            }
        } else {
            throw "Disk matching {{ target_volume_id }} not found on host {{ target_ip }}."
        }
      register: resize_out

    - name: Final Result
      ansible.builtin.debug:
        msg: "{{ resize_out.stdout | default('Disk check complete') }}"
