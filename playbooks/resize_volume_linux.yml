
# =============================================================================
# Playbook: Resize EBS Volume and Expand Linux Filesystem (All Distros)
# Compatible with older amazon.aws collection where ec2_vol_info uses `filters`
# =============================================================================

# PLAY 1: AWS Infrastructure - Resize EBS Volume
- name: AWS Infrastructure - Resize Linux EBS Volume
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    region: "eu-west-1"
    target_ip: "{{ instance_ip_address }}"
    target_new_size: "{{ new_size_gb | int }}"
    survey_volume_id: "{{ volume_id | default('') }}"

  tasks:
    - name: Get instance details by public IP
      amazon.aws.ec2_instance_info:
        region: "{{ region }}"
        filters:
          ip-address: "{{ target_ip }}"
      register: instance_info

    - name: Fail if instance not found
      ansible.builtin.fail:
        msg: "No EC2 instance found with IP {{ target_ip }} in {{ region }}"
      when: instance_info.instances | length == 0

    - name: Set zone + volume ID facts
      ansible.builtin.set_fact:
        target_zone: "{{ instance_info.instances[0].placement.availability_zone }}"
        final_volume_id: >-
          {{
            survey_volume_id if (survey_volume_id | length > 5)
            else (
              instance_info.instances[0].block_device_mappings
              | selectattr('device_name','equalto',instance_info.instances[0].root_device_name)
              | map(attribute='ebs.volume_id')
              | first
            )
          }}

    - name: Show requested resize
      ansible.builtin.debug:
        msg: "Resizing volume {{ final_volume_id }} to {{ target_new_size }} GB"

    - name: Modify EBS volume
      amazon.aws.ec2_vol:
        region: "{{ region }}"
        zone: "{{ target_zone }}"
        id: "{{ final_volume_id }}"
        volume_size: "{{ target_new_size }}"
      register: aws_resize

    # Use `filters` (older collection compatibility) to read back the size
    - name: Get updated AWS volume size (filters for backward compatibility)
      amazon.aws.ec2_vol_info:
        region: "{{ region }}"
        filters:
          volume-id:
            - "{{ final_volume_id }}"
      register: updated_volume_info

    - name: Log AWS confirmed size
      ansible.builtin.debug:
        msg: >-
          AWS reports volume {{ final_volume_id }} is now
          {{ (updated_volume_info.volumes | first).size }} GB

    - name: Add instance to next play
      ansible.builtin.add_host:
        name: "{{ target_ip }}"
        groups: target_nodes
        ansible_user: "{{ ansible_user | default('ubuntu') }}"
        ansible_ssh_common_args: "-o StrictHostKeyChecking=no"
        host_volume_id: "{{ final_volume_id }}"
        requested_size: "{{ target_new_size }}"
        aws_confirmed_size: "{{ (updated_volume_info.volumes | first).size }}"


# PLAY 2: Resize Partition + Filesystem
- name: OS Expansion - Resize Linux Filesystem
  hosts: target_nodes
  become: true
  gather_facts: true

  tasks:
    - name: Install growpart packages (best-effort across distros)
      ansible.builtin.package:
        name:
          - cloud-guest-utils          # Debian/Ubuntu
          - cloud-utils-growpart       # RHEL/Amazon/SUSE
          - cloud-utils                # Fallback provider of growpart
        state: present
      ignore_errors: true

    - name: Install filesystem tools
      ansible.builtin.package:
        name:
          - xfsprogs
