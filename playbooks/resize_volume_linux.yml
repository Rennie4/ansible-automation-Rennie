---
# PLAY 1: AWS Infrastructure Modification
- name: AWS Infrastructure - Resize Linux EBS Volume
  hosts: localhost
  connection: local
  gather_facts: false
  vars:
    region: "eu-west-1"
    # Variables mapped from your AAP Survey
    target_ip: "{{ instance_ip_address }}"
    target_new_size: "{{ new_size_gb }}"
    survey_volume_id: "{{ volume_id | default('') }}"

  tasks:
    - name: Get Instance and Zone details from AWS
      amazon.aws.ec2_instance_info:
        region: "{{ region }}"
        filters:
          ip-address: "{{ target_ip }}"
      register: instance_info

    - name: Set Volume and Zone Facts
      set_fact:
        target_zone: "{{ instance_info.instances[0].placement.availability_zone }}"
        # Logic: If Survey ID is blank, automatically target the Root Volume
        final_volume_id: >-
          {{ 
            survey_volume_id if (survey_volume_id | length > 5) else 
            (instance_info.instances[0].block_device_mappings | 
            selectattr('device_name', 'equalto', instance_info.instances[0].root_device_name) | 
            map(attribute='ebs.volume_id') | first) 
          }}

    - name: Modify EBS volume in AWS Console
      amazon.aws.ec2_vol:
        region: "{{ region }}"
        zone: "{{ target_zone }}"
        id: "{{ final_volume_id }}"
        volume_size: "{{ target_new_size }}"

    - name: Wait for AWS backend optimization
      ansible.builtin.pause:
        seconds: 30

    - name: Add host to dynamic inventory for Play 2
      ansible.builtin.add_host:
        name: "{{ target_ip }}"
        groups: target_nodes
        # Defaults to 'ubuntu' based on your instance name, but respects credentials
        ansible_user: "{{ ansible_user | default('ubuntu') }}"
        ansible_ssh_common_args: "-o StrictHostKeyChecking=no"
        host_volume_id: "{{ final_volume_id }}"

# PLAY 2: OS Level Expansion & Verification
- name: OS Configuration - Expand Filesystem
  hosts: target_nodes
  become: true
  gather_facts: true

  tasks:
    - name: Install Cloud Utils if missing
      ansible.builtin.package:
        name: 
          - "{{ (ansible_os_family == 'Debian') | ternary('cloud-guest-utils', 'cloud-utils-growpart') }}"
        state: present

    - name: Expand Partition and Filesystem
      vars:
        # Clean the ID for matching against 'lsblk' serials
        clean_id: "{{ host_volume_id | replace('vol-', 'vol') }}"
      shell: |
        # Find device using serial (using 'cut' instead of 'awk' to avoid Jinja errors)
        DEV_NAME=$(lsblk -dno NAME,SERIAL | grep "{{ clean_id }}" | cut -d' ' -f1)
        
        if [ -n "$DEV_NAME" ]; then
          DEV_PATH="/dev/$DEV_NAME"
          # Get partition number (usually 1)
          P_NUM=$(lsblk -no PARTN "$DEV_PATH" | head -n 1)
          
          # 1. Grow partition
          growpart "$DEV_PATH" "$P_NUM" || echo "Already grown"
          
          # 2. Grow Filesystem (Detects XFS vs EXT4)
          F_TYPE=$(findmnt -n -o FSTYPE /)
          if [ "$F_TYPE" = "xfs" ]; then
            xfs_growfs /
          else
            R_DEV=$(findmnt -n -o SOURCE /)
            resize2fs "$R_DEV"
          fi
        else
          echo "Volume {{ clean_id }} not found on this OS"
          exit 1
        fi
      register: resize_result

    - name: VERIFICATION - Check Physical Disk Size
      command: lsblk -dno NAME,SIZE
      register: block_check

    - name: VERIFICATION - Check Filesystem Size
      command: df -h /
      register: fs_check

    - name: FINAL REPORT
      debug:
        msg: 
          - "AWS Volume ID: {{ host_volume_id }}"
          - "Physical Disks found: {{ block_check.stdout_lines }}"
          - "Usable Filesystem: {{ fs_check.stdout_lines[1] }}"
