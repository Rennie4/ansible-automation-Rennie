---
- name: AWS Infrastructure - Resize Linux EBS Volume
  hosts: localhost
  connection: local
  gather_facts: false
  vars:
    region: "eu-west-1"
    # Survey Mapping
    target_ip: "{{ instance_ip_address }}"
    target_new_size: "{{ new_size_gb }}"
    survey_volume_id: "{{ volume_id | default('') }}"

  tasks:
    - name: Get Instance and Zone details
      amazon.aws.ec2_instance_info:
        region: "{{ region }}"
        filters:
          ip-address: "{{ target_ip }}"
      register: instance_info

    - name: Set Volume and Zone Facts
      set_fact:
        target_zone: "{{ instance_info.instances[0].placement.availability_zone }}"
        # Reusable logic: Use survey ID if provided, otherwise find Root automatically
        final_volume_id: >-
          {{ 
            survey_volume_id if (survey_volume_id | length > 5) else 
            (instance_info.instances[0].block_device_mappings | 
            selectattr('device_name', 'equalto', instance_info.instances[0].root_device_name) | 
            map(attribute='ebs.volume_id') | first) 
          }}

    - name: Modify EBS volume in AWS
      amazon.aws.ec2_vol:
        region: "{{ region }}"
        zone: "{{ target_zone }}"
        id: "{{ final_volume_id }}"
        volume_size: "{{ target_new_size }}"

    - name: Wait for AWS propagation
      ansible.builtin.pause:
        seconds: 30

    - name: Add host to dynamic inventory
      ansible.builtin.add_host:
        name: "{{ target_ip }}"
        groups: target_nodes
        # Use survey/credential defaults for reusability
        ansible_user: "{{ ansible_user | default('ubuntu') }}" 
        ansible_ssh_common_args: "-o StrictHostKeyChecking=no"

- name: OS Configuration - Expand Filesystem
  hosts: target_nodes
  become: true
  gather_facts: true

  tasks:
    - name: Expand Partition and Filesystem
      shell: |
        # Use the volume ID to find the correct device among many
        CLEAN_VOL_ID="{{ final_volume_id | replace('vol-', 'vol') }}"
        DEVICE_PATH=$(lsblk -dno NAME,SERIAL | grep "$CLEAN_VOL_ID" | awk '{print "/dev/"$1}')
        PART_NUM=$(lsblk -no PARTN $DEVICE_PATH | head -n 1)
        
        # Grow partition and resize FS (XFS or EXT4)
        growpart $DEVICE_PATH $PART_NUM || true
        
        FS_TYPE=$(findmnt -n -o FSTYPE /)
        if [ "$FS_TYPE" == "xfs" ]; then
            xfs_growfs /
        else
            resize2fs ${DEVICE_PATH}${PART_NUM}
        fi
      register: resize_result

    - name: Verify Size
      command: df -h /
      register: final_size

    - name: Final Result
      debug:
        var: final_size.stdout_lines
