---
- name: AWS Infrastructure - Resize Linux EBS Volume
  hosts: localhost
  connection: local
  gather_facts: false
  vars:
    region: "eu-west-1"
    # Survey variables
    target_ip: "{{ instance_ip_address }}"
    target_new_size: "{{ new_size_gb }}"
    survey_volume_id: "{{ volume_id | default('') }}"

  tasks:
    - name: Get Instance and Zone details
      amazon.aws.ec2_instance_info:
        region: "{{ region }}"
        filters:
          ip-address: "{{ target_ip }}"
      register: instance_info

    - name: Determine Volume ID to use
      set_fact:
        target_zone: "{{ instance_info.instances[0].placement.availability_zone }}"
        # Logic: Use survey ID if provided, otherwise find the Root Volume ID
        final_volume_id: >-
          {{ 
            survey_volume_id if survey_volume_id != '' else 
            (instance_info.instances[0].block_device_mappings | 
            selectattr('device_name', 'equalto', instance_info.instances[0].root_device_name) | 
            map(attribute='ebs.volume_id') | first) 
          }}

    - name: Modify EBS volume in AWS
      amazon.aws.ec2_vol:
        region: "{{ region }}"
        zone: "{{ target_zone }}"
        id: "{{ final_volume_id }}"
        volume_size: "{{ target_new_size }}"
      register: volume_modification

    - name: Wait for AWS propagation
      ansible.builtin.pause:
        seconds: 20

    - name: Add host to dynamic inventory
      ansible.builtin.add_host:
        name: "{{ target_ip }}"
        groups: target_nodes
        ansible_user: ec2-user 

- name: OS Configuration - Expand Filesystem
  hosts: target_nodes
  become: true
  gather_facts: true

  tasks:
    - name: Universal Partition and Filesystem Expansion
      shell: |
        # 1. Detect device associated with the volume (works even with 10+ drives)
        # We use the serial because AWS Volume IDs match the device serial
        TARGET_VOL="{{ final_volume_id | replace('vol-', 'vol') }}"
        DEVICE_PATH=$(lsblk -dno NAME,SERIAL | grep "$TARGET_VOL" | awk '{print "/dev/"$1}')
        
        # 2. Identify partition (assumes 1st partition, common for EBS)
        PART_NUM=$(lsblk -no PARTN $DEVICE_PATH | head -n 1)
        
        # 3. Grow partition and resize FS
        growpart $DEVICE_PATH $PART_NUM || true
        
        FS_TYPE=$(findmnt -n -o FSTYPE $DEVICE_PATH$PART_NUM)
        if [ "$FS_TYPE" == "xfs" ]; then
            xfs_growfs $DEVICE_PATH$PART_NUM || xfs_growfs /
        else
            resize2fs $DEVICE_PATH$PART_NUM
        fi
      register: resize_result

    - name: Final Disk Summary
      debug:
        msg: "The volume {{ final_volume_id }} has been expanded successfully."
