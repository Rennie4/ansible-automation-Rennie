---
- name: AWS Infrastructure - Resize Linux EBS Volume
  hosts: localhost
  connection: local
  gather_facts: false
  vars:
    region: "eu-west-1"
    # Survey Mapping
    target_ip: "{{ instance_ip_address }}"
    target_new_size: "{{ new_size_gb }}"
    survey_volume_id: "{{ volume_id | default('') }}"

  tasks:
    - name: Get Instance and Zone details
      amazon.aws.ec2_instance_info:
        region: "{{ region }}"
        filters:
          ip-address: "{{ target_ip }}"
      register: instance_info

    - name: Set Volume and Zone Facts
      set_fact:
        target_zone: "{{ instance_info.instances[0].placement.availability_zone }}"
        # Use Survey ID if provided; otherwise, find the Root Volume automatically
        final_volume_id: >-
          {{ 
            survey_volume_id if (survey_volume_id | length > 5) else 
            (instance_info.instances[0].block_device_mappings | 
            selectattr('device_name', 'equalto', instance_info.instances[0].root_device_name) | 
            map(attribute='ebs.volume_id') | first) 
          }}

    - name: Modify EBS volume in AWS
      amazon.aws.ec2_vol:
        region: "{{ region }}"
        zone: "{{ target_zone }}"
        id: "{{ final_volume_id }}"
        volume_size: "{{ target_new_size }}"
      register: volume_modification

    - name: Wait for AWS propagation
      ansible.builtin.pause:
        seconds: 20

    - name: Add host to dynamic inventory
      ansible.builtin.add_host:
        name: "{{ target_ip }}"
        groups: target_nodes
        ansible_user: ec2-user 

- name: OS Configuration - Expand Filesystem
  hosts: target_nodes
  become: true
  gather_facts: true

  tasks:
    - name: Install resize tools
      ansible.builtin.package:
        name: 
          - "{{ (ansible_os_family == 'Debian') | ternary('cloud-guest-utils', 'cloud-utils-growpart') }}"
          - gdisk
        state: present

    - name: Universal Partition and Filesystem Expansion
      shell: |
        # 1. Identify which device is the one we resized
        # (AWS Volume IDs 'vol-xxx' show up as 'volxxx' in serials)
        CLEAN_VOL_ID="{{ final_volume_id | replace('vol-', 'vol') }}"
        DEVICE_PATH=$(lsblk -dno NAME,SERIAL | grep "$CLEAN_VOL_ID" | awk '{print "/dev/"$1}')
        
        # 2. Find the partition number (e.g., 1 or 128 for NVMe)
        PART_NUM=$(lsblk -no PARTN $DEVICE_PATH | head -n 1)
        
        # 3. Grow partition and resize FS (XFS or EXT4)
        growpart $DEVICE_PATH $PART_NUM || true
        
        FS_TYPE=$(findmnt -n -o FSTYPE ${DEVICE_PATH}${PART_NUM} | head -n 1)
        if [ "$FS_TYPE" == "xfs" ]; then
            xfs_growfs /
        else
            resize2fs ${DEVICE_PATH}${PART_NUM}
        fi
      register: resize_result

    - name: Final Disk Summary
      debug:
        msg: "Volume {{ final_volume_id }} resized. Current / size: {{ ansible_mounts | selectattr('mount', 'equalto', '/') | map(attribute='size_total') | first | human_readable }}"
