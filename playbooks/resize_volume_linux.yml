---
- name: AWS Infrastructure - Resize Linux EBS Volume
  hosts: localhost
  connection: local
  gather_facts: false
  vars:
    region: "eu-west-1"
    target_ip: "{{ instance_ip_address }}"
    target_new_size: "{{ new_size_gb }}"

  tasks:
    - name: Get Instance ID and Zone from IP Address
      amazon.aws.ec2_instance_info:
        region: "{{ region }}"
        filters:
          ip-address: "{{ target_ip }}"
      register: instance_info

    - name: Set Instance Details
      set_fact:
        target_instance_id: "{{ instance_info.instances[0].instance_id }}"
        target_zone: "{{ instance_info.instances[0].placement.availability_zone }}"

    - name: Get current volume info
      amazon.aws.ec2_vol_info:
        region: "{{ region }}"
        filters:
          attachment.instance-id: "{{ target_instance_id }}"
          attachment.device: ["/dev/sda1", "/dev/xvda", "/dev/nvme0n1", "/dev/nvme0n1p1"]
      register: vol_info

    - name: Modify EBS volume
      amazon.aws.ec2_vol:
        region: "{{ region }}"
        zone: "{{ target_zone }}"
        id: "{{ vol_info.volumes[0].id }}"
        volume_size: "{{ target_new_size }}"
      register: volume_modification
      ignore_errors: yes

    - name: Wait for AWS backend
      ansible.builtin.pause:
        seconds: 30 # Increased wait time to ensure blocks are available

    - name: Add target IP to temporary inventory
      ansible.builtin.add_host:
        name: "{{ target_ip }}"
        groups: target_nodes
        ansible_ssh_private_key_file: "/runner/artifacts/2162/ssh_key_data"
        ansible_user: ec2-user

- name: OS Configuration - Universal Multi-Distro Setup
  hosts: target_nodes
  become: true
  gather_facts: true

  tasks:
    - name: Capture size before resize
      command: df -h / --output=size
      register: size_before
      changed_when: false

    - name: Ensure resize tools are present
      ansible.builtin.package:
        name: [cloud-utils-growpart, gdisk]
        state: present

    - name: Universal Device Discovery and Force Rescan
      shell: |
        # 1. Discover device details
        SPECIFIC_DEV=$(findmnt / -n -o SOURCE)
        PARENT_DISK=$(lsblk -no PKNAME $SPECIFIC_DEV)
        PART_NUM=$(lsblk -no PARTN $SPECIFIC_DEV)

        # 2. Force the Kernel to rescan the disk hardware
        echo 1 > /sys/class/block/${PARENT_DISK}/device/rescan || true
        
        # 3. Expand the partition table
        growpart /dev/$PARENT_DISK $PART_NUM || echo "Already grown"

        # 4. Expand the Filesystem
        FS_TYPE=$(findmnt / -n -o FSTYPE)
        if [ "$FS_TYPE" == "xfs" ]; then
          xfs_growfs /
        else
          resize2fs $SPECIFIC_DEV
        fi
      register: resize_out

    - name: Capture size after resize
      command: df -h / --output=size
      register: size_after
      changed_when: false

    - name: Final Disk Summary
      debug:
        msg: 
          - "-------------------------------------------"
          - "OLD DISK SIZE: {{ size_before.stdout_lines[1] | trim }}"
          - "NEW DISK SIZE: {{ size_after.stdout_lines[1] | trim }}"
          - "-------------------------------------------"
