---
- name: AWS Infrastructure - Resize Linux EBS Volume
  hosts: localhost
  connection: local
  gather_facts: false
  vars:
    # Variables pulled from your AAP Survey
    region: "eu-west-1"
    volume_id: "{{ target_volume_id }}"
    new_size: "{{ target_new_size }}"

  tasks:
    - name: Get current volume info
      amazon.aws.ec2_vol_info:
        region: "{{ region }}"
        filters:
          volume-id: "{{ volume_id }}"
      register: vol_info

    - name: "Modify EBS volume {{ volume_id }} to {{ new_size }} GB"
      amazon.aws.ec2_vol:
        id: "{{ volume_id }}"
        volume_size: "{{ new_size }}"
        region: "{{ region }}"
        zone: "{{ vol_info.volumes[0].zone }}"
        modify_volume: true
      register: resize_result
      ignore_errors: yes # Bypasses the 6-hour AWS limit so the OS part can still run

    - name: Wait for AWS backend
      pause:
        seconds: 30
      when: resize_result.changed

- name: OS Configuration - Universal Multi-Distro Setup
  hosts: linux_hosts
  become: yes
  vars:
    # Removes dashes to match the Hardware Serial (e.g., vol0e35...)
    vol_id_short: "{{ target_volume_id | replace('-', '') }}"
  tasks:
    - name: Ensure resize tools are present (Distro Agnostic)
      package:
        name: 
          - cloud-utils-growpart
          - cloud-guest-utils
        state: present
      ignore_errors: true

    - name: Universal Device Discovery and Resize
      shell: |
        # 1. Search by AWS Serial (Best for Nitro/Newer Instances)
        DEVICE=$(lsblk -dpno NAME,SERIAL | grep "{{ vol_id_short }}" | awk '{print $1}')
        
        # 2. Fallback: Search by Size matching Survey (Best for Xen/Legacy)
        if [ -z "$DEVICE" ]; then
          DEVICE=$(lsblk -dpno NAME,SIZE,MOUNTPOINT | grep "{{ target_new_size }}G" | grep -v "/$" | awk '{print $1}' | head -n 1)
        fi

        if [ -n "$DEVICE" ]; then
          # Refresh hardware state
          echo 1 > /sys/class/block/$(basename $DEVICE)/device/rescan
          
          # 3. Handle Empty vs Existing Disks
          if ! blkid $DEVICE; then
              echo "New disk detected. Initializing..."
              mkfs.ext4 -F $DEVICE
              mkdir -p /mnt/data
              mount $DEVICE /mnt/data
          else
              echo "Existing disk detected. Analyzing layout..."
              # Grow partition if it exists (handles sda1, xvda1, nvme0n1p1)
              growpart $DEVICE 1 || growpart $DEVICE 2 || echo "No partition to grow (Raw Disk)"
              
              # Force resize based on filesystem type (EXT4 or XFS)
              # Checks for partition first, then falls back to raw device
              if blkid ${DEVICE}1 || blkid ${DEVICE}p1; then
                  PART=$(lsblk -np -o NAME $DEVICE | sed -n '2p')
                  resize2fs $PART || xfs_growfs $PART || xfs_growfs /
              else
                  resize2fs $DEVICE || xfs_growfs $DEVICE || xfs_growfs /
              fi
          fi
          
          # Final report for logs
          echo "TARGET_DEVICE: $DEVICE"
          df -h $DEVICE || df -h /
        else
          echo "ERROR: Could not find disk matching Volume ID or Size {{ target_new_size }}G"
          exit 1
        fi
      register: linux_resize_out

    - name: Report Final Status
      debug:
        msg: "{{ linux_resize_out.stdout_lines }}"
