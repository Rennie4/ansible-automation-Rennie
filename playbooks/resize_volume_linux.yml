
# =============================================================================
# Playbook: Resize EBS Volume and Expand Linux Filesystem (All Distros)
# =============================================================================

# PLAY 1: AWS Infrastructure - Resize EBS Volume
- name: AWS Infrastructure - Resize Linux EBS Volume
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    region: "eu-west-1"
    target_ip: "{{ instance_ip_address }}"
    target_new_size: "{{ new_size_gb | int }}"
    survey_volume_id: "{{ volume_id | default('') }}"

  tasks:
    - name: Get instance details by public IP
      amazon.aws.ec2_instance_info:
        region: "{{ region }}"
        filters:
          ip-address: "{{ target_ip }}"
      register: instance_info

    - name: Fail if instance not found
      ansible.builtin.fail:
        msg: "No EC2 instance found with IP {{ target_ip }} in {{ region }}"
      when: instance_info.instances | length == 0

    - name: Set zone + volume ID facts
      ansible.builtin.set_fact:
        target_zone: "{{ instance_info.instances[0].placement.availability_zone }}"
        final_volume_id: >-
          {{
            survey_volume_id if (survey_volume_id | length > 5)
            else (
              instance_info.instances[0].block_device_mappings
              | selectattr('device_name','equalto',instance_info.instances[0].root_device_name)
              | map(attribute='ebs.volume_id')
              | first
            )
          }}

    - name: Show requested resize
      debug:
        msg: "Resizing volume {{ final_volume_id }} to {{ target_new_size }} GB"

    - name: Modify EBS volume
      amazon.aws.ec2_vol:
        region: "{{ region }}"
        zone: "{{ target_zone }}"
        id: "{{ final_volume_id }}"
        volume_size: "{{ target_new_size }}"
      register: aws_resize

    - name: Get updated AWS volume size
      amazon.aws.ec2_vol_info:
        region: "{{ region }}"
        volume_ids:
          - "{{ final_volume_id }}"
      register: updated_volume_info

    - name: Log AWS confirmed size
      debug:
        msg: "AWS reports volume {{ final_volume_id }} is now {{ updated_volume_info.volumes[0].size }} GB"

    - name: Add instance to next play
      add_host:
        name: "{{ target_ip }}"
        groups: target_nodes
        ansible_user: "{{ ansible_user | default('ubuntu') }}"
        ansible_ssh_common_args: "-o StrictHostKeyChecking=no"
        host_volume_id: "{{ final_volume_id }}"
        requested_size: "{{ target_new_size }}"
        aws_confirmed_size: "{{ updated_volume_info.volumes[0].size }}"


# PLAY 2: Resize Partition + Filesystem
- name: OS Expansion - Resize Linux Filesystem
  hosts: target_nodes
  become: true
  gather_facts: true

  tasks:
    - name: Install growpart packages
      package:
        name:
          - cloud-guest-utils
          - cloud-utils-growpart
          - cloud-utils
        state: present
      ignore_errors: true

    - name: Install fs tools
      package:
        name:
          - xfsprogs
          - e2fsprogs
        state: present
      ignore_errors: true

    - name: Verify growpart exists
      command: command -v growpart
      register: growpart_ok
      changed_when: false
      failed_when: growpart_ok.rc != 0

    - name: Expand root partition + filesystem
      shell: |
        set -e

        ROOT_SRC=$(findmnt -n -o SOURCE /)
        PKNAME=$(lsblk -no PKNAME "$ROOT_SRC" | head -n1)
        DEV="/dev/$PKNAME"

        PARTNUM=$(lsblk -no PARTNUM "$ROOT_SRC" | head -n1)
        [ -z "$PARTNUM" ] && PARTNUM="1"

        growpart "$DEV" "$PARTNUM" || true

        FSTYPE=$(findmnt -n -o FSTYPE /)
        if [ "$FSTYPE" = "xfs" ]; then
          xfs_growfs /
        else
          resize2fs "$ROOT_SRC"
        fi
      register: resize_result
      changed_when: false

    - name: Detect root device
      shell: |
        ROOT_SRC=$(findmnt -n -o SOURCE /)
        PKNAME=$(lsblk -no PKNAME "$ROOT_SRC")
        echo "/dev/$PKNAME"
      register: root_disk
      changed_when: false

    - name: Get physical disk size
      command: lsblk -dn -o SIZE {{ root_disk.stdout }}
      register: disk_size
      changed_when: false

    - name: Get filesystem size
      command: df -hT /
      register: fs_size
      changed_when: false

    - name: FINAL REPORT
      debug:
        msg:
          - "AWS Volume ID: {{ host_volume_id }}"
          - "Requested Size: {{ requested_size }} GB"
          - "AWS Reported Size: {{ aws_confirmed_size }} GB"
          - "Linux Block Device Size: {{ disk_size.stdout }}"
          - "Filesystem: {{ fs_size.stdout_lines[1] }}"
