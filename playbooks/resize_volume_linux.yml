---
# PLAY 1: AWS Infrastructure Modification
- name: AWS Infrastructure - Resize Linux EBS Volume
  hosts: localhost
  connection: local
  gather_facts: false
  vars:
    region: "eu-west-1"
    target_ip: "{{ instance_ip_address }}"
    target_new_size: "{{ new_size_gb }}"
    survey_volume_id: "{{ volume_id | default('') }}"

  tasks:
    - name: Get Instance and Zone details from AWS
      amazon.aws.ec2_instance_info:
        region: "{{ region }}"
        filters:
          ip-address: "{{ target_ip }}"
      register: instance_info

    - name: Set Volume and Zone Facts
      set_fact:
        target_zone: "{{ instance_info.instances[0].placement.availability_zone }}"
        # Logic: If Survey ID is blank, automatically target the Root Volume
        final_volume_id: >-
          {{ 
            survey_volume_id if (survey_volume_id | length > 5) else 
            (instance_info.instances[0].block_device_mappings | 
            selectattr('device_name', 'equalto', instance_info.instances[0].root_device_name) | 
            map(attribute='ebs.volume_id') | first) 
          }}

    - name: Modify EBS volume in AWS Console
      amazon.aws.ec2_vol:
        region: "{{ region }}"
        zone: "{{ target_zone }}"
        id: "{{ final_volume_id }}"
        volume_size: "{{ target_new_size }}"

    - name: Wait for AWS backend optimization
      ansible.builtin.pause:
        seconds: 30

    - name: Add host to dynamic inventory
      ansible.builtin.add_host:
        name: "{{ target_ip }}"
        groups: target_nodes
        ansible_user: "{{ ansible_user | default('ubuntu') }}"
        ansible_ssh_common_args: "-o StrictHostKeyChecking=no"
        # PASSING THE VARIABLE TO THE HOST HERE FIXES THE ERROR
        host_volume_id: "{{ final_volume_id }}"

# PLAY 2: OS Level Expansion
- name: OS Configuration - Expand Filesystem
  hosts: target_nodes
  become: true
  gather_facts: true

  tasks:
    - name: Install Cloud Utils if missing
      ansible.builtin.package:
        name: 
          - "{{ (ansible_os_family == 'Debian') | ternary('cloud-guest-utils', 'cloud-utils-growpart') }}"
        state: present

    - name: Expand Partition and Filesystem
      shell: |
        # Use the variable passed from the first play
        CLEAN_VOL_ID="{{ host_volume_id | replace('vol-', 'vol') }}"
        DEVICE_NAME=$(lsblk -dno NAME,SERIAL | grep "$CLEAN_VOL_ID" | awk '{print $1}')
        DEVICE_PATH="/dev/$DEVICE_NAME"
        PART_NUM=$(lsblk -no PARTN $DEVICE_PATH | head -n 1)
        
        growpart $DEVICE_PATH $PART_NUM || echo "Already grown"
        
        FS_TYPE=$(findmnt -n -o FSTYPE /)
        if [ "$FS_TYPE" == "xfs" ]; then
            xfs_growfs /
        else
            resize2fs ${DEVICE_PATH}${PART_NUM}
        fi
      register: resize_result

    - name: Final Disk Summary
      command: df -h /
      register: final_disk_output

    - name: Display Result
      debug:
        msg: "Success! New Disk State: {{ final_disk_output.stdout_lines[1] }}"
