---
- name: AWS Infrastructure - Resize Linux EBS Volume
  hosts: localhost
  connection: local
  gather_facts: false
  vars:
    # Set to your specific region to prevent 'undefined' errors
    region: "eu-west-1"
    target_instance_id: "{{ instance_id }}"

  tasks:
    - name: Get current volume info
      amazon.aws.ec2_vol_info:
        region: "{{ region }}"
        filters:
          attachment.instance-id: "{{ target_instance_id }}"
          # Checks all common AWS device mappings to find the root volume
          attachment.device: ["/dev/sda1", "/dev/xvda", "/dev/nvme0n1", "/dev/nvme0n1p1"]
      register: vol_info

    - name: Modify EBS volume
      amazon.aws.ec2_vol:
        region: "{{ region }}"
        id: "{{ vol_info.volumes[0].id }}"
        # new_size must be passed as an extra var at runtime
        volume_size: "{{ new_size }}"
      register: volume_modification

    - name: Wait for AWS backend to present new blocks
      ansible.builtin.pause:
        seconds: 20

    - name: Add target IP to temporary inventory
      ansible.builtin.add_host:
        name: "{{ target_public_ip }}"
        groups: target_nodes
        ansible_ssh_private_key_file: "/runner/artifacts/2139/ssh_key_data"
        ansible_user: "{{ remote_user | default('ec2-user') }}"

- name: OS Configuration - Universal Multi-Distro Setup
  hosts: target_nodes
  become: true
  gather_facts: true

  tasks:
    - name: Ensure resize tools are present
      ansible.builtin.package:
        name:
          - cloud-utils-growpart
          - gdisk
        state: present

    - name: Universal Device Discovery and Resize
      shell: |
        # Find the device name for the root partition (e.g., /dev/nvme0n1p1)
        ROOT_PART=$(findmnt / -n -o SOURCE)
        
        # Find the parent disk (e.g., /dev/nvme0n1)
        PARENT_DISK=$(lsblk -no PKNAME $ROOT_PART)
        
        # Find the partition number (e.g., 1)
        PART_NUM=$(lsblk -no PARTN $ROOT_PART)

        # 1. Expand the partition table
        # We use /dev/$PARENT_DISK to ensure we target the physical device
        growpart /dev/$PARENT_DISK $PART_NUM || echo "Partition already grown"

        # 2. Expand the Filesystem
        FS_TYPE=$(findmnt / -n -o FSTYPE)
        if [ "$FS_TYPE" == "xfs" ]; then
          xfs_growfs /
        else
          resize2fs $ROOT_PART
        fi
      register: resize_out

    - name: Report Final Status
      debug:
        msg: "{{ resize_out.stdout_lines }}"
