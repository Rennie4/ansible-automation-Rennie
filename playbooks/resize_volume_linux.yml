
# =============================================================================
# Playbook: Resize EBS Volume and Expand Linux Filesystem (All Distros)
# Goal: Clear AAP logs showing AWS volume size and Linux disk/fs size
# Notes: Compatible with older amazon.aws collection (uses `filters` in ec2_vol_info)
# Vars required via Survey/Extra Vars: instance_ip_address, new_size_gb
# Optional: volume_id (if not provided, root volume is auto-selected), ansible_user
# =============================================================================

# PLAY 1: AWS Infrastructure - Determine, Compare, Modify
- name: AWS Infrastructure - Resize Linux EBS Volume
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    region: "eu-west-1"
    target_ip: "{{ instance_ip_address }}"
    requested_size: "{{ new_size_gb | int }}"
    survey_volume_id: "{{ volume_id | default('') }}"

  tasks:
    - name: Get instance details by public IP
      amazon.aws.ec2_instance_info:
        region: "{{ region }}"
        filters:
          ip-address: "{{ target_ip }}"
      register: instance_info

    - name: Fail if instance not found
      ansible.builtin.fail:
        msg: "No EC2 instance found with IP {{ target_ip }} in {{ region }}"
      when: instance_info.instances | length == 0

    - name: Set zone + volume ID facts (auto-pick root volume if survey ID empty)
      ansible.builtin.set_fact:
        target_zone: "{{ instance_info.instances[0].placement.availability_zone }}"
        instance_id: "{{ instance_info.instances[0].instance_id }}"
        root_device_name: "{{ instance_info.instances[0].root_device_name }}"
        final_volume_id: >-
          {{
            survey_volume_id if (survey_volume_id | length > 5)
            else (
              instance_info.instances[0].block_device_mappings
              | selectattr('device_name','equalto',instance_info.instances[0].root_device_name)
              | map(attribute='ebs.volume_id')
              | first
            )
          }}

    - name: DEBUG - Selected instance and volume context
      ansible.builtin.debug:
        msg:
          - "Instance: {{ instance_id }} (AZ: {{ target_zone }})"
          - "Root device name: {{ root_device_name }}"
          - "Target Volume ID: {{ final_volume_id }}"
          - "Requested new size: {{ requested_size }} GB"

    - name: AWS READ - Current volume info (by volume-id filter)
      amazon.aws.ec2_vol_info:
        region: "{{ region }}"
        filters:
          volume-id:
            - "{{ final_volume_id }}"
      register: current_vol

    - name: Set current size fact (from AWS)
      ansible.builtin.set_fact:
        current_size: "{{ (current_vol.volumes | first).size | int }}"
        current_vol_type: "{{ (current_vol.volumes | first).type | default('unknown') }}"
        current_state: "{{ (current_vol.volumes | first).state | default('unknown') }}"

    - name: LOG - Current AWS size before modify
      ansible.builtin.debug:
        msg:
          - "AWS current size for {{ final_volume_id }}: {{ current_size }} GB"
          - "Volume type: {{ current_vol_type }}, state: {{ current_state }}"

    - name: CONDITIONAL - Skip modify when requested size <= current size
      ansible.builtin.debug:
        msg: >-
          Skipping modify: requested size ({{ requested_size }} GB) is not greater
          than current size ({{ current_size }} GB).
      when: requested_size | int <= current_size | int

    - name: Modify EBS volume (only when increasing)
      amazon.aws.ec2_vol:
        region: "{{ region }}"
        zone: "{{ target_zone }}"
        id: "{{ final_volume_id }}"
        volume_size: "{{ requested_size }}"
      register: aws_resize
      when: requested_size | int > current_size | int

    - name: LOG - Modify result (if attempted)
      ansible.builtin.debug:
        var: aws_resize
      when: requested_size | int > current_size | int

    - name: AWS READ - Updated size after modify (always read once)
      amazon.aws.ec2_vol_info:
        region: "{{ region }}"
        filters:
          volume-id:
            - "{{ final_volume_id }}"
      register: updated_vol

    - name: Set updated size fact
      ansible.builtin.set_fact:
        aws_confirmed_size: "{{ (updated_vol.volumes | first).size | int }}"
        aws_mod_state: "{{ (updated_vol.volumes | first).state | default('unknown') }}"

