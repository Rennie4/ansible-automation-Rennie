---
- name: AWS Infrastructure - Resize Linux EBS Volume
  hosts: localhost
  connection: local
  gather_facts: false
  tasks:
    - name: Get current volume info
      amazon.aws.ec2_vol_info:
        region: "eu-west-1"
        filters:
          volume-id: "{{ target_volume_id }}"
      register: vol_info

    - name: "Modify EBS volume {{ target_volume_id }} to {{ target_new_size }} GB"
      amazon.aws.ec2_vol:
        id: "{{ target_volume_id }}"
        volume_size: "{{ target_new_size }}"
        volume_type: gp3
        region: "eu-west-1"
        zone: "{{ vol_info.volumes[0].zone }}"
        modify_volume: true
      register: resize_result

    - name: Wait for AWS backend
      ansible.builtin.pause:
        seconds: 20
      when: resize_result.changed

    - name: Add target IP to temporary inventory
      ansible.builtin.add_host:
        name: "{{ target_ip }}"
        groups: dynamic_linux_hosts
        # These lines ensure the credentials you provided in AAP are passed to the IP
        ansible_user: "{{ ansible_user | default('ubuntu') }}"
        ansible_ssh_private_key_file: "{{ ansible_ssh_private_key_file | default(omit) }}"
        ansible_connection: ssh

- name: OS Configuration - Universal Multi-Distro Setup
  hosts: dynamic_linux_hosts
  become: yes
  gather_facts: true
  vars:
    vol_id_short: "{{ target_volume_id | replace('-', '') }}"

  tasks:
    - name: Ensure resize tools are present
      ansible.builtin.package:
        name:
          - "{{ 'cloud-utils-growpart' if ansible_os_family == 'RedHat' else 'cloud-guest-utils' }}"
          - util-linux
          - xfsprogs
        state: present
      ignore_errors: true

    - name: Universal Device Discovery and Resize
      ansible.builtin.shell: |
        # Find by Serial (Nitro)
        DEVICE=$(lsblk -rdpno NAME,SERIAL | grep "{{ vol_id_short }}" | awk '{print $1}' | head -n 1)

        if [ -n "$DEVICE" ]; then
          PARENT_NAME=$(lsblk -no PKNAME "$DEVICE")
          
          if [ -z "$PARENT_NAME" ]; then
             DISK_PATH="$DEVICE"
             echo 1 > "/sys/class/block/$(basename $DEVICE)/device/rescan" 2>/dev/null || true
          else
             DISK_PATH="/dev/$PARENT_NAME"
             PART_NUM=$(echo "$DEVICE" | grep -o '[0-9]\+$')
             echo 1 > "/sys/class/block/$PARENT_NAME/device/rescan" 2>/dev/null || true
             growpart "$DISK_PATH" "$PART_NUM" || echo "Already grown"
          fi

          FS_TYPE=$(lsblk -no FSTYPE "$DEVICE")
          if [ "$FS_TYPE" == "xfs" ]; then
              xfs_growfs "$DEVICE"
          else
              resize2fs "$DEVICE"
          fi
          df -h "$DEVICE"
        else
          echo "ERROR: Disk {{ target_volume_id }} not found"
          exit 1
        fi
      register: linux_resize_out

    - name: Report Final Status
      ansible.builtin.debug:
        msg: "{{ linux_resize_out.stdout_lines }}"
