---
- name: AWS Infrastructure - Resize Linux EBS Volume
  hosts: localhost
  connection: local
  gather_facts: false
  vars:
    region: "eu-west-1"
    # Mapping Survey variables to Playbook variables
    target_ip: "{{ instance_ip_address }}"
    target_new_size: "{{ new_size_gb }}"
    target_volume_id: "{{ volume_id }}" # From survey: "Enter the Volume ID"

  tasks:
    - name: Get Instance and Zone details
      amazon.aws.ec2_instance_info:
        region: "{{ region }}"
        filters:
          ip-address: "{{ target_ip }}"
      register: instance_info

    - name: Set Zone Fact
      set_fact:
        target_zone: "{{ instance_info.instances[0].placement.availability_zone }}"

    - name: Modify EBS volume
      amazon.aws.ec2_vol:
        region: "{{ region }}"
        zone: "{{ target_zone }}"  # This fixes the "must specify zone" error
        id: "{{ target_volume_id }}"
        volume_size: "{{ target_new_size }}"
      register: volume_modification

    - name: Wait for AWS propagation
      ansible.builtin.pause:
        seconds: 20

    - name: Add host to dynamic inventory
      ansible.builtin.add_host:
        name: "{{ target_ip }}"
        groups: target_nodes
        ansible_user: ec2-user 

- name: OS Configuration - Universal Multi-Distro Setup
  hosts: target_nodes
  become: true
  gather_facts: true

  tasks:
    - name: Install resize tools
      ansible.builtin.package:
        name: 
          - "{{ (ansible_os_family == 'Debian') | ternary('cloud-guest-utils', 'cloud-utils-growpart') }}"
          - gdisk
        state: present

    - name: Expand Partition and Filesystem
      shell: |
        # 1. Detect root partition
        ROOT_PART=$(findmnt -n -o SOURCE /)
        DISK_DEV=$(lsblk -no PKNAME $ROOT_PART)
        PART_NUM=$(lsblk -no PARTN $ROOT_PART)

        # 2. Grow partition table
        growpart /dev/$DISK_DEV $PART_NUM || true
        
        # 3. Grow Filesystem (XFS or EXT4)
        FS_TYPE=$(findmnt -n -o FSTYPE /)
        if [ "$FS_TYPE" == "xfs" ]; then
            xfs_growfs /
        else
            resize2fs $ROOT_PART
        fi
      register: resize_result

    - name: Final Disk Summary
      debug:
        msg: "New size of /: {{ ansible_mounts | selectattr('mount', 'equalto', '/') | map(attribute='size_total') | first | human_readable }}"
