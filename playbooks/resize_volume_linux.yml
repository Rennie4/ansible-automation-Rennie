---
- name: AWS Infrastructure - Resize Linux EBS Volume
  hosts: localhost
  connection: local
  gather_facts: false
  vars:
    region: "eu-west-1"
    target_instance_id: "{{ instance_id }}"

  tasks:
    - name: Get current volume info
      amazon.aws.ec2_vol_info:
        region: "{{ region }}"
        filters:
          attachment.instance-id: "{{ target_instance_id }}"
          attachment.device: ["/dev/sda1", "/dev/xvda", "/dev/nvme0n1"]
      register: vol_info

    - name: Check for pending modifications
      amazon.aws.ec2_vol_info:
        region: "{{ region }}"
        filters:
          volume-id: "{{ vol_info.volumes[0].id }}"
      register: modification_status

    # This prevents the "Rate Exceeded" crash by checking status first
    - name: Wait if volume is still optimizing from previous resize
      amazon.aws.ec2_vol_info:
        region: "{{ region }}"
        filters:
          volume-id: "{{ vol_info.volumes[0].id }}"
      register: wait_status
      until: wait_status.volumes[0].status != "optimizing"
      retries: 10
      delay: 30

    - name: Modify EBS volume
      amazon.aws.ec2_vol:
        region: "{{ region }}"
        id: "{{ vol_info.volumes[0].id }}"
        volume_size: "{{ new_size }}"
        modify_volume: true
      register: volume_modification
      ignore_errors: yes

    - name: Handle Rate Limit Error
      fail:
        msg: "AWS Limit Hit: You have modified this volume 4 times in 24h. Check 'aws ec2 describe-volumes-modifications' for your reset time."
      when: 
        - volume_modification.failed is defined 
        - "'VolumeModificationRateExceeded' in volume_modification.msg"

    - name: Add target IP to temporary inventory
      ansible.builtin.add_host:
        name: "{{ target_public_ip }}"
        groups: target_nodes
        ansible_ssh_private_key_file: "/runner/artifacts/{{ artifact_id | default('2139') }}/ssh_key_data"
        ansible_user: ec2-user

- name: OS Configuration - Universal Multi-Distro Setup
  hosts: target_nodes
  become: true
  tasks:
    - name: Universal Resize Logic
      shell: |
        ROOT_PART=$(findmnt / -n -o SOURCE)
        PARENT_DISK=$(lsblk -no PKNAME $ROOT_PART)
        PART_NUM=$(lsblk -no PARTN $ROOT_PART)

        growpart /dev/$PARENT_DISK $PART_NUM || echo "Already grown"

        FS_TYPE=$(findmnt / -n -o FSTYPE)
        if [ "$FS_TYPE" == "xfs" ]; then
          xfs_growfs /
        else
          resize2fs $ROOT_PART
        fi
      register: os_res
