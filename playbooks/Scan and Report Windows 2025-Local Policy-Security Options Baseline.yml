---
- name: Windows Security Baseline Collection + HTML Report + S3 Upload
  hosts: windows_hosts
  gather_facts: false

  vars:
    s3_bucket: "oml-s3-automation-sandbox"
    s3_region: "eu-west-1"
    s3_prefix: "cis-baseline-files/"

    aws_access_key: "{{ vault_aws_access_key | default(omit) }}"
    aws_secret_key: "{{ vault_aws_secret_key | default(omit) }}"
    aws_session_token: "{{ vault_aws_session_token | default(omit) }}"

    work_root: "C:\\Temp\\ws-audit"
    artifacts_dir_name: "artifacts"
    artifacts_dir: "{{ work_root }}\\{{ artifacts_dir_name }}"
    report_basename: "ws_security"

  pre_tasks:
    - name: Ensure working directories exist
      ansible.windows.win_file:
        path: "{{ item }}"
        state: directory
      loop:
        - "{{ work_root }}"
        - "{{ artifacts_dir }}"

  tasks:

    #######################################################
    # 1. EXPORT LOCAL SECURITY POLICY (INF)
    #######################################################
    - name: Export Local Security Policy
      ansible.windows.win_shell: >
        secedit /export
        /cfg "{{ artifacts_dir }}\\local_secpol.inf"
        /areas SECURITYPOLICY USER_RIGHTS SERVICES
      args:
        creates: "{{ artifacts_dir }}\\local_secpol.inf"

    #######################################################
    # 2. EXPORT ADVANCED AUDIT POLICY
    #######################################################
    - name: Export Advanced Audit Policy
      ansible.windows.win_shell: >
        auditpol /get /category:* /r > "{{ artifacts_dir }}\\advanced_audit.csv"
      args:
        creates: "{{ artifacts_dir }}\\advanced_audit.csv"

    #######################################################
    # 3. BUILD STRUCTURED JSON REPORT
    #######################################################
    - name: Build JSON report
      ansible.windows.win_powershell:
        script: |
          $ErrorActionPreference = "Stop"
          $art = "{{ artifacts_dir }}"
          $host = $env:COMPUTERNAME
          $ts = (Get-Date).ToString("yyyyMMdd_HHmmss")
          $jsonOut = Join-Path $art "{{ report_basename }}_${host}_$ts.json"

          # Parse INF
          function Parse-Inf {
            param($Path)
            $result = @{}
            $section = $null
            Get-Content -Path $Path | ForEach-Object {
              $line = $_.Trim()
              if ($line -match '^\[(.+)\]$') {
                $section = $matches[1]
                $result[$section] = @{}
              } elseif ($section -and $line -match '^(.*)=(.*)$') {
                $result[$section][$matches[1].Trim()] = $matches[2].Trim()
              }
            }
            return $result
          }

          $inf = Parse-Inf "$art\\local_secpol.inf"
          $audit = Import-Csv "$art\\advanced_audit.csv"

          $obj = [ordered]@{
            ComputerName = $host
            CollectedAtUTC = (Get-Date).ToUniversalTime().ToString("o")

            LocalSecurityPolicy = @{
              SystemAccess      = $inf['System Access']
              EventAuditLegacy  = $inf['Event Audit']
              PrivilegeRights   = $inf['Privilege Rights']
              RegistryValues    = $inf['Registry Values']
              Services          = $inf['Service General Setting']
            }

            AdvancedAuditPolicy = $audit
          }

          $obj | ConvertTo-Json -Depth 8 | Set-Content -Path $jsonOut -Encoding UTF8
          Write-Output $jsonOut
      register: json_report

    #######################################################
    # 4. RENDER HUMANâ€‘READABLE HTML REPORT USING .J2 TEMPLATE
    #######################################################
    - name: Render HTML Security Report
      template:
        src: "templates/security_report.j2"
        dest: "{{ artifacts_dir }}\\security_report_{{ inventory_hostname }}.html"

    #######################################################
    # 5. ZIP ARTIFACTS
    #######################################################
    - name: ZIP all artifacts
      ansible.windows.win_powershell:
        script: |
          Add-Type -AssemblyName System.IO.Compression.FileSystem
          $host=$env:COMPUTERNAME
          $ts=(Get-Date).ToString("yyyyMMdd_HHmmss")
          $zip="{{ work_root }}\\{{ report_basename }}_${host}_$ts.zip"
          [System.IO.Compression.ZipFile]::CreateFromDirectory("{{ artifacts_dir }}",$zip)
          Write-Output $zip
      register: zip_file

    #######################################################
    # 6. UPLOAD TO S3
    #######################################################
    - name: Upload JSON to S3
      amazon.aws.s3_object:
        bucket: "{{ s3_bucket }}"
        region: "{{ s3_region }}"
        object: "{{ s3_prefix }}{{ inventory_hostname }}/{{ json_report.stdout_lines[-1] | basename }}"
        src: "{{ json_report.stdout_lines[-1] }}"
        mode: put
        aws_access_key: "{{ aws_access_key | default(omit) }}"
        aws_secret_key: "{{ aws_secret_key | default(omit) }}"
        security_token: "{{ aws_session_token | default(omit) }}"

    - name: Upload ZIP to S3
      amazon.aws.s3_object:
        bucket: "{{ s3_bucket }}"
        region: "{{ s3_region }}"
        object: "{{ s3_prefix }}{{ inventory_hostname }}/{{ zip_file.stdout_lines[-1] | basename }}"
        src: "{{ zip_file.stdout_lines[-1] }}"
        mode: put
        aws_access_key: "{{ aws_access_key | default(omit) }}"
        aws_secret_key: "{{ aws_secret_key | default(omit) }}"
        security_token: "{{ aws_session_token | default(omit) }}"
