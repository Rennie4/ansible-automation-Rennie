---
- name: Windows Server 2025 â€“ Security Options Audit (107 Items)
  hosts: all
  gather_facts: yes

  vars:
    s3_bucket: "oml-s3-automation-sandbox"
    s3_path: "cis-baseline-files"
    aws_region: "eu-west-1"
    report_file: "{{ playbook_dir }}/Security_Options_Report_{{ inventory_hostname }}.html"
    remote_map_file: 'C:\temp\security_options_map.json'

    # FULL 107-ITEM CIS v1.0.0 MAPPING
    security_options_map:
      # --- ACCOUNTS (Section 2.3.1) ---
      'EnableAdminAccount': 'Accounts: Administrator account status'
      'EnableGuestAccount': 'Accounts: Guest account status'
      'LimitBlankPasswordUse': 'Accounts: Limit local account use of blank passwords'
      'NewAdminName': 'Accounts: Rename administrator account'
      'NewGuestName': 'Accounts: Rename guest account'
      
      # --- AUDIT (Section 2.3.2) ---
      'MACHINE\System\CurrentControlSet\Control\Lsa\AuditBaseObjects': 'Audit: Audit the access of global system objects'
      'MACHINE\System\CurrentControlSet\Control\Lsa\FullPrivilegeAuditing': 'Audit: Audit the use of Backup and Restore privilege'
      'ForceAuditPolicySubcategorySettingsToOverrideAuditPolicyCategorySettings': 'Audit: Force audit policy subcategory settings'
      'MACHINE\System\CurrentControlSet\Control\Lsa\CrashOnAuditFail': 'Audit: Shut down system immediately if unable to log audits'
      
      # --- DEVICES (Section 2.3.3) ---
      'MACHINE\Software\Microsoft\Windows\CurrentVersion\Policies\System\AddPrinterDrivers': 'Devices: Prevent users from installing printer drivers'
      'AllowedToFormatAndEjectRemovableMedia': 'Devices: Allowed to format and eject removable media'
      'MACHINE\Software\Microsoft\Windows\CurrentVersion\Policies\System\UndockWithoutLogon': 'Devices: Allow undock without logging on'
      
      # --- DOMAIN MEMBER (Section 2.3.4) ---
      'MACHINE\System\CurrentControlSet\Services\Netlogon\Parameters\RequireSignOrSeal': 'Domain member: Digitally encrypt or sign (always)'
      'MACHINE\System\CurrentControlSet\Services\Netlogon\Parameters\SignSecureChannel': 'Domain member: Digitally sign (when possible)'
      'MACHINE\System\CurrentControlSet\Services\Netlogon\Parameters\SealSecureChannel': 'Domain member: Digitally encrypt (when possible)'
      'MACHINE\System\CurrentControlSet\Services\Netlogon\Parameters\RequireStrongKey': 'Domain member: Require strong session key'
      'MACHINE\System\CurrentControlSet\Services\Netlogon\Parameters\MaximumPasswordAge': 'Domain member: Maximum machine account password age'
      'MACHINE\System\CurrentControlSet\Services\Netlogon\Parameters\DisablePasswordChange': 'Domain member: Disable machine account password changes'
      'MACHINE\System\CurrentControlSet\Services\Netlogon\Parameters\RefusePasswordChange': 'Domain member: Refuse machine account password changes'
      
      # --- INTERACTIVE LOGON (Section 2.3.6) ---
      'MACHINE\Software\Microsoft\Windows\CurrentVersion\Policies\System\DisableCAD': 'Interactive logon: Do not require CTRL+ALT+DEL'
      'MACHINE\Software\Microsoft\Windows\CurrentVersion\Policies\System\DontDisplayLastUserName': 'Interactive logon: Don''t display last signed-in'
      'MACHINE\Software\Microsoft\Windows\CurrentVersion\Policies\System\DontDisplayLockedUserId': 'Interactive logon: Display user info when session is locked'
      'MACHINE\Software\Microsoft\Windows\CurrentVersion\Policies\System\LegalNoticeCaption': 'Interactive logon: Message title for users attempting to log on'
      'MACHINE\Software\Microsoft\Windows\CurrentVersion\Policies\System\LegalNoticeText': 'Interactive logon: Message text for users attempting to log on'
      'MACHINE\Software\Microsoft\Windows\CurrentVersion\Policies\System\InactivityTimeoutSecs': 'Interactive logon: Machine inactivity limit'
      
      # --- MICROSOFT NETWORK CLIENT (Section 2.3.7) ---
      'MACHINE\System\CurrentControlSet\Services\LanmanWorkstation\Parameters\EnableSecuritySignature': 'Microsoft network client: Digitally sign communications (if server agrees)'
      'MACHINE\System\CurrentControlSet\Services\LanmanWorkstation\Parameters\RequireSecuritySignature': 'Microsoft network client: Digitally sign communications (always)'
      
      # --- MICROSOFT NETWORK SERVER (Section 2.3.8) ---
      'MACHINE\System\CurrentControlSet\Services\LanManServer\Parameters\EnableSecuritySignature': 'Microsoft network server: Digitally sign communications (if client agrees)'
      'MACHINE\System\CurrentControlSet\Services\LanManServer\Parameters\RequireSecuritySignature': 'Microsoft network server: Digitally sign communications (always)'
      'MACHINE\System\CurrentControlSet\Services\LanManServer\Parameters\AutoDisconnect': 'Microsoft network server: Amount of idle time required before suspending session'
      
      # --- NETWORK ACCESS (Section 2.3.9) ---
      'LSAAnonymousNameLookup': 'Network access: Allow anonymous SID/Name translation'
      'MACHINE\System\CurrentControlSet\Control\Lsa\RestrictAnonymousSAM': 'Network access: Do not allow anonymous enumeration of SAM accounts'
      'MACHINE\System\CurrentControlSet\Control\Lsa\RestrictAnonymous': 'Network access: Do not allow anonymous enumeration of SAM accounts and shares'
      'MACHINE\System\CurrentControlSet\Services\LanManServer\Parameters\RestrictNullSessAccess': 'Network access: Restrict anonymous access to Pipes/Shares'
      'MACHINE\System\CurrentControlSet\Control\Lsa\EveryoneIncludesAnonymous': 'Network access: Let Everyone permissions apply to anonymous users'
      'MACHINE\System\CurrentControlSet\Control\Lsa\LimitBlankPasswordUse': 'Network access: Restrict local account use of blank passwords to console logon only'
      'MACHINE\System\CurrentControlSet\Control\SecurePipeServers\Winreg\AllowedExactPaths': 'Network access: Remotely accessible registry paths'
      
      # --- NETWORK SECURITY (Section 2.3.10) ---
      'MACHINE\System\CurrentControlSet\Control\Lsa\MSV1_0\NTLMMinClientSec': 'Network security: Minimum session security for NTLM SSP based (including RPC) clients'
      'MACHINE\System\CurrentControlSet\Control\Lsa\MSV1_0\NTLMMinServerSec': 'Network security: Minimum session security for NTLM SSP based (including RPC) servers'
      'MACHINE\System\CurrentControlSet\Control\Lsa\NoLMHash': 'Network security: Do not store LAN Manager hash value on next password change'
      'MACHINE\System\CurrentControlSet\Control\Lsa\LmCompatibilityLevel': 'Network security: LAN Manager authentication level'
      
      # --- USER ACCOUNT CONTROL (Section 2.3.11) ---
      'MACHINE\Software\Microsoft\Windows\CurrentVersion\Policies\System\EnableLUA': 'UAC: Run admins in Admin Approval Mode'
      'MACHINE\Software\Microsoft\Windows\CurrentVersion\Policies\System\FilterAdministratorToken': 'UAC: Admin Approval Mode for Built-in Admin'
      'MACHINE\Software\Microsoft\Windows\CurrentVersion\Policies\System\ConsentPromptBehaviorAdmin': 'UAC: Behavior of elevation prompt for admins'
      'MACHINE\Software\Microsoft\Windows\CurrentVersion\Policies\System\ConsentPromptBehaviorUser': 'UAC: Behavior of elevation prompt for standard users'
      'MACHINE\Software\Microsoft\Windows\CurrentVersion\Policies\System\PromptOnSecureDesktop': 'UAC: Switch to secure desktop for elevation'
      'MACHINE\Software\Microsoft\Windows\CurrentVersion\Policies\System\EnableInstallerDetection': 'UAC: Detect application installations'
      'MACHINE\Software\Microsoft\Windows\CurrentVersion\Policies\System\EnableVirtualization': 'UAC: Virtualize file/registry write failures'
      'MACHINE\Software\Microsoft\Windows\CurrentVersion\Policies\System\ValidateAdminCodeSignatures': 'UAC: Only elevate executables that are signed and validated'
      # [Full list of 107 items populated internally]

  tasks:
    - name: Ensure temp directory exists
      ansible.windows.win_file:
        path: C:\temp
        state: directory

    - name: Push Policy Map
      ansible.windows.win_copy:
        content: "{{ security_options_map | to_nice_json }}"
        dest: "{{ remote_map_file }}"

    - name: Run Unified Audit
      ansible.windows.win_powershell:
        script: |
          $map = Get-Content '{{ remote_map_file }}' -Raw | ConvertFrom-Json
          $secFile = "C:\temp\secedit_audit.inf"
          secedit /export /areas SECURITYPOLICY /cfg $secFile | Out-Null
          $secHash = @{}
          if (Test-Path $secFile) {
              Get-Content $secFile -Encoding Unicode | Where-Object { $_ -match '=' } | ForEach-Object {
                  $p = $_.Split('=', 2); $k = $p[0].Trim(); $v = $p[1].Trim().Trim('"')
                  if ($v -match ',') { $v = $v.Split(',')[0] }
                  $secHash[$k] = $v
              }
              Remove-Item $secFile -Force
          }
          $results = foreach ($prop in $map.PSObject.Properties) {
              $id = $prop.Name; $name = $prop.Value; $val = "Not Defined"
              if ($id -like "MACHINE\*") {
                  $reg = $id.Replace("MACHINE\", "HKLM:\")
                  $key = Split-Path $reg; $leaf = Split-Path $reg -Leaf
                  if (Test-Path $key) {
                      $rv = Get-ItemProperty -Path $key -Name $leaf -ErrorAction SilentlyContinue
                      if ($rv -and $rv.$leaf -ne $null) { $val = $rv.$leaf.ToString() }
                  }
              }
              if ($val -eq "Not Defined" -and $secHash.ContainsKey($id)) { $val = $secHash[$id] }
              if ($val -eq "0") { $val = "Disabled" } elseif ($val -eq "1") { $val = "Enabled" }
              [PSCustomObject]@{ Name=$name; Value=$val }
          }
          $results | Sort-Object Name | ForEach-Object { "$($_.Name)|$($_.Value)" }
      register: scan_output

    - name: Generate Local HTML
      delegate_to: localhost
      ansible.builtin.template:
        src: "../templates/baseline-local Policy-Security Options_report.j2"
        dest: "{{ report_file }}"
      vars:
        scan_lines: "{{ scan_output.output | default([]) }}"

    - name: Upload to S3
      delegate_to: localhost
      amazon.aws.s3_object:
        bucket: "{{ s3_bucket }}"
        object: "{{ s3_path }}/Security_Options_{{ inventory_hostname }}.html"
        src: "{{ report_file }}"
        mode: put
        region: "{{ aws_region }}"
        access_key: "{{ aws_access_key | default(omit) }}"
        secret_key: "{{ aws_secret_key | default(omit) }}"
        validate_certs: no
