- name: Scan Windows 2025 Security Options (Target 104)
  hosts: all
  gather_facts: yes
  vars:
    s3_bucket: "oml-s3-automation-sandbox"
    s3_path: "cis-baseline-files"
    aws_region: "eu-west-1"
    report_file: "/runner/project/playbooks/Security_Options_Report.html"
    remote_map_file: "C:\\temp\\security_options_map.json"

    security_options_map:
      # ACCOUNTS
      "EnableAdminAccount": "Accounts: Administrator account status"
      "EnableGuestAccount": "Accounts: Guest account status"
      "LimitBlankPasswordUse": "Accounts: Limit local account use of blank passwords to console logon only"
      "NewAdminName": "Accounts: Rename administrator account"
      "NewGuestName": "Accounts: Rename guest account"
      # AUDIT
      "AuditBaseObjects": "Audit: Audit the access of global system objects"
      "FullPrivilegeAuditing": "Audit: Audit the use of Backup and Restore privilege"
      "CrashOnAuditFail": "Audit: Shut down system immediately if unable to log security audits"
      # DEVICES
      "AddPrinterDrivers": "Devices: Prevent users from installing printer drivers"
      "MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\UndockWithoutLogon": "Devices: Allow undock without having to log on"
      "MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\RestrictCDROM": "Devices: Restrict CD-ROM access to locally logged-on user only"
      # ... [Keep all other 90+ entries here exactly as they were in your working version]

  tasks:
    - name: Prepare Workspace
      ansible.windows.win_file:
        path: C:\temp
        state: directory

    - name: Transfer Policy Map
      ansible.windows.win_copy:
        content: "{{ security_options_map | to_nice_json }}"
        dest: "{{ remote_map_file }}"

    - name: Run Security Audit (Final Logic Fix)
      ansible.windows.win_shell: |
        $map = Get-Content "{{ remote_map_file }}" | ConvertFrom-Json
        $configFile = "C:\temp\secedit_options.inf"
        secedit /export /areas SECURITYPOLICY /cfg $configFile | Out-Null
        
        $secHash = @{}
        if (Test-Path $configFile) {
            Get-Content $configFile -Encoding Unicode | ForEach-Object {
                if ($_ -match '=') {
                    $p = $_.Split('=', 2); $secHash[$p[0].Trim()] = $p[1].Trim().Trim('"')
                }
            }
            Remove-Item $configFile
        }

        $results = foreach ($id in $map.psobject.Properties.Name) {
            $val = "Not Defined"
            $policyName = $map.$id
            
            # 1. Try finding by Short Name in Secedit (e.g. "NewAdminName")
            $shortId = if ($id -match "\\") { Split-Path $id -Leaf } else { $id }
            
            if ($secHash.ContainsKey($id)) { $val = $secHash[$id] }
            elseif ($secHash.ContainsKey($shortId)) { $val = $secHash[$shortId] }
            
            # 2. Try finding by Registry Path if still Not Defined
            if ($val -eq "Not Defined" -and $id -like "MACHINE\*") {
                $f = $id.Replace("MACHINE\", "HKLM:\")
                $p = Split-Path $f; $n = Split-Path $f -Leaf
                if (Test-Path $p) {
                    $rv = Get-ItemProperty -Path $p -Name $n -ErrorAction SilentlyContinue
                    if ($rv -and $rv.$n -ne $null) { $val = $rv.$n }
                }
            }

            # 3. Clean up raw numbers and specific strings
            if ($val -match '^0(,0)?$') { $val = "Disabled" }
            elseif ($val -match '^1(,0)?$') { $val = "Enabled" }
            elseif ($val -eq "4,0") { $val = "Disabled" }
            elseif ($val -eq "4,1") { $val = "Enabled" }
            elseif ($val -eq "536870912") { $val = "Require 128-bit encryption" }
            
            [PSCustomObject]@{ Name = $policyName; Value = $val }
        }
        $results | Sort-Object Name | ForEach-Object { "$($_.Name)|$($_.Value)" }
      register: security_scan_raw

    - name: Build Report
      delegate_to: localhost
      ansible.builtin.copy:
        dest: "{{ report_file }}"
        content: |
          <!DOCTYPE html>
          <html>
          <head>
            <style>
              body { font-family: sans-serif; padding: 20px; background: #f4f7f9; }
              .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
              table { width: 100%; border-collapse: collapse; }
              th { text-align: left; background: #232f3e; color: white; padding: 10px; }
              td { padding: 8px; border-bottom: 1px solid #eee; }
              .Enabled, .Administrator { color: green; font-weight: bold; }
              .Disabled { color: red; }
            </style>
          </head>
          <body>
            <div class="card">
              <h2>Security Options: {{ inventory_hostname }}</h2>
              <table>
                <tr><th>Policy Name</th><th>Configured Setting</th></tr>
                {% for line in security_scan_raw.stdout_lines %}
                {% set p = line.split('|') %}
                <tr><td>{{ p[0] }}</td><td class="{{ p[1] }}">{{ p[1] }}</td></tr>
                {% endfor %}
              </table>
            </div>
          </body>
          </html>

    - name: Push to S3
      delegate_to: localhost
      amazon.aws.s3_object:
        bucket: "{{ s3_bucket }}"
        object: "{{ s3_path }}/Security_Options_{{ inventory_hostname }}.html"
        src: "{{ report_file }}"
        mode: put
        region: "{{ aws_region }}"
