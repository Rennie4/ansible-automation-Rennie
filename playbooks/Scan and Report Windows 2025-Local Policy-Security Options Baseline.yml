- name: Comprehensive Windows 2025 Security Options Audit
  hosts: all
  gather_facts: yes
  vars:
    s3_bucket: "oml-s3-automation-sandbox"
    s3_path: "cis-baseline-files"
    aws_region: "eu-west-1"
    report_file: "/runner/project/playbooks/Security_Options_Report.html"
    remote_map_file: "C:\\temp\\security_options_map.json"

    # Full CIS-aligned mapping including Network Access, MSS, and UAC
    security_options_map:
      "EnableAdminAccount": "Accounts: Administrator account status"
      "BlockConsumerMicrosoftAccounts": "Accounts: Block Microsoft accounts"
      "EnableGuestAccount": "Accounts: Guest account status"
      "LimitBlankPasswordUse": "Accounts: Limit local account use of blank passwords"
      "NewAdminName": "Accounts: Rename administrator account"
      "NewGuestName": "Accounts: Rename guest account"
      "MACHINE\\System\\CurrentControlSet\\Control\\Lsa\\AuditBaseObjects": "Audit: Audit the access of global system objects"
      "MACHINE\\System\\CurrentControlSet\\Control\\Lsa\\FullPrivilegeAuditing": "Audit: Audit the use of Backup and Restore privilege"
      "ForceAuditPolicySubcategorySettingsToOverrideAuditPolicyCategorySettings": "Audit: Force audit policy subcategory settings"
      "MACHINE\\System\\CurrentControlSet\\Control\\Lsa\\CrashOnAuditFail": "Audit: Shut down system immediately if unable to log audits"
      "MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\UndockWithoutLogon": "Devices: Allow undock without having to log on"
      "AllowedToFormatAndEjectRemovableMedia": "Devices: Allowed to format and eject removable media"
      "MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\AddPrinterDrivers": "Devices: Prevent users from installing printer drivers"
      "MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\RestrictCDROM": "Devices: Restrict CD-ROM access"
      "MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\RestrictFloppy": "Devices: Restrict floppy access"
      "MACHINE\\System\\CurrentControlSet\\Services\\Netlogon\\Parameters\\RequireSignOrSeal": "Domain member: Digitally encrypt or sign (always)"
      "MACHINE\\System\\CurrentControlSet\\Services\\Netlogon\\Parameters\\SealSecureChannel": "Domain member: Digitally encrypt (when possible)"
      "MACHINE\\System\\CurrentControlSet\\Services\\Netlogon\\Parameters\\SignSecureChannel": "Domain member: Digitally sign (when possible)"
      "MACHINE\\System\\CurrentControlSet\\Services\\Netlogon\\Parameters\\DisablePasswordChange": "Domain member: Disable machine account password changes"
      "MACHINE\\System\\CurrentControlSet\\Services\\Netlogon\\Parameters\\MaximumPasswordAge": "Domain member: Maximum machine account password age"
      "MACHINE\\System\\CurrentControlSet\\Services\\Netlogon\\Parameters\\RequireStrongKey": "Domain member: Require strong session key"
      "MACHINE\\System\\CurrentControlSet\\Services\\Netlogon\\Parameters\\RefusePasswordChange": "Domain member: Refuse machine account password changes"
      "MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\DontDisplayLastUserName": "Interactive logon: Don't display last signed-in"
      "MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\DisableCAD": "Interactive logon: Do not require CTRL+ALT+DEL"
      "MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\InactivityTimeoutSecs": "Interactive logon: Machine inactivity limit"
      "MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\MaxDevicePasswordFailedAttempts": "Interactive logon: Machine account lockout threshold"
      "MACHINE\\Software\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon\\CachedLogonsCount": "Interactive logon: Number of previous logons to cache"
      "MACHINE\\Software\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon\\PasswordExpiryWarning": "Interactive logon: Prompt user to change password"
      "MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\ShutdownWithoutLogon": "Interactive logon: Allow system shutdown without logon"
      "MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\ScForceOption": "Interactive logon: Require smart card"
      "MACHINE\\Software\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon\\ScRemoveOption": "Interactive logon: Smart card removal behavior"
      "MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\DisplayLogonInfo": "Interactive logon: Display user information when locked"
      "MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\DontDisplayUsername": "Interactive logon: Don't display username at sign-in"
      "MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\LegalNoticeCaption": "Interactive logon: Message title for users logging on"
      "MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\LegalNoticeText": "Interactive logon: Message text for users logging on"
      "MACHINE\\System\\CurrentControlSet\\Services\\LanmanWorkstation\\Parameters\\EnableSecuritySignature": "Microsoft network client: Digitally sign (always)"
      "MACHINE\\System\\CurrentControlSet\\Services\\LanmanWorkstation\\Parameters\\RequireSecuritySignature": "Microsoft network client: Digitally sign (if server agrees)"
      "MACHINE\\System\\CurrentControlSet\\Services\\LanmanWorkstation\\Parameters\\EnablePlainTextPassword": "Microsoft network client: Send unencrypted password"
      "MACHINE\\System\\CurrentControlSet\\Services\\LanManServer\\Parameters\\EnableSecuritySignature": "Microsoft network server: Digitally sign (always)"
      "MACHINE\\System\\CurrentControlSet\\Services\\LanManServer\\Parameters\\RequireSecuritySignature": "Microsoft network server: Digitally sign (if client agrees)"
      "MACHINE\\System\\CurrentControlSet\\Services\\LanManServer\\Parameters\\AutoDisconnect": "Microsoft network server: Idle time before suspending"
      "MACHINE\\System\\CurrentControlSet\\Services\\LanManServer\\Parameters\\EnableForcedLogOff": "Microsoft network server: Disconnect clients when hours expire"
      "MACHINE\\System\\CurrentControlSet\\Services\\LanManServer\\Parameters\\SmbServerNameHardeningLevel": "Microsoft network server: Server SPN target name validation level"
      "LSAAnonymousNameLookup": "Network access: Allow anonymous SID/Name translation"
      "RestrictAnonymousSAM": "Network access: Do not allow anonymous enumeration of SAM accounts"
      "RestrictAnonymous": "Network access: Do not allow anonymous enumeration of SAM accounts and shares"
      "MACHINE\\System\\CurrentControlSet\\Control\\Lsa\\EveryoneIncludesAnonymous": "Network access: Let Everyone apply to anonymous"
      "MACHINE\\System\\CurrentControlSet\\Services\\LanManServer\\Parameters\\RestrictNullSessAccess": "Network access: Restrict anonymous access to Pipes/Shares"
      "MACHINE\\System\\CurrentControlSet\\Control\\Lsa\\LimitBlankPasswordUse": "Network access: Remotely accessible registry paths"
      "MACHINE\\System\\CurrentControlSet\\Services\\LanManServer\\Parameters\\NullSessionPipes": "Network access: Named Pipes accessed anonymously"
      "MACHINE\\System\\CurrentControlSet\\Services\\LanManServer\\Parameters\\NullSessionShares": "Network access: Shares accessed anonymously"
      "MACHINE\\System\\CurrentControlSet\\Control\\Lsa\\ForceGuest": "Network access: Sharing model for local accounts"
      "MACHINE\\System\\CurrentControlSet\\Control\\Lsa\\NoLMHash": "Network security: Do not store LAN Manager hash"
      "MACHINE\\System\\CurrentControlSet\\Control\\Lsa\\LmCompatibilityLevel": "Network security: LAN Manager authentication level"
      "MACHINE\\System\\CurrentControlSet\\Control\\Lsa\\MSV1_0\\NTLMMinClientSec": "Network security: Min session security for NTLM clients"
      "MACHINE\\System\\CurrentControlSet\\Control\\Lsa\\MSV1_0\\NTLMMinServerSec": "Network security: Min session security for NTLM servers"
      "MACHINE\\System\\CurrentControlSet\\Control\\Lsa\\RestrictNTLM\\AuditIncomingTraffic": "Network security: Restrict NTLM: Audit Incoming"
      "MACHINE\\System\\CurrentControlSet\\Control\\Lsa\\RestrictNTLM\\InboundNTLMTraffic": "Network security: Restrict NTLM: Incoming traffic"
      "MACHINE\\System\\CurrentControlSet\\Control\\Lsa\\RestrictNTLM\\OutboundNTLMTraffic": "Network security: Restrict NTLM: Outgoing traffic"
      "MACHINE\\System\\CurrentControlSet\\Control\\Lsa\\RestrictNTLM\\AuditOutgoingTraffic": "Network security: Restrict NTLM: Audit NTLM in domain"
      "MACHINE\\System\\CurrentControlSet\\Services\\LDAP\\LDAPClientIntegrity": "Network security: LDAP client signing"
      "MACHINE\\System\\CurrentControlSet\\Control\\Lsa\\NoAdapterLsa": "Network security: Allow LocalSystem NULL session fallback"
      "MACHINE\\System\\CurrentControlSet\\Control\\Lsa\\NegOption": "Network security: Allow PKU2U auth"
      "MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\ConsentPromptBehaviorAdmin": "UAC: Elevation prompt for admins"
      "MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\ConsentPromptBehaviorUser": "UAC: Elevation prompt for users"
      "MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\EnableLUA": "UAC: Run admins in Admin Approval Mode"
      "MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\PromptOnSecureDesktop": "UAC: Switch to secure desktop for elevation"
      "MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\EnableInstallerDetection": "UAC: Detect application installs"
      "MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\FilterAdministratorToken": "UAC: Admin Approval Mode for Built-in Admin"
      "MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\EnableUIADesktopToggle": "UAC: Allow UIAccess apps to prompt"
      "MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\EnableSecureUIAPaths": "UAC: Only elevate secure UIAccess apps"
      "MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\EnableVirtualization": "UAC: Virtualize file/registry write failures"
      "MACHINE\\System\\CurrentControlSet\\Services\\Tcpip\\Parameters\\TcpMaxConnectResponseRetransmissions": "MSS: SYN Attack Protection"
      "MACHINE\\System\\CurrentControlSet\\Services\\Tcpip\\Parameters\\EnableICMPRedirect": "MSS: Allow ICMP redirects"
      "MACHINE\\System\\CurrentControlSet\\Control\\Session Manager\\SafeDllSearchMode": "MSS: Enable Safe DLL search mode"
      "MACHINE\\System\\CurrentControlSet\\Services\\Tcpip\\Parameters\\DisableIPSourceRouting": "MSS: IP source routing protection"
      "MACHINE\\System\\CurrentControlSet\\Services\\Netbt\\Parameters\\NoNameReleaseOnDemand": "MSS: Ignore NetBIOS name release"
      "MACHINE\\System\\CurrentControlSet\\Control\\Session Manager\\Memory Management\\ClearPageFileAtShutdown": "Shutdown: Clear virtual memory pagefile"
      "MACHINE\\System\\CurrentControlSet\\Control\\Session Manager\\ProtectionMode": "System objects: Strengthen default permissions"
      "MACHINE\\System\\CurrentControlSet\\Control\\Lsa\\FipsAlgorithmPolicy\\Enabled": "System settings: Use FIPS compliant algorithms"
      "MACHINE\\Software\\Microsoft\\Windows NT\\CurrentVersion\\Setup\\RecoveryConsole\\SecurityLevel": "Recovery console: Automatic admin logon"
      "MACHINE\\Software\\Microsoft\\Windows NT\\CurrentVersion\\Setup\\RecoveryConsole\\SetCommand": "Recovery console: Floppy copy and drive access"

  tasks:
    - name: Prepare Workspace
      ansible.windows.win_file:
        path: C:\temp
        state: directory

    - name: Transfer Policy Map
      ansible.windows.win_copy:
        content: "{{ security_options_map | to_nice_json }}"
        dest: "{{ remote_map_file }}"

    - name: Run Comprehensive Audit
      ansible.windows.win_shell: |
        {% raw %}
        $map = Get-Content "C:\temp\security_options_map.json" | ConvertFrom-Json
        $secFile = "C:\temp\secedit_audit.inf"
        secedit /export /areas SECURITYPOLICY /cfg $secFile | Out-Null
        
        $secHash = @{}
        if (Test-Path $secFile) {
            Get-Content $secFile -Encoding Unicode | ForEach-Object {
                if ($_ -match '=') {
                    $p = $_.Split('=', 2)
                    $secHash[$p[0].Trim()] = $p[1].Trim().Trim('"')
                }
            }
            Remove-Item $secFile
        }

        $results = foreach ($id in $map.psobject.Properties.Name) {
            $val = "Not Defined"
            $pName = $map.$id
            
            if ($id -like "MACHINE\*") {
                $f = $id.Replace("MACHINE\", "HKLM:\")
                $p = Split-Path $f
                $n = Split-Path $f -Leaf
                if (Test-Path $p) {
                    $rv = Get-ItemProperty -Path $p -Name $n -ErrorAction SilentlyContinue
                    if ($rv -and $rv.$n -ne $null) { $val = $rv.$n }
                }
            }
            
            if ($val -eq "Not Defined") {
                if ($secHash.ContainsKey($id)) { $val = $secHash[$id] }
                else {
                    $sk = Split-Path $id -Leaf
                    if ($secHash.ContainsKey($sk)) { $val = $secHash[$sk] }
                }
            }

            if ($val -eq "536870912") { $val = "Require 128-bit encryption" }
            elseif ($val -eq "0" -or $val -eq "0,0") { $val = "Disabled" }
            elseif ($val -eq "1" -or $val -eq "1,0") { $val = "Enabled" }
            
            [PSCustomObject]@{ Name = $pName; Value = $val }
        }
        $results | Sort-Object Name | ForEach-Object { "$($_.Name)|$($_.Value)" }
        {% endraw %}
      register: scan_output

    - name: Generate Report
      delegate_to: localhost
      ansible.builtin.copy:
        dest: "{{ report_file }}"
        content: |
          <!DOCTYPE html>
          <html>
          <head>
              <style>
                  body { font-family: 'Segoe UI', Arial; margin: 30px; background-color: #f4f7f9; }
                  .container { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); max-width: 1150px; margin: auto; }
                  h1 { color: #1a2b3c; border-bottom: 3px solid #007bff; padding-bottom: 12px; }
                  .summary-box { display: flex; gap: 20px; margin-bottom: 25px; }
                  .card { flex: 1; padding: 15px; border-radius: 8px; background: #f8f9fa; border-left: 5px solid #007bff; }
                  .card h3 { margin: 0; font-size: 0.85em; text-transform: uppercase; color: #666; }
                  .card p { margin: 5px 0 0; font-size: 1.8em; font-weight: bold; }
                  table { width: 100%; border-collapse: collapse; }
                  th { background-color: #1a2b3c; color: white; padding: 12px; text-align: left; }
                  td { padding: 10px 12px; border-bottom: 1px solid #eee; font-size: 0.92em; }
                  .Enabled { color: #28a745; font-weight: bold; }
                  .Disabled { color: #dc3545; font-weight: bold; }
              </style>
          </head>
          <body>
              <div class="container">
                  <h1>Windows Server 2025: Security Options Audit</h1>
                  <div class="summary-box">
                      <div class="card"><h3>Total Targeted</h3><p>{{ security_options_map.keys() | length }}</p></div>
                      <div class="card" style="border-left-color: #28a745;"><h3>Successfully Pulled</h3><p>{{ scan_output.stdout_lines | length }}</p></div>
                  </div>
                  <table>
                      <thead><tr><th>Security Policy Name</th><th>Configured Setting</th></tr></thead>
                      <tbody>
                          {% for line in scan_output.stdout_lines %}
                          {% set parts = line.split('|') %}
                          <tr><td>{{ parts[0] }}</td><td class="{{ parts[1].split(' ')[0] if parts | length > 1 else '' }}">{{ parts[1] if parts | length > 1 else 'N/A' }}</td></tr>
                          {% endfor %}
                      </tbody>
                  </table>
              </div>
          </body>
          </html>

    - name: Push to S3
      delegate_to: localhost
      amazon.aws.s3_object:
        bucket: "{{ s3_bucket }}"
        object: "{{ s3_path }}/Security_Options_{{ inventory_hostname.split('.')[0] }}.html"
        src: "{{ report_file }}"
        mode: put
        region: "{{ aws_region }}"
