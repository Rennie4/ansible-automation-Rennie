- name: Scan Windows 2025 Security Options (Full 104 Settings)
  hosts: all
  gather_facts: yes
  vars:
    s3_bucket: "oml-s3-automation-sandbox"
    s3_path: "cis-baseline-files"
    aws_region: "eu-west-1"
    template_path: "{{ playbook_dir }}/../templates/baseline-local Policy-Security Options_report.j2"
    report_dir: "{{ playbook_dir }}/reports"

  tasks:
    - name: Ensure Local Reports Directory
      delegate_to: localhost
      ansible.builtin.file:
        path: "{{ report_dir }}"
        state: directory
        mode: '0755'

    - name: Dynamic Security Scan
      ansible.windows.win_shell: |
        {% raw %}
        $infFile = "C:\temp\full_sec_export.inf"
        secedit /export /areas SECURITYPOLICY /cfg $infFile | Out-Null
        
        $content = Get-Content $infFile -Encoding Unicode
        $results = @()
        $sectionsToCapture = "Registry Values", "Event Audit", "Privilege Rights", "Account Control"
        $currentSection = ""

        foreach ($line in $content) {
            $line = $line.Trim()
            if ($line -match '^\[(.+)\]') {
                $currentSection = $matches[1]
                continue
            }
            
            if ($line -match '=') {
                $parts = $line.Split('=', 2)
                $name = $parts[0].Trim()
                $val = $parts[1].Trim().Trim('"')

                # Clean up values to match Windows UI
                if ($val -eq "1,0" -or $val -eq "1") { $val = "Enabled" }
                elseif ($val -eq "0,0" -or $val -eq "0") { $val = "Disabled" }
                elseif ($val -match "^4,") { $val = "Enabled" } # Handles special audit flags

                # Filter out technical prefix for cleaner report
                $cleanName = $name -replace "MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\", ""
                $cleanName = $cleanName -replace "MACHINE\\System\\CurrentControlSet\\Control\\Lsa\\", ""
                
                $results += [PSCustomObject]@{ Policy = $cleanName; Setting = $val }
            }
        }
        
        $results | Sort-Object Policy | ForEach-Object {
            Write-Output ($_.Policy + "|" + $_.Setting)
        }
        Remove-Item $infFile -ErrorAction SilentlyContinue
        {% endraw %}
      register: security_scan_raw

    - name: Generate HTML Report
      delegate_to: localhost
      ansible.builtin.template:
        src: "{{ template_path }}"
        dest: "{{ report_dir }}/Security_Options_{{ inventory_hostname }}.html"

    - name: Upload to S3
      delegate_to: localhost
      amazon.aws.s3_object:
        bucket: "{{ s3_bucket }}"
        object: "{{ s3_path }}/Security_Options_{{ inventory_hostname }}.html"
        src: "{{ report_dir }}/Security_Options_{{ inventory_hostname }}.html"
        mode: put
        region: "{{ aws_region }}"
