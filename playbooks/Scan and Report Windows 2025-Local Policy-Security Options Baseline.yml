- name: Run Comprehensive Audit
  ansible.windows.win_shell: |
    {% raw %}
    $map = Get-Content "C:\temp\security_options_map.json" | ConvertFrom-Json

    $secFile = "C:\temp\secedit_audit.inf"
    secedit /export /areas SECURITYPOLICY /cfg $secFile | Out-Null

    # Prepare holders
    $sec = [ordered]@{
      RegistryValues = @{}
      SystemAccess   = @{}
    }

    function Parse-SeceditFile {
      param([string]$Path)
      if (-not (Test-Path $Path)) { return }

      $current = ""
      Get-Content -Path $Path -Encoding Unicode | ForEach-Object {
        $line = $_.Trim()
        if (-not $line) { return }

        # Track section
        if ($line -match '^\[(.+)\]$') {
          $current = $matches[1]
          return
        }

        # Only process key=value lines
        if ($line -notmatch '=') { return }

        $kv = $line.Split('=', 2)
        $k  = $kv[0].Trim()
        $v  = $kv[1].Trim()

        switch ($current) {
          'Registry Values' {
            # Format: MACHINE\path\name = <type>,<data>
            $type = $null
            $data = $v
            if ($v -match '^\s*(\d+)\s*,\s*(.*)$') {
              $type = $matches[1]
              $data = $matches[2].Trim()
            }
            $data = $data.Trim('"')
            $sec.RegistryValues[$k] = [pscustomobject]@{
              Type = $type
              Data = $data
            }
          }
          'System Access' {
            $sec.SystemAccess[$k] = $v.Trim('"')
          }
          default { }
        }
      }
    }

    Parse-SeceditFile -Path $secFile
    Remove-Item -Path $secFile -ErrorAction SilentlyContinue

    function Convert-MachineToHKLM {
      param([string]$machineKey)
      # MACHINE\System\...\Name -> path: HKLM:\System\...\  name: Name
      $hklm = $machineKey.Replace('MACHINE\', 'HKLM:\')
      $path = Split-Path $hklm
      $name = Split-Path $hklm -Leaf
      return @{ Path = $path; Name = $name }
    }

    function Try-GetRegistry {
      param([string]$machineKey)
      $p = Convert-MachineToHKLM -machineKey $machineKey
      if (-not (Test-Path $p.Path)) { return $null }
      try {
        $val = (Get-ItemProperty -Path $p.Path -Name $p.Name -ErrorAction Stop).($p.Name)
        if ($val -is [array]) { return ($val -join '; ') }
        return $val
      } catch {
        return $null
      }
    }

    function Normalize-Value {
      param(
        [string]$policyName,
        [string]$raw
      )
      # Conservative normalization: only map obvious 0/1 toggles.
      if ($null -eq $raw -or $raw -eq '') { return 'Not Defined' }

      # Some policies export just "0" or "1"
      if ($raw -eq '0') { return 'Disabled (0)' }
      if ($raw -eq '1') { return 'Enabled (1)' }

      # Known special-case in your original script
      if ($raw -eq '536870912') { return 'Require 128-bit encryption (536870912)' }

      # Otherwise keep the raw data
      return $raw
    }

    $results = foreach ($id in $map.psobject.Properties.Name) {
      $display = $map.$id
      $val = $null

      if ($id -like 'MACHINE\*') {
        # 1) Try secedit [Registry Values] exact match first
        if ($sec.RegistryValues.ContainsKey($id)) {
          $entry = $sec.RegistryValues[$id]
          $val = $entry.Data
        }

        # 2) Fallback to live registry if needed
        if (-not $val) {
          $val = Try-GetRegistry -machineKey $id
          if ($val -is [int]) { $val = [string]$val }
          elseif ($val -is [bool]) { $val = if ($val) {'1'} else {'0'} }
          elseif ($val -is [string]) { $val = $val }
        }
      } else {
        # Try [System Access] for things like EnableAdminAccount, EnableGuestAccount, etc.
        if ($sec.SystemAccess.ContainsKey($id)) {
          $val = $sec.SystemAccess[$id]
        } else {
          # Last-resort: a quick try to see if a RegistryValues entry exists with the same leaf name
          # (helps when the map uses short names but export has full MACHINE\ paths)
          $leaf = Split-Path $id -Leaf
          $maybe = $sec.RegistryValues.Keys | Where-Object { $_ -match "\\$leaf$" }
          if ($maybe) {
            $val = $sec.RegistryValues[$maybe[0]].Data
          }
        }
      }

      if (-not $val) { $val = 'Not Defined' }

      # Conservative normalization
      $shown = Normalize-Value -policyName $display -raw ([string]$val)

      [PSCustomObject]@{
        Name  = $display
        Value = $shown
      }
    }

    $results | Sort-Object Name | ForEach-Object { "$($_.Name)|$($_.Value)" }
    {% endraw %}
  register: scan_output
