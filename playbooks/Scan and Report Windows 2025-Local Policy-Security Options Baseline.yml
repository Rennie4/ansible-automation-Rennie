---
- name: Comprehensive Windows 2025 Security Options Audit (89 + 3 UAC = 92)
  hosts: all
  gather_facts: yes

  vars:
    s3_bucket: "oml-s3-automation-sandbox"
    s3_path: "cis-baseline-files"
    aws_region: "eu-west-1"
    report_file: "{{ playbook_dir }}/Security_Options_Report_{{ inventory_hostname }}.html"
    remote_map_file: "C:\\temp\\security_options_map.json"

    # IMPORTANT:
    # Keep your existing 89 settings EXACTLY as you had them (do not add the UAC items here).
    # Example:
    security_options_map:
      # --- your 89 entries go here, unchanged ---
      # "MACHINE\\System\\CurrentControlSet\\Control\\Lsa\\LmCompatibilityLevel": "Network security: LAN Manager authentication level"
      # ...
      # (Do not modify this block; leave it as in your last known good run.)

  tasks:

    - name: Transfer Policy Map (keep your 89 entries exactly)
      ansible.windows.win_copy:
        content: "{{ security_options_map | to_nice_json }}"
        dest: "{{ remote_map_file }}"

    # Use win_powershell to avoid argument-splitting errors and run multiline PS reliably
    - name: Run Audit (adds +3 UAC entries and iterates a deterministic list)
      ansible.windows.win_powershell:
        script: |
          # Load your existing 89-map
          $map = Get-Content "C:\temp\security_options_map.json" -Raw | ConvertFrom-Json

          # Build a deterministic list to iterate (prevents missing late-added props)
          $mapList = @()
          foreach ($p in $map.PSObject.Properties) {
            $mapList += [PSCustomObject]@{ Id = $p.Name; Name = $p.Value }
          }

          # --------------------------------------------------------------------
          # ADD ONLY THESE 3 MISSING UAC SETTINGS (synthetic IDs -> friendly names)
          # --------------------------------------------------------------------
          $extra = @(
            [PSCustomObject]@{
              Id   = 'UAC_INSTALL_DETECTION'
              Name = 'UAC: Detect application installations and prompt for elevation'
            },
            [PSCustomObject]@{
              Id   = 'UAC_STD_PROMPT_BEHAVIOR'
              Name = 'UAC: Behavior of the elevation prompt for standard users'
            },
            [PSCustomObject]@{
              Id   = 'UAC_ADMIN_PROMPT_BEHAVIOR'
              Name = 'UAC: Behavior of the elevation prompt for administrators in Admin Approval Mode'
            }
          )

          # Append extras if not already present
          foreach ($e in $extra) {
            if (-not ($mapList | Where-Object { $_.Id -eq $e.Id })) {
              $mapList += $e
            }
          }

          # Export local security policy for fallbacks
          $secFile = "C:\temp\secedit_audit.inf"
          secedit /export /areas SECURITYPOLICY /cfg $secFile | Out-Null

          $secHash = @{}
          if (Test-Path $secFile) {
            Get-Content $secFile -Encoding Unicode | ForEach-Object {
              if ($_ -match '=') {
                $p = $_.Split('=', 2)
                $k = $p[0].Trim()
                $v = $p[1].Trim().Trim('"')
                if ($v -eq "7," -or $v -eq "7") { $v = "Enabled" }
                elseif ($v -match ',') { $v = $v.Split(',')[0] }
