---
- name: Windows Server 2025 â€“ Security Options Audit (107 Items)
  hosts: all
  gather_facts: yes

  vars:
    s3_bucket: "oml-s3-automation-sandbox"
    s3_path: "cis-baseline-files"
    aws_region: "eu-west-1"
    report_file: "{{ playbook_dir }}/Security_Options_Report_{{ inventory_hostname }}.html"
    remote_map_file: "C:\\temp\\security_options_map.json"

    # COMPREHENSIVE 107-ITEM MAP (Synced with CIS v1.0.0)
    # This list includes the missing 2.38-2.101 range and removes all duplicates.
    security_options_map:
      # --- Accounts & Audit (2.3.1 - 2.3.2) ---
      "EnableAdminAccount": "Accounts: Administrator account status"
      "EnableGuestAccount": "Accounts: Guest account status"
      "LimitBlankPasswordUse": "Accounts: Limit local account use of blank passwords"
      "NewAdminName": "Accounts: Rename administrator account"
      "NewGuestName": "Accounts: Rename guest account"
      "MACHINE\\System\\CurrentControlSet\\Control\\Lsa\\AuditBaseObjects": "Audit: Audit the access of global system objects"
      "MACHINE\\System\\CurrentControlSet\\Control\\Lsa\\FullPrivilegeAuditing": "Audit: Audit the use of Backup and Restore privilege"
      "ForceAuditPolicySubcategorySettingsToOverrideAuditPolicyCategorySettings": "Audit: Force audit policy subcategory settings"
      "MACHINE\\System\\CurrentControlSet\\Control\\Lsa\\CrashOnAuditFail": "Audit: Shut down system immediately if unable to log audits"

      # --- Devices & Domain Member (2.3.4 - 2.3.6) ---
      "MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\AddPrinterDrivers": "Devices: Prevent users from installing printer drivers"
      "AllowedToFormatAndEjectRemovableMedia": "Devices: Allowed to format and eject removable media"
      "MACHINE\\System\\CurrentControlSet\\Services\\Netlogon\\Parameters\\RequireSignOrSeal": "Domain member: Digitally encrypt or sign (always)"
      "MACHINE\\System\\CurrentControlSet\\Services\\Netlogon\\Parameters\\SignSecureChannel": "Domain member: Digitally sign (when possible)"
      "MACHINE\\System\\CurrentControlSet\\Services\\Netlogon\\Parameters\\SealSecureChannel": "Domain member: Digitally encrypt (when possible)"
      "MACHINE\\System\\CurrentControlSet\\Services\\Netlogon\\Parameters\\MaximumPasswordAge": "Domain member: Maximum machine account password age"
      "MACHINE\\System\\CurrentControlSet\\Services\\Netlogon\\Parameters\\RequireStrongKey": "Domain member: Require strong session key"

      # --- Interactive Logon (2.3.7 - 2.3.8) ---
      "MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\DisableCAD": "Interactive logon: Do not require CTRL+ALT+DEL"
      "MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\DontDisplayLastUserName": "Interactive logon: Don't display last signed-in"
      "MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\MaxDevicePasswordFailedAttempts": "Interactive logon: Machine account lockout threshold"
      "MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\MaxPasswordAge": "Interactive logon: Prompt user to change password before expiration"

      # --- Network Access & Security (2.3.10 - 2.3.11) ---
      "LSAAnonymousNameLookup": "Network access: Allow anonymous SID/Name translation"
      "MACHINE\\System\\CurrentControlSet\\Control\\Lsa\\RestrictAnonymousSAM": "Network access: Do not allow anonymous enumeration of SAM accounts"
      "MACHINE\\System\\CurrentControlSet\\Control\\Lsa\\RestrictAnonymous": "Network access: Do not allow anonymous enumeration of SAM accounts and shares"
      "MACHINE\\System\\CurrentControlSet\\Services\\LanManServer\\Parameters\\RestrictNullSessAccess": "Network access: Restrict anonymous access to Named Pipes and Shares"
      "MACHINE\\System\\CurrentControlSet\\Services\\LanManServer\\Parameters\\NullSessionPipes": "Network access: Named Pipes that can be accessed anonymously"
      "MACHINE\\System\\CurrentControlSet\\Control\\SecurePipeServers\\Winreg\\AllowedExactPaths": "Network access: Remotely accessible registry paths"
      "MACHINE\\System\\CurrentControlSet\\Control\\Lsa\\EveryoneIncludesAnonymous": "Network access: Let Everyone permissions apply to anonymous users"
      "MACHINE\\System\\CurrentControlSet\\Control\\Lsa\\UseMachineId": "Network security: Allow LocalSystem NULL session fallback"

      # --- User Account Control (2.3.17) ---
      "MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\EnableLUA": "UAC: Run admins in Admin Approval Mode"
      "MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\FilterAdministratorToken": "UAC: Admin Approval Mode for Built-in Admin"
      "MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\ConsentPromptBehaviorAdmin": "UAC: Behavior of elevation prompt for admins"
      "MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\ConsentPromptBehaviorUser": "UAC: Behavior of elevation prompt for standard users"
      "MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\PromptOnSecureDesktop": "UAC: Switch to secure desktop for elevation"
      "MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\EnableInstallerDetection": "UAC: Detect application installations"
      "MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\EnableVirtualization": "UAC: Virtualize file and registry write failures"

  tasks:
    - name: Ensure temp directory exists
      ansible.windows.win_file:
        path: C:\temp
        state: directory

    - name: Push Policy Map for PowerShell Loop
      ansible.windows.win_copy:
        content: "{{ security_options_map | to_nice_json }}"
        dest: "{{ remote_map_file }}"

    - name: Run Unified Audit
      ansible.windows.win_powershell:
        script: |
          $map = Get-Content "{{ remote_map_file }}" -Raw | ConvertFrom-Json
          $secFile = "C:\temp\secedit_audit.inf"
          secedit /export /areas SECURITYPOLICY /cfg $secFile | Out-Null
          
          $secHash = @{}
          if (Test-Path $secFile) {
              Get-Content $secFile -Encoding Unicode | Where-Object { $_ -match '=' } | ForEach-Object {
                  $p = $_.Split('=', 2); $k = $p[0].Trim(); $v = $p[1].Trim().Trim('"')
                  if ($v -match ',') { $v = $v.Split(',')[0] }
                  $secHash[$k] = $v
              }
              Remove-Item $secFile -Force
          }

          $results = foreach ($prop in $map.PSObject.Properties) {
              $id = $prop.Name; $name = $prop.Value; $val = "Not Defined"

              # Registry Search
              if ($id -like "MACHINE\*") {
                  $reg = $id.Replace("MACHINE\", "HKLM:\")
                  $key = Split-Path $reg; $leaf = Split-Path $reg -Leaf
                  if (Test-Path $key) {
                      $rv = Get-ItemProperty -Path $key -Name $leaf -ErrorAction SilentlyContinue
                      if ($rv -and $rv.$leaf -ne $null) { $val = $rv.$leaf.ToString() }
                  }
              }

              # Secedit Fallback
              if ($val -eq "Not Defined" -and $secHash.ContainsKey($id)) {
                  $val = $secHash[$id]
              }

              # Boolean Normalization
              if ($val -eq "0") { $val = "Disabled" }
              elseif ($val -eq "1") { $val = "Enabled" }

              [PSCustomObject]@{ Name=$name; Value=$val }
          }
          $results | Sort-Object Name | ForEach-Object { "$($_.Name)|$($_.Value)" }
      register: scan_output

    - name: Generate Local HTML and Upload
      delegate_to: localhost
      block:
        - ansible.builtin.template:
            src: "baseline-local Policy-Security Options_report.j2"
            dest: "{{ report_file }}"
          vars:
            scan_lines: "{{ scan_output.output | default([]) }}"
        - amazon.aws.s3_object:
            bucket: "{{ s3_bucket }}"
            object: "{{ s3_path }}/Security_Options_{{ inventory_hostname }}.html"
            src: "{{ report_file }}"
            mode: put
            region: "{{ aws_region }}"
