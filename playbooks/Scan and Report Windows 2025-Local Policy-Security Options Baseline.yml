- name: Scan Windows 2025 Security Options (Target 104)
  hosts: all
  gather_facts: yes
  vars:
    s3_bucket: "oml-s3-automation-sandbox"
    s3_path: "cis-baseline-files"
    aws_region: "eu-west-1"
    report_file: "/runner/project/playbooks/Security_Options_Report.html"
    remote_map_file: "C:\\temp\\security_options_map.json"

    security_options_map:
      "EnableAdminAccount": "Accounts: Administrator account status"
      "BlockConsumerMicrosoftAccounts": "Accounts: Block Microsoft accounts"
      "EnableGuestAccount": "Accounts: Guest account status"
      "LimitBlankPasswordUse": "Accounts: Limit local account use of blank passwords to console logon only"
      "NewAdminName": "Accounts: Rename administrator account"
      "NewGuestName": "Accounts: Rename guest account"
      "MACHINE\\System\\CurrentControlSet\\Control\\Lsa\\AuditBaseObjects": "Audit: Audit the access of global system objects"
      "MACHINE\\System\\CurrentControlSet\\Control\\Lsa\\FullPrivilegeAuditing": "Audit: Audit the use of Backup and Restore privilege"
      "ForceAuditPolicySubcategorySettingsToOverrideAuditPolicyCategorySettings": "Audit: Force audit policy subcategory settings to override audit policy category settings"
      "MACHINE\\System\\CurrentControlSet\\Control\\Lsa\\CrashOnAuditFail": "Audit: Shut down system immediately if unable to log security audits"
      "MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\UndockWithoutLogon": "Devices: Allow undock without having to log on"
      "AllowedToFormatAndEjectRemovableMedia": "Devices: Allowed to format and eject removable media"
      "MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\AddPrinterDrivers": "Devices: Prevent users from installing printer drivers"
      "MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\RestrictCDROM": "Devices: Restrict CD-ROM access to locally logged-on user only"
      "MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\RestrictFloppy": "Devices: Restrict floppy access to locally logged-on user only"
      "MACHINE\\System\\CurrentControlSet\\Services\\Netlogon\\Parameters\\RequireSignOrSeal": "Domain member: Digitally encrypt or sign secure channel data (always)"
      "MACHINE\\System\\CurrentControlSet\\Services\\Netlogon\\Parameters\\SealSecureChannel": "Domain member: Digitally encrypt secure channel data (when possible)"
      "MACHINE\\System\\CurrentControlSet\\Services\\Netlogon\\Parameters\\SignSecureChannel": "Domain member: Digitally sign secure channel data (when possible)"
      "MACHINE\\System\\CurrentControlSet\\Services\\Netlogon\\Parameters\\DisablePasswordChange": "Domain member: Disable machine account password changes"
      "MACHINE\\System\\CurrentControlSet\\Services\\Netlogon\\Parameters\\MaximumPasswordAge": "Domain member: Maximum machine account password age"
      "MACHINE\\System\\CurrentControlSet\\Services\\Netlogon\\Parameters\\RequireStrongKey": "Domain member: Require strong (Windows 2000 or later) session key"
      "MACHINE\\System\\CurrentControlSet\\Services\\Netlogon\\Parameters\\RefusePasswordChange": "Domain member: Refuse machine account password changes"
      "MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\DontDisplayLastUserName": "Interactive logon: Don't display last signed-in"
      "MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\DisableCAD": "Interactive logon: Do not require CTRL+ALT+DEL"
      "MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\InactivityTimeoutSecs": "Interactive logon: Machine inactivity limit"
      "MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\MaxDevicePasswordFailedAttempts": "Interactive logon: Machine account lockout threshold"
      "MACHINE\\Software\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon\\CachedLogonsCount": "Interactive logon: Number of previous logons to cache"
      "MACHINE\\Software\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon\\PasswordExpiryWarning": "Interactive logon: Prompt user to change password before expiration"
      "MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\ShutdownWithoutLogon": "Interactive logon: Allow system shutdown without having to log on"
      "MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\ScForceOption": "Interactive logon: Require smart card"
      "MACHINE\\Software\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon\\ScRemoveOption": "Interactive logon: Smart card removal behavior"
      "MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\DisplayLogonInfo": "Interactive logon: Display user information when the session is locked"
      "MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\DontDisplayUsername": "Interactive logon: Don't display username at sign-in"
      "MACHINE\\System\\CurrentControlSet\\Services\\LanmanWorkstation\\Parameters\\EnableSecuritySignature": "Microsoft network client: Digitally sign communications (always)"
      "MACHINE\\System\\CurrentControlSet\\Services\\LanmanWorkstation\\Parameters\\RequireSecuritySignature": "Microsoft network client: Digitally sign communications (if server agrees)"
      "MACHINE\\System\\CurrentControlSet\\Services\\LanmanWorkstation\\Parameters\\EnablePlainTextPassword": "Microsoft network client: Send unencrypted password to third-party SMB servers"
      "MACHINE\\System\\CurrentControlSet\\Services\\LanManServer\\Parameters\\EnableSecuritySignature": "Microsoft network server: Digitally sign communications (always)"
      "MACHINE\\System\\CurrentControlSet\\Services\\LanManServer\\Parameters\\RequireSecuritySignature": "Microsoft network server: Digitally sign communications (if client agrees)"
      "MACHINE\\System\\CurrentControlSet\\Services\\LanManServer\\Parameters\\AutoDisconnect": "Microsoft network server: Amount of idle time required before suspending session"
      "MACHINE\\System\\CurrentControlSet\\Services\\LanManServer\\Parameters\\EnableForcedLogOff": "Microsoft network server: Disconnect clients when logon hours expire"
      "LSAAnonymousNameLookup": "Network access: Allow anonymous SID/Name translation"
      "RestrictAnonymousSAM": "Network access: Do not allow anonymous enumeration of SAM accounts"
      "RestrictAnonymous": "Network access: Do not allow anonymous enumeration of SAM accounts and shares"
      "MACHINE\\System\\CurrentControlSet\\Control\\Lsa\\EveryoneIncludesAnonymous": "Network access: Let Everyone permissions apply to anonymous users"
      "MACHINE\\System\\CurrentControlSet\\Services\\LanManServer\\Parameters\\RestrictNullSessAccess": "Network access: Restrict anonymous access to Named Pipes and Shares"
      "MACHINE\\System\\CurrentControlSet\\Control\\Lsa\\LimitBlankPasswordUse": "Network access: Remotely accessible registry paths"
      "MACHINE\\System\\CurrentControlSet\\Services\\LanManServer\\Parameters\\NullSessionPipes": "Network access: Named Pipes that can be accessed anonymously"
      "MACHINE\\System\\CurrentControlSet\\Services\\LanManServer\\Parameters\\NullSessionShares": "Network access: Shares that can be accessed anonymously"
      "MACHINE\\System\\CurrentControlSet\\Control\\Lsa\\ForceGuest": "Network access: Sharing and security model for local accounts"
      "MACHINE\\System\\CurrentControlSet\\Control\\Lsa\\NoLMHash": "Network security: Do not store LAN Manager hash value on next password change"
      "MACHINE\\System\\CurrentControlSet\\Control\\Lsa\\LmCompatibilityLevel": "Network security: LAN Manager authentication level"
      "MACHINE\\System\\CurrentControlSet\\Control\\Lsa\\MSV1_0\\NTLMMinClientSec": "Network security: Minimum session security for NTLM SSP based clients"
      "MACHINE\\System\\CurrentControlSet\\Control\\Lsa\\MSV1_0\\NTLMMinServerSec": "Network security: Minimum session security for NTLM SSP based servers"
      "MACHINE\\System\\CurrentControlSet\\Control\\Lsa\\RestrictNTLM\\AuditIncomingTraffic": "Network security: Restrict NTLM: Audit Incoming NTLM Traffic"
      "MACHINE\\System\\CurrentControlSet\\Control\\Lsa\\RestrictNTLM\\InboundNTLMTraffic": "Network security: Restrict NTLM: Incoming NTLM traffic"
      "MACHINE\\System\\CurrentControlSet\\Control\\Lsa\\RestrictNTLM\\OutboundNTLMTraffic": "Network security: Restrict NTLM: Outgoing NTLM traffic to remote servers"
      "MACHINE\\System\\CurrentControlSet\\Control\\Lsa\\RestrictNTLM\\AuditOutgoingTraffic": "Network security: Restrict NTLM: Audit NTLM authentication in this domain"
      "MACHINE\\System\\CurrentControlSet\\Services\\LDAP\\LDAPClientIntegrity": "Network security: LDAP client signing requirements"
      "MACHINE\\System\\CurrentControlSet\\Control\\Lsa\\NoAdapterLsa": "Network security: Allow LocalSystem NULL session fallback"
      "MACHINE\\System\\CurrentControlSet\\Control\\Lsa\\NegOption": "Network security: Allow PKU2U authentication requests"
      "MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\ConsentPromptBehaviorAdmin": "User Account Control: Behavior of the elevation prompt for administrators"
      "MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\ConsentPromptBehaviorUser": "User Account Control: Behavior of the elevation prompt for standard users"
      "MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\EnableLUA": "User Account Control: Run all administrators in Admin Approval Mode"
      "MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\PromptOnSecureDesktop": "User Account Control: Switch to the desktop when prompting for elevation"
      "MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\EnableInstallerDetection": "User Account Control: Detect application installations and prompt for elevation"
      "MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\FilterAdministratorToken": "User Account Control: Admin Approval Mode for the Built-in Administrator account"
      "MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\EnableUIADesktopToggle": "User Account Control: Allow UIAccess applications to prompt for elevation"
      "MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\EnableSecureUIAPaths": "User Account Control: Only elevate UIAccess applications that are installed in secure locations"
      "MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\EnableVirtualization": "User Account Control: Virtualize file and registry write failures to per-user locations"
      "MACHINE\\Software\\Microsoft\\Windows NT\\CurrentVersion\\Setup\\RecoveryConsole\\SecurityLevel": "Recovery console: Allow automatic administrative logon"
      "MACHINE\\Software\\Microsoft\\Windows NT\\CurrentVersion\\Setup\\RecoveryConsole\\SetCommand": "Recovery console: Allow floppy copy and access to all drives"
      "MACHINE\\System\\CurrentControlSet\\Control\\Session Manager\\Memory Management\\ClearPageFileAtShutdown": "Shutdown: Clear virtual memory pagefile"
      "MACHINE\\System\\CurrentControlSet\\Control\\Session Manager\\ProtectionMode": "System objects: Strengthen default permissions of internal system objects"
      "MACHINE\\System\\CurrentControlSet\\Control\\Lsa\\FipsAlgorithmPolicy\\Enabled": "System settings: Use FIPS compliant algorithms for encryption"
      "MACHINE\\System\\CurrentControlSet\\Services\\Tcpip\\Parameters\\TcpMaxConnectResponseRetransmissions": "MSS: SYN Attack Protection"
      "MACHINE\\System\\CurrentControlSet\\Services\\Tcpip\\Parameters\\EnableICMPRedirect": "MSS: Allow ICMP redirects"
      "MACHINE\\System\\CurrentControlSet\\Control\\Session Manager\\SafeDllSearchMode": "MSS: Enable Safe DLL search mode"
      "MACHINE\\System\\CurrentControlSet\\Services\\Tcpip\\Parameters\\DisableIPSourceRouting": "MSS: IP source routing protection"
      "MACHINE\\System\\CurrentControlSet\\Services\\Netbt\\Parameters\\NoNameReleaseOnDemand": "MSS: Ignore NetBIOS name release requests"

  tasks:
    - name: Prepare Workspace
      ansible.windows.win_file:
        path: C:\temp
        state: directory

    - name: Transfer Policy Map
      ansible.windows.win_copy:
        content: "{{ security_options_map | to_nice_json }}"
        dest: "{{ remote_map_file }}"

    - name: Run Security Audit
      ansible.windows.win_shell: |
        {% raw %}
        $map = Get-Content "C:\temp\security_options_map.json" | ConvertFrom-Json
        $configFile = "C:\temp\secedit_options.inf"
        secedit /export /areas SECURITYPOLICY /cfg $configFile | Out-Null
        
        $secHash = @{}
        if (Test-Path $configFile) {
            Get-Content $configFile -Encoding Unicode | ForEach-Object {
                if ($_ -match '=') {
                    $p = $_.Split('=', 2); $secHash[$p[0].Trim()] = $p[1].Trim().Trim('"')
                }
            }
            Remove-Item $configFile
        }

        $results = foreach ($id in $map.psobject.Properties.Name) {
            $val = "Not Defined"; $policyName = $map.$id
            
            if ($id -like "MACHINE\*") {
                $f = $id.Replace("MACHINE\", "HKLM:\"); $p = Split-Path $f; $n = Split-Path $f -Leaf
                if (Test-Path $p) {
                    $rv = Get-ItemProperty -Path $p -Name $n -ErrorAction SilentlyContinue
                    if ($rv -and $rv.$n -ne $null) { $val = $rv.$n }
                }
            }
            
            $shortId = Split-Path $id -Leaf
            if ($val -eq "Not Defined") {
                if ($secHash.ContainsKey($id)) { $val = $secHash[$id] }
                elseif ($secHash.ContainsKey($shortId)) { $val = $secHash[$shortId] }
            }

            if ($val -eq "536870912") { $val = "Require 128-bit encryption" }
            elseif ($val -eq "0" -or $val -eq "0,0") { $val = "Disabled" }
            elseif ($val -eq "1" -or $val -eq "1,0") { $val = "Enabled" }
            
            [PSCustomObject]@{ Name = $policyName; Value = $val }
        }
        $results | Sort-Object Name | ForEach-Object { "$($_.Name)|$($_.Value)" }
        {% endraw %}
      register: security_scan_raw

    - name: Build Report
      delegate_to: localhost
      ansible.builtin.copy:
        dest: "{{ report_file }}"
        content: |
          <!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <title>Security Audit - {{ inventory_hostname }}</title>
              <style>
                  body { font-family: 'Segoe UI', Arial, sans-serif; margin: 30px; background-color: #f4f7f9; color: #333; }
                  .report-box { background: #fff; padding: 25px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); max-width: 1100px; margin: auto; }
                  h2 { color: #232f3e; border-bottom: 3px solid #007bff; padding-bottom: 10px; }
                  .info-bar { margin: 15px 0; padding: 10px; background: #e9ecef; border-radius: 5px; font-weight: bold; }
                  table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                  th { background-color: #232f3e; color: #fff; padding: 12px; text-align: left; }
                  td { padding: 10px 12px; border-bottom: 1px solid #ddd; font-size: 0.9em; }
                  tr:hover { background-color: #f1f1f1; }
                  .Enabled, .Administrator { color: #28a745; font-weight: bold; }
                  .Disabled { color: #dc3545; font-weight: bold; }
                  .Not { color: #888; font-style: italic; }
              </style>
          </head>
          <body>
              <div class="report-box">
                  <h2>Windows Server 2025: Security Options Audit</h2>
                  <div class="info-bar">
                      Server: {{ inventory_hostname }} | 
                      Policies Scanned: {{ security_scan_raw.stdout_lines | length }}
                  </div>
                  <table>
                      <thead>
                          <tr><th>Security Policy Name</th><th>Configured Setting</th></tr>
                      </thead>
                      <tbody>
                          {% for line in security_scan_raw.stdout_lines %}
                          {% set parts = line.split('|') %}
                          <tr>
                              <td>{{ parts[0] }}</td>
                              <td class="{{ parts[1].split(' ')[0] }}">{{ parts[1] }}</td>
                          </tr>
                          {% endfor %}
                      </tbody>
                  </table>
              </div>
          </body>
          </html>

    - name: Push to S3
      delegate_to: localhost
      amazon.aws.s3_object:
        bucket: "{{ s3_bucket }}"
        object: "{{ s3_path }}/Security_Options_{{ inventory_hostname.split('.')[0] }}.html"
        src: "{{ report_file }}"
        mode: put
        region: "{{ aws_region }}"
