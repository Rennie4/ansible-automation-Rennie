- name: Scan Windows 2025 Security Options (Target 104 Settings)
  hosts: all
  gather_facts: yes
  vars:
    s3_bucket: "oml-s3-automation-sandbox"
    s3_path: "cis-baseline-files"
    aws_region: "eu-west-1"
    report_file: "/runner/project/playbooks/Security_Options_Report.html"

    security_options_map:
      # --- ACCOUNTS / PASSWORD POLICIES (Added to reach 104) ---
      "PasswordHistorySize": "Account Policy: Enforce password history"
      "MaximumPasswordAge": "Account Policy: Maximum password age"
      "MinimumPasswordAge": "Account Policy: Minimum password age"
      "MinimumPasswordLength": "Account Policy: Minimum password length"
      "PasswordComplexity": "Account Policy: Password must meet complexity requirements"
      "ClearTextPassword": "Account Policy: Store passwords using reversible encryption"
      "LockoutBadCount": "Account Policy: Account lockout threshold"
      "ResetLockoutCount": "Account Policy: Reset account lockout counter after"
      "LockoutDuration": "Account Policy: Account lockout duration"
      "EnableAdminAccount": "Accounts: Administrator account status"
      "BlockConsumerMicrosoftAccounts": "Accounts: Block Microsoft accounts"
      "EnableGuestAccount": "Accounts: Guest account status"
      "LimitBlankPasswordUse": "Accounts: Limit local account use of blank passwords to console logon only"
      "NewAdminName": "Accounts: Rename administrator account"
      "NewGuestName": "Accounts: Rename guest account"
      # --- AUDIT ---
      "MACHINE\\System\\CurrentControlSet\\Control\\Lsa\\AuditBaseObjects": "Audit: Audit the access of global system objects"
      "MACHINE\\System\\CurrentControlSet\\Control\\Lsa\\FullPrivilegeAuditing": "Audit: Audit the use of Backup and Restore privilege"
      "ForceAuditPolicySubcategorySettingsToOverrideAuditPolicyCategorySettings": "Audit: Force audit policy subcategory settings to override audit policy category settings"
      "MACHINE\\System\\CurrentControlSet\\Control\\Lsa\\CrashOnAuditFail": "Audit: Shut down system immediately if unable to log security audits"
      # --- DEVICES ---
      "MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\UndockWithoutLogon": "Devices: Allow undock without having to log on"
      "AllowedToFormatAndEjectRemovableMedia": "Devices: Allowed to format and eject removable media"
      "MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\AddPrinterDrivers": "Devices: Prevent users from installing printer drivers"
      "MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\RestrictCDROM": "Devices: Restrict CD-ROM access to locally logged-on user only"
      "MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\RestrictFloppy": "Devices: Restrict floppy access to locally logged-on user only"
      # --- DOMAIN MEMBER ---
      "MACHINE\\System\\CurrentControlSet\\Services\\Netlogon\\Parameters\\RequireSignOrSeal": "Domain member: Digitally encrypt or sign secure channel data (always)"
      "MACHINE\\System\\CurrentControlSet\\Services\\Netlogon\\Parameters\\SealSecureChannel": "Domain member: Digitally encrypt secure channel data (when possible)"
      "MACHINE\\System\\CurrentControlSet\\Services\\Netlogon\\Parameters\\SignSecureChannel": "Domain member: Digitally sign secure channel data (when possible)"
      "MACHINE\\System\\CurrentControlSet\\Services\\Netlogon\\Parameters\\DisablePasswordChange": "Domain member: Disable machine account password changes"
      "MACHINE\\System\\CurrentControlSet\\Services\\Netlogon\\Parameters\\RefusePasswordChange": "Domain member: Maximum machine account password age"
      "MACHINE\\System\\CurrentControlSet\\Services\\Netlogon\\Parameters\\RequireStrongKey": "Domain member: Require strong (Windows 2000 or later) session key"
      # --- INTERACTIVE LOGON ---
      "MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\DontDisplayLastUserName": "Interactive logon: Don't display last signed-in"
      "MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\DisableCAD": "Interactive logon: Do not require CTRL+ALT+DEL"
      "MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\InactivityTimeoutSecs": "Interactive logon: Machine inactivity limit"
      "MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\MaxDevicePasswordFailedAttempts": "Interactive logon: Machine account lockout threshold"
      "MACHINE\\Software\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon\\CachedLogonsCount": "Interactive logon: Number of previous logons to cache"
      "MACHINE\\Software\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon\\PasswordExpiryWarning": "Interactive logon: Prompt user to change password before expiration"
      "MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\ShutdownWithoutLogon": "Interactive logon: Allow system shutdown without having to log on"
      "MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\ScForceOption": "Interactive logon: Require smart card"
      "MACHINE\\Software\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon\\ScRemoveOption": "Interactive logon: Smart card removal behavior"
      "MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\DisplayLogonInfo": "Interactive logon: Display user information when the session is locked"
      "MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\DontDisplayUsername": "Interactive logon: Don't display username at sign-in"
      # --- NETWORK ACCESS & SECURITY ---
      "LSAAnonymousNameLookup": "Network access: Allow anonymous SID/Name translation"
      "RestrictAnonymousSAM": "Network access: Do not allow anonymous enumeration of SAM accounts"
      "RestrictAnonymous": "Network access: Do not allow anonymous enumeration of SAM accounts and shares"
      "MACHINE\\System\\CurrentControlSet\\Control\\Lsa\\EveryoneIncludesAnonymous": "Network access: Let Everyone permissions apply to anonymous users"
      "MACHINE\\System\\CurrentControlSet\\Services\\LanManServer\\Parameters\\RestrictNullSessAccess": "Network access: Restrict anonymous access to Named Pipes and Shares"
      "MACHINE\\System\\CurrentControlSet\\Control\\Lsa\\LimitBlankPasswordUse": "Network access: Remotely accessible registry paths"
      "MACHINE\\System\\CurrentControlSet\\Services\\LanManServer\\Parameters\\NullSessionPipes": "Network access: Named Pipes that can be accessed anonymously"
      "MACHINE\\System\\CurrentControlSet\\Services\\LanManServer\\Parameters\\NullSessionShares": "Network access: Shares that can be accessed anonymously"
      "MACHINE\\System\\CurrentControlSet\\Control\\Lsa\\ForceGuest": "Network access: Sharing and security model for local accounts"
      "MACHINE\\System\\CurrentControlSet\\Control\\Lsa\\NoLMHash": "Network security: Do not store LAN Manager hash value on next password change"
      "MACHINE\\System\\CurrentControlSet\\Control\\Lsa\\LmCompatibilityLevel": "Network security: LAN Manager authentication level"
      "MACHINE\\System\\CurrentControlSet\\Control\\Lsa\\MSV1_0\\NTLMMinClientSec": "Network security: Minimum session security for NTLM SSP based clients"
      "MACHINE\\System\\CurrentControlSet\\Control\\Lsa\\MSV1_0\\NTLMMinServerSec": "Network security: Minimum session security for NTLM SSP based servers"
      # --- MSS (Extra Legacy/Hardened Settings) ---
      "MACHINE\\System\\CurrentControlSet\\Services\\Tcpip\\Parameters\\DisableIPSourceRouting": "MSS: (DisableIPSourceRouting) IP source routing protection"
      "MACHINE\\System\\CurrentControlSet\\Services\\Netbt\\Parameters\\NoNameReleaseOnDemand": "MSS: (NoNameReleaseOnDemand) Allow the computer to ignore NetBIOS name release requests"
      "MACHINE\\System\\CurrentControlSet\\Control\\Session Manager\\SafeDllSearchMode": "MSS: (SafeDllSearchMode) Enable Safe DLL search mode"
      # --- UAC ---
      "MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\ConsentPromptBehaviorAdmin": "User Account Control: Behavior of the elevation prompt for administrators"
      "MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\ConsentPromptBehaviorUser": "User Account Control: Behavior of the elevation prompt for standard users"
      "MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\EnableLUA": "User Account Control: Run all administrators in Admin Approval Mode"
      "MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\PromptOnSecureDesktop": "User Account Control: Switch to the secure desktop when prompting for elevation"

  tasks:
    - name: Execute Comprehensive Security Scan
      ansible.windows.win_shell: |
        $map = @{
            {% for key, value in security_options_map.items() %}
            "{{ key }}" = "{{ value }}"
            {% endfor %}
        }
        
        # Export SAM and Security Policy
        $configFile = "C:\temp\secedit_full.inf"
        secedit /export /areas SECURITYPOLICY /cfg $configFile | Out-Null
        $secHash = @{}
        if (Test-Path $configFile) {
            Get-Content $configFile -Encoding Unicode | ForEach-Object {
                if ($_ -match '=') {
                    $parts = $_.Split('=', 2); $secHash[$parts[0].Trim()] = $parts[1].Trim().Trim('"')
                }
            }
            Remove-Item $configFile
        }

        $results = foreach ($id in $map.Keys) {
            $val = "Not Defined"
            $policyName = $map[$id]
            
            # Check Registry
            if ($id -like "MACHINE\*") {
                $fullPath = $id.Replace("MACHINE\", "HKLM:\")
                $regPath = Split-Path $fullPath; $regName = Split-Path $fullPath -Leaf
                if (Test-Path $regPath) {
                    $regVal = Get-ItemProperty -Path $regPath -Name $regName -ErrorAction SilentlyContinue
                    if ($regVal -and $regVal.$regName -ne $null) { $val = $regVal.$regName }
                }
            }
            
            # Check Secedit Export if Registry failed or if it's a SAM policy
            if (($val -eq "Not Defined" -or $val -eq $null) -and $secHash.ContainsKey($id)) {
                $val = $secHash[$id]
            }

            # Human Readable Formatting
            if ($val -eq "536870912") { $val = "Require 128-bit encryption" }
            elseif ($val -eq "0" -or $val -eq "0,0") { $val = "Disabled" }
            elseif ($val -eq "1" -or $val -eq "1,0") { $val = "Enabled" }
            elseif ($val -eq "3,0") { $val = "Disabled" }

            [PSCustomObject]@{ Name = $policyName; Value = $val }
        }

        $results | Sort-Object Name -Unique | ForEach-Object { Write-Output ($_.Name + "|" + $_.Value) }
      register: security_scan_raw

    - name: Generate HTML Report
      delegate_to: localhost
      ansible.builtin.copy:
        dest: "{{ report_file }}"
        content: |
          <!DOCTYPE html>
          <html>
          <head>
              <title>Security Audit - {{ inventory_hostname }}</title>
              <style>
                  body { font-family: sans-serif; margin: 40px; background: #f4f7f6; }
                  .container { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
                  h2 { border-bottom: 2px solid #007bff; padding-bottom: 10px; }
                  table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                  th { background: #232f3e; color: white; padding: 12px; text-align: left; }
                  td { padding: 10px; border-bottom: 1px solid #eee; font-size: 14px; }
                  .Enabled { color: green; font-weight: bold; }
                  .Disabled { color: red; font-weight: bold; }
              </style>
          </head>
          <body>
              <div class="container">
                  <h2>Windows Server 2025 Security Audit</h2>
                  <p><strong>Server:</strong> {{ inventory_hostname }} | <strong>Total Policies:</strong> {{ security_scan_raw.stdout_lines | length }}</p>
                  <table>
                      <tr><th>Policy Name</th><th>Setting</th></tr>
                      {% for line in security_scan_raw.stdout_lines %}
                      {% set parts = line.split('|') %}
                      <tr><td>{{ parts[0] }}</td><td class="{{ parts[1] }}">{{ parts[1] }}</td></tr>
                      {% endfor %}
                  </table>
              </div>
          </body>
          </html>

    - name: Upload to S3
      delegate_to: localhost
      amazon.aws.s3_object:
        bucket: "{{ s3_bucket }}"
        object: "{{ s3_path }}/Security_Options_{{ inventory_hostname }}.html"
        src: "{{ report_file }}"
        mode: put
        region: "{{ aws_region }}"
