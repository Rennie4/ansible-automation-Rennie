---
- name: Scan and Report Windows Local Policy - Security Options Baseline
  hosts: windows_server_2025
  gather_facts: no

  tasks:
    - name: Download security_options_map.json from S3
      aws_s3:
        bucket: oml-s3-automation-sandbox
        object: cis-baseline-files/security_options_map.json
        dest: C:\temp\security_options_map.json
        mode: get

    - name: Run Comprehensive Audit
      win_shell: |
        {% raw %}
        $map = Get-Content "C:\temp\security_options_map.json" | ConvertFrom-Json

        $secFile = "C:\temp\secedit_audit.inf"
        secedit /export /areas SECURITYPOLICY /cfg $secFile | Out-Null

        $sec = [ordered]@{
          RegistryValues = @{}
          SystemAccess   = @{}
        }

        function Parse-SeceditFile {
          param([string]$Path)
          if (-not (Test-Path $Path)) { return }
          $current = ""
          Get-Content -Path $Path -Encoding Unicode | ForEach-Object {
            $line = $_.Trim()
            if (-not $line) { return }
            if ($line -match '^\[(.+)\]$') { $current = $matches[1]; return }
            if ($line -notmatch '=') { return }
            $kv = $line.Split('=', 2)
            $k  = $kv[0].Trim()
            $v  = $kv[1].Trim()
            switch ($current) {
              'Registry Values' {
                $type = $null; $data = $v
                if ($v -match '^\s*(\d+)\s*,\s*(.*)$') {
                  $type = $matches[1]; $data = $matches[2].Trim()
                }
                $data = $data.Trim('"')
                $sec.RegistryValues[$k] = [pscustomobject]@{ Type = $type; Data = $data }
              }
              'System Access' { $sec.SystemAccess[$k] = $v.Trim('"') }
            }
          }
        }

        Parse-SeceditFile -Path $secFile
        Remove-Item -Path $secFile -ErrorAction SilentlyContinue

        function Convert-MachineToHKLM {
          param([string]$machineKey)
          $hklm = $machineKey.Replace('MACHINE\', 'HKLM:\')
          $path = Split-Path $hklm
          $name = Split-Path $hklm -Leaf
          return @{ Path = $path; Name = $name }
        }

        function Try-GetRegistry {
          param([string]$machineKey)
          $p = Convert-MachineToHKLM -machineKey $machineKey
          if (-not (Test-Path $p.Path)) { return $null }
          try {
            $val = (Get-ItemProperty -Path $p.Path -Name $p.Name -ErrorAction Stop).($p.Name)
            if ($val -is [array]) { return ($val -join '; ') }
            return $val
          } catch { return $null }
        }

        function Normalize-Value {
          param([string]$policyName,[string]$raw)
          if ($null -eq $raw -or $raw -eq '') { return 'Not Defined' }
          if ($raw -eq '0') { return 'Disabled (0)' }
          if ($raw -eq '1') { return 'Enabled (1)' }
          if ($raw -eq '536870912') { return 'Require 128-bit encryption (536870912)' }
          return $raw
        }

        $results = foreach ($id in $map.psobject.Properties.Name) {
          $display = $map.$id; $val = $null
          if ($id -like 'MACHINE\*') {
            if ($sec.RegistryValues.ContainsKey($id)) { $val = $sec.RegistryValues[$id].Data }
            if (-not $val) {
              $val = Try-GetRegistry -machineKey $id
              if ($val -is [int]) { $val = [string]$val }
              elseif ($val -is [bool]) { $val = if ($val) {'1'} else {'0'} }
            }
          } else {
            if ($sec.SystemAccess.ContainsKey($id)) { $val = $sec.SystemAccess[$id] }
            else {
              $leaf = Split-Path $id -Leaf
              $maybe = $sec.RegistryValues.Keys | Where-Object { $_ -match "\\$leaf$" }
              if ($maybe) { $val = $sec.RegistryValues[$maybe[0]].Data }
            }
          }
          if (-not $val) { $val = 'Not Defined' }
          $shown = Normalize-Value -policyName $display -raw ([string]$val)
          [PSCustomObject]@{ Name = $display; Value = $shown }
        }

        # Save results to CSV
        $results | Sort-Object Name | Export-Csv -Path "C:\temp\security_audit_results.csv" -NoTypeInformation
        {% endraw %}
      register: scan_output

    - name: Show audit results path
      debug:
        msg: "Audit results saved to C:\\temp\\security_audit_results.csv"
