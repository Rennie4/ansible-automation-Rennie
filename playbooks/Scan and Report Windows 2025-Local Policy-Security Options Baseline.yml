---
- name: Windows Server 2025 - 82 Security Options Audit
  hosts: all
  gather_facts: yes
  vars:
    # This ensures the report is saved in your current home directory for easy access
    report_destination: "{{ lookup('env', 'HOME') }}/security_audit_reports"
    report_file_name: "Security_Options_{{ inventory_hostname }}.html"
    
    security_options_map:
      # --- Accounts & Audit ---
      "EnableAdminAccount": "Accounts: Administrator account status"
      "EnableGuestAccount": "Accounts: Guest account status"
      "LimitBlankPasswordUse": "Accounts: Limit local account use of blank passwords"
      "NewAdminName": "Accounts: Rename administrator account"
      "NewGuestName": "Accounts: Rename guest account"
      "MACHINE\\System\\CurrentControlSet\\Control\\Lsa\\AuditBaseObjects": "Audit: Audit the access of global system objects"
      "MACHINE\\System\\CurrentControlSet\\Control\\Lsa\\FullPrivilegeAuditing": "Audit: Audit the use of Backup and Restore privilege"
      "ForceAuditPolicySubcategorySettingsToOverrideAuditPolicyCategorySettings": "Audit: Force audit policy subcategory settings"
      
      # --- Network Access & Security ---
      "LSAAnonymousNameLookup": "Network access: Allow anonymous SID/Name translation"
      "MACHINE\\System\\CurrentControlSet\\Control\\Lsa\\RestrictAnonymous": "Network access: Do not allow anonymous enumeration of SAM accounts and shares"
      "MACHINE\\System\\CurrentControlSet\\Control\\Lsa\\NoLMHash": "Network security: Do not store LAN Manager hash"
      "MACHINE\\System\\CurrentControlSet\\Services\\LDAP\\LDAPClientIntegrity": "Network security: LDAP client signing"
      
      # --- Microsoft Network Client & Server ---
      "MACHINE\\System\\CurrentControlSet\\Services\\LanmanWorkstation\\Parameters\\EnableSecuritySignature": "Microsoft network client: Digitally sign (always)"
      "MACHINE\\System\\CurrentControlSet\\Services\\LanManServer\\Parameters\\EnableSecuritySignature": "Microsoft network server: Digitally sign (always)"
      "MACHINE\\System\\CurrentControlSet\\Services\\LanManServer\\Parameters\\AutoDisconnect": "Microsoft network server: Idle time before suspending"
      
      # --- System & UAC ---
      "MACHINE\\System\\CurrentControlSet\\Control\\Lsa\\FipsAlgorithmPolicy\\Enabled": "System settings: Use FIPS compliant algorithms"
      "MACHINE\\System\\CurrentControlSet\\Control\\Session Manager\\ProtectionMode": "System objects: Strengthen default permissions"
      "MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\EnableLUA": "UAC: Run admins in Admin Approval Mode"
      "MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\ConsentPromptBehaviorAdmin": "UAC: Elevation prompt for admins"
      "MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\PromptOnSecureDesktop": "UAC: Switch to secure desktop for elevation"

  tasks:
    - name: Ensure Local Report Directory Exists
      delegate_to: localhost
      ansible.builtin.file:
        path: "{{ report_destination }}"
        state: directory
        mode: '0755'

    - name: Run Security Audit on Windows
      ansible.windows.win_shell: |
        $map = @'
        {{ security_options_map | to_json }}
        '@ | ConvertFrom-Json
        
        $secFile = "C:\temp\secedit_audit.inf"
        secedit /export /areas SECURITYPOLICY /cfg $secFile | Out-Null
        $secHash = @{}
        if (Test-Path $secFile) {
            Get-Content $secFile -Encoding Unicode | ForEach-Object {
                if ($_ -match '=') {
                    $p = $_.Split('=', 2); $k = $p[0].Trim(); $v = $p[1].Trim().Trim('"')
                    $secHash[$k] = $v
                }
            }
        }

        $results = foreach ($prop in $map.psobject.Properties) {
            $id = $prop.Name; $pName = $prop.Value; $val = "Not Defined"
            if ($id -like "MACHINE\*") {
                $regPath = $id.Replace("MACHINE\", "HKLM:\")
                $key = Split-Path $regPath; $name = Split-Path $regPath -Leaf
                if (Test-Path $key) {
                    $rv = Get-ItemProperty -Path $key -Name $name -ErrorAction SilentlyContinue
                    if ($rv -and $rv.$name -ne $null) { $val = $rv.$name.ToString() }
                }
            }
            if ($val -eq "Not Defined" -and $secHash.ContainsKey($id)) { $val = $secHash[$id] }
            if ($val -eq "0") { $val = "Disabled" } elseif ($val -eq "1") { $val = "Enabled" }
            [PSCustomObject]@{ Name = $pName; Value = $val }
        }
        $results | Sort-Object Name | ForEach-Object { "$($_.Name)|$($_.Value)" }
      register: scan_output

    - name: Generate the HTML Report locally
      delegate_to: localhost
      ansible.builtin.template:
        src: "../templates/baseline-local Policy-Security Options_report.j2"
        dest: "{{ report_destination }}/{{ report_file_name }}"

    - name: DISPLAY REPORT LOCATION
      delegate_to: localhost
      ansible.builtin.debug:
        msg: "REPORT GENERATED SUCCESSFULLY AT: {{ report_destination }}/{{ report_file_name }}"
