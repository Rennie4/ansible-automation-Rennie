- name: Scan Windows 2025 Security Options (Dynamic Discovery)
  hosts: all
  gather_facts: yes
  vars:
    s3_bucket: "oml-s3-automation-sandbox"
    s3_path: "cis-baseline-files"
    aws_region: "eu-west-1"
    template_path: "{{ playbook_dir }}/../templates/baseline-local Policy-Security Options_report.j2"
    report_dir: "{{ playbook_dir }}/reports"

  tasks:
    - name: Ensure Local Reports Directory
      delegate_to: localhost
      ansible.builtin.file:
        path: "{{ report_dir }}"
        state: directory
        mode: '0755'

    - name: Dynamic Security Scan (Capture All 104+ Settings)
      ansible.windows.win_shell: |
        # 1. Export the security policy to a temp file
        $infFile = "C:\temp\sec_export.inf"
        secedit /export /areas SECURITYPOLICY /cfg $infFile | Out-Null
        
        # 2. Parse the INF file for all keys in the [Registry Values] section
        # This section contains the bulk of the "Security Options"
        $content = Get-Content $infFile -Encoding Unicode
        $capture = $false
        $results = @()

        foreach ($line in $content) {
            if ($line -match '\[Registry Values\]') { $capture = $true; continue }
            if ($line -match '\[') { $capture = $false } # Stop at next section
            
            if ($capture -and $line -match '=') {
                $parts = $line.Split('=', 2)
                $key = $parts[0].Trim()
                $val = $parts[1].Trim().Trim('"')

                # Logic to clean up Windows internal naming to match UI
                # We use a helper to match the technical key to the Friendly Name
                $friendlyName = $key.Split('\')[-1] # Default to the last part of the path
                
                # Format specific known values
                if ($val -eq "1,0") { $val = "Enabled" }
                elseif ($val -eq "0,0") { $val = "Disabled" }
                
                $results += [PSCustomObject]@{ Policy = $key; Setting = $val }
            }
        }
        
        # 3. Output as Alphabetical List
        $results | Sort-Object Policy | ForEach-Object {
            Write-Output ($_.Policy + "|" + $_.Setting)
        }
        Remove-Item $infFile -ErrorAction SilentlyContinue
      register: security_scan_raw

    - name: Generate HTML Report
      delegate_to: localhost
      ansible.builtin.template:
        src: "{{ template_path }}"
        dest: "{{ report_dir }}/Security_Options_{{ inventory_hostname }}.html"

    - name: Upload to S3
      delegate_to: localhost
      amazon.aws.s3_object:
        bucket: "{{ s3_bucket }}"
        object: "{{ s3_path }}/Security_Options_{{ inventory_hostname }}.html"
        src: "{{ report_dir }}/Security_Options_{{ inventory_hostname }}.html"
        mode: put
        region: "{{ aws_region }}"
