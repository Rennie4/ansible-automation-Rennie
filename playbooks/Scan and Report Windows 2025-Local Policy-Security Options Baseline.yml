---
- name: Comprehensive Windows 2025 Security Options Audit
  hosts: all
  gather_facts: yes
  vars:
    s3_bucket: "oml-s3-automation-sandbox"
    s3_path: "cis-baseline-files"
    aws_region: "eu-west-1"
    report_file: "{{ playbook_dir }}/reports/Security_Options_Report_{{ inventory_hostname }}.html"
    remote_map_file: "C:\\temp\\security_options_map.json"
    # ... (Keep your security_options_map here) ...

  tasks:
    # ... (Keep Prepare Workspace, Transfer Policy Map, and Run Comprehensive Audit tasks) ...

    - name: Ensure Local Report Directory Exists
      delegate_to: localhost
      ansible.builtin.file:
        path: "{{ playbook_dir }}/reports"
        state: directory

    - name: Generate HTML Report from Template
      delegate_to: localhost
      ansible.builtin.template:
        # This module renders the variables into the HTML
        src: "../templates/baseline-local Policy-Security Options_report.j2"
        dest: "{{ report_file }}"

    - name: Push to S3
      delegate_to: localhost
      amazon.aws.s3_object:
        bucket: "{{ s3_bucket }}"
        object: "{{ s3_path }}/Security_Options_{{ inventory_hostname.split('.')[0] }}.html"
        src: "{{ report_file }}"
        mode: put
        region: "{{ aws_region }}"
