---
- name: Scan and Report Windows Local Policy - Security Options Baseline
  hosts: windows_server_2025
  gather_facts: no

  tasks:
    - name: Download Baseline Reference from S3
      amazon.aws.s3_object:
        bucket: oml-s3-automation-sandbox
        object: cis-baseline-files/Security_Options_windows_server_2025.html
        dest: /tmp/Security_Options_windows_server_2025.html
        mode: get
      delegate_to: localhost
      register: s3_download
      ignore_errors: yes

    - name: List S3 Objects if download fails (Troubleshooting)
      amazon.aws.s3_object:
        bucket: oml-s3-automation-sandbox
        prefix: cis-baseline-files/
        mode: list
      delegate_to: localhost
      register: s3_list
      when: s3_download.failed

    - name: Display available files in S3
      debug:
        var: s3_list.s3_keys
      when: s3_download.failed

    - name: Stop if S3 file is missing
      fail:
        msg: "The file was not found. Check the debug output above for the correct filename."
      when: s3_download.failed

    - name: Generate Audit Script from Template
      win_template:
        src: ../templates/baseline-local Policy-Security Options_report.j2
        dest: C:\temp\run_security_options_audit.ps1

    - name: Execute Security Audit
      win_shell: C:\temp\run_security_options_audit.ps1
      register: scan_results

    - name: Show Results Path
      debug:
        msg: "Audit complete. Report generated at C:\\temp\\security_audit_results.csv"
