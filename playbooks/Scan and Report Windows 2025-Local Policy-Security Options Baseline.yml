---
- name: Scan and Report Windows Local Policy - Security Options Baseline
  hosts: windows_server_2025
  gather_facts: no

  tasks:
    - name: Download mapping file to Controller (Python-based task)
      amazon.aws.s3_object:
        bucket: oml-s3-automation-sandbox
        object: cis-baseline-files/security_options_map.json
        dest: /tmp/security_options_map.json
        mode: get
      delegate_to: localhost

    - name: Push mapping file to Windows Server (PowerShell-based task)
      win_copy:
        src: /tmp/security_options_map.json
        dest: C:\temp\security_options_map.json

    - name: Generate Audit Script from Jinja2 Template
      win_template:
        src: templates/baseline-local Policy-Security Options_report.j2
        dest: C:\temp\run_security_options_audit.ps1

    - name: Execute Security Audit
      win_shell: C:\temp\run_security_options_audit.ps1
      register: scan_results

    - name: Show Results Path
      debug:
        msg: "Audit complete. Report generated at C:\\temp\\security_audit_results.csv"
