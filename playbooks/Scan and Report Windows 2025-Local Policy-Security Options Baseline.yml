---
- name: Comprehensive Windows 2025 Security Options Audit
  hosts: windows_server_2025
  gather_facts: yes
  vars:
    s3_bucket: "oml-s3-automation-sandbox"
    s3_path: "cis-baseline-files"
    aws_region: "eu-west-1"
    report_file: "{{ playbook_dir }}/Security_Options_Report_{{ inventory_hostname }}.html"
    remote_map_file: "C:\\temp\\security_options_map.json"
    
    security_options_map:
      # --- THE 4 SPECIFIC FIXED SETTINGS ---
      "MACHINE\\System\\CurrentControlSet\\Control\\Lsa\\LimitBlankPasswordUse": "Accounts: Limit local account use of blank passwords to console logon only"
      "NewAdministratorName": "Accounts: Rename administrator account"
      "FullPrivilegeAuditing": "Audit: Audit the use of Backup and Restore privilege"
      "MACHINE\\System\\CurrentControlSet\\Control\\Print\\Providers\\LanMan Print Services\\Servers\\AddPrinterDrivers": "Devices: Prevent users from installing printer drivers"
      
      # --- ADDITIONAL SETTINGS MATCHED TO YOUR EXPORT ---
      "EnableAdminAccount": "Accounts: Administrator account status"
      "EnableGuestAccount": "Accounts: Guest account status"
      "MACHINE\\System\\CurrentControlSet\\Control\\Lsa\\AuditBaseObjects": "Audit: Audit the access of global system objects"
      "MACHINE\\System\\CurrentControlSet\\Control\\Lsa\\CrashOnAuditFail": "Audit: Shut down system immediately if unable to log audits"
      "MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\UndockWithoutLogon": "Devices: Allow undock without having to log on"
      "MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\DisableCAD": "Interactive logon: Do not require CTRL+ALT+DEL"
      "MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\EnableLUA": "UAC: Run admins in Admin Approval Mode"

  tasks:
    - name: Ensure Temp Directory Exists
      win_file:
        path: C:\temp
        state: directory

    - name: Transfer Policy Map
      ansible.windows.win_copy:
        content: "{{ security_options_map | to_nice_json }}"
        dest: "{{ remote_map_file }}"

    - name: Run Precision Audit
      win_shell: |
        $map = Get-Content "{{ remote_map_file }}" | ConvertFrom-Json
        $secFile = "C:\temp\secedit_audit.inf"
        secedit /export /areas SECURITYPOLICY /cfg $secFile | Out-Null
        
        $secHash = @{}
        if (Test-Path $secFile) {
            $content = Get-Content $secFile -Encoding Unicode
            foreach ($line in $content) {
                if ($line -match '=') {
                    $p = $line.Split('=', 2)
                    $k = $p[0].Trim()
                    $v = $p[1].Trim().Trim('"')
                    $secHash[$k] = $v
                }
            }
        }

        $results = foreach ($id in $map.psobject.Properties.Name) {
            $val = "Not Defined"; $pName = $map.$id
            
            # Match against the Security Export first
            if ($secHash.ContainsKey($id)) { 
                $val = $secHash[$id] 
            }
            # Fallback to Registry if not in Security Export
            elseif ($id -like "MACHINE\*") {
                $regPath = $id.Replace("MACHINE\", "HKLM:\")
                $key = Split-Path $regPath; $name = Split-Path $regPath -Leaf
                if (Test-Path $key) {
                    $rv = Get-ItemProperty -Path $key -Name $name -ErrorAction SilentlyContinue
                    if ($rv -and $rv.$name -ne $null) { $val = $rv.$name.ToString() }
                }
            }

            # Standardize Values
            if ($val -match "4,1" -or $val -eq "1") { $val = "Enabled" }
            elseif ($val -match "4,0" -or $val -eq "0" -or $val -match "3,0") { $val = "Disabled" }
            elseif ($val -match "1,") { $val = $val.Split(',')[1].Trim('"') }

            [PSCustomObject]@{ Name = $pName; Value = $val }
        }
        $results | Sort-Object Name | ForEach-Object { "$($_.Name)|$($_.Value)" }
      register: scan_output

    - name: Generate HTML Report
      delegate_to: localhost
      template:
        src: "../templates/baseline-local Policy-Security Options_report.j2"
        dest: "{{ report_file }}"

    - name: Push to S3
      delegate_to: localhost
      amazon.aws.s3_object:
        bucket: "{{ s3_bucket }}"
        object: "{{ s3_path }}/Security_Options_{{ inventory_hostname }}.html"
        src: "{{ report_file }}"
        mode: put
        region: "{{ aws_region }}"
